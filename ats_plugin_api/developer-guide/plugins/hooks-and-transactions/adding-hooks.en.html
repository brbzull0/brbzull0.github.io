


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Adding Hooks &mdash; Apache Traffic Server 10.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/override.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="HTTP Sessions" href="http-sessions.en.html" />
    <link rel="prev" title="Hooks and Transactions" href="index.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Apache Traffic Server
          

          
            
            <img src="../../../_static/trans_logo_tm_380x69.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                10.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.en.html">Plugin Development</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../introduction.en.html">Plugin Development Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="../building-plugins.en.html">Building Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../configuration.en.html">Plugin Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../plugin-management/index.en.html">Plugin Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../actions/index.en.html">Actions</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.en.html">Hooks and Transactions</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Adding Hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="http-sessions.en.html">HTTP Sessions</a></li>
<li class="toctree-l4"><a class="reference internal" href="http-transactions.en.html">HTTP Transactions</a></li>
<li class="toctree-l4"><a class="reference internal" href="intercepting-http-transactions.en.html">Intercepting HTTP Transactions</a></li>
<li class="toctree-l4"><a class="reference internal" href="initiate-http-connection.en.html">Initiate HTTP Connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="http-alternate-selection.en.html">HTTP Alternate Selection</a></li>
<li class="toctree-l4"><a class="reference internal" href="ssl-hooks.en.html">TLS User Agent Hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="ssl-session-api.en.html">TLS Session Plugin API</a></li>
<li class="toctree-l4"><a class="reference internal" href="ssl-session-api.en.html#utility-functions">Utility Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="ssl-session-api.en.html#example-use-case">Example Use Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.en.html#hooks">Hooks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../continuations/index.en.html">Continuations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mutexes.en.html">Mutexes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../io/index.en.html">IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http-headers/index.en.html">HTTP Headers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http-transformations/index.en.html">HTTP Transformations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../remap-plugins.en.html">Remap Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../new-protocol-plugins.en.html">New Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../plugin-interfaces.en.html">Plugin Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../adding-statistics.en.html">Adding Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../example-plugins/index.en.html">Example Plugins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendices/index.en.html">Appendices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Apache Traffic Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.en.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="../index.en.html">Plugin Development</a> &raquo;</li>
        
          <li><a href="index.en.html">Hooks and Transactions</a> &raquo;</li>
        
      <li>Adding Hooks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/developer-guide/plugins/hooks-and-transactions/adding-hooks.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="adding-hooks">
<span id="developer-plugins-hooks-adding"></span><h1>Adding Hooks<a class="headerlink" href="#adding-hooks" title="Permalink to this headline">¶</a></h1>
<p>There are several ways to add hooks to your plugin.</p>
<ul class="simple">
<li><p><strong>Global HTTP hooks</strong> HTTP transaction hooks are set on a global
basis using the function <code class="docutils literal notranslate"><span class="pre">TSHttpHookAdd</span></code>. This means that the
continuation specified as the parameter to <code class="docutils literal notranslate"><span class="pre">TSHttpHookAdd</span></code> is
called for every transaction. <code class="docutils literal notranslate"><span class="pre">TSHttpHookAdd</span></code> must be used in
<code class="docutils literal notranslate"><span class="pre">TSPluginInit</span></code>.</p></li>
<li><p><strong>Transaction hooks</strong> Transaction hooks can be used to call plugins
back for a specific HTTP transaction. You cannot add transaction
hooks in <code class="docutils literal notranslate"><span class="pre">TSPluginInit</span></code>; you first need a handle to a transaction.
See <a class="reference internal" href="../example-plugins/denylist/accessing-the-transaction-being-processed.en.html#developer-plugins-denylist-access-process-txn"><span class="std std-ref">Accessing the Transaction Being Processed</span></a>.</p></li>
<li><p><strong>Transformation hooks</strong> Transformation hooks are a special case of
transaction hooks. See
<a class="reference internal" href="../../api/functions/TSVConnCacheObjectSizeGet.en.html#c.TSVConnCacheObjectSizeGet" title="TSVConnCacheObjectSizeGet"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSVConnCacheObjectSizeGet()</span></code></a>
for more information about transformation hooks. You add a
transformation hook using <code class="docutils literal notranslate"><span class="pre">TSHttpTxnHookAdd</span></code>, as described in
<a class="reference internal" href="http-transactions.en.html#developer-plugins-hooks-http-transactions"><span class="std std-ref">HTTP Transactions</span></a>.</p></li>
<li><p><strong>Session hooks</strong> An HTTP session starts when a client opens a
connection to Traffic Server and ends when the connection closes. A
session can consist of several transactions. Session hooks enable you
to hook your plugin to a particular point in every transaction within
a specified session (see <a class="reference internal" href="http-sessions.en.html"><span class="doc">HTTP Sessions</span></a>).
Session hooks are added in a manner similar to transaction hooks (ie,
you first need a handle to an HTTP session).</p></li>
<li><p><strong>HTTP select alternate hook</strong> Alternate selection hooks enable you
to hook on to the alternate selection state. These hooks must be
added globally, since Traffic Server does not have a handle to a
transaction or session when alternate selection is taking place. See
<a class="reference internal" href="http-alternate-selection.en.html"><span class="doc">HTTP Alternate Selection</span></a> for
information on the alternate selection mechanism.</p></li>
</ul>
<p>All of the hook addition functions
(<a class="reference internal" href="../../api/functions/TSHttpHookAdd.en.html#c.TSHttpHookAdd" title="TSHttpHookAdd"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSHttpHookAdd()</span></code></a>,
<a class="reference internal" href="../../api/functions/TSHttpHookAdd.en.html#c.TSHttpSsnHookAdd" title="TSHttpSsnHookAdd"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSHttpSsnHookAdd()</span></code></a>,
<a class="reference internal" href="../../api/functions/TSHttpSsnReenable.en.html#c.TSHttpSsnReenable" title="TSHttpSsnReenable"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSHttpSsnReenable()</span></code></a>)
take <code class="docutils literal notranslate"><span class="pre">TSHttpHookID</span></code> (identifies the hook to add on to) and <code class="docutils literal notranslate"><span class="pre">TSCont</span></code>
(the basic callback mechanism in Traffic Server). A single <code class="docutils literal notranslate"><span class="pre">TSCont</span></code>
can be added to any number of hooks at a time.</p>
<p>An HTTP hook is identified by the enumerated type <code class="docutils literal notranslate"><span class="pre">TSHttpHookID</span></code>. The
values for <code class="docutils literal notranslate"><span class="pre">TSHttpHookID</span></code> are:</p>
<p><strong>Values for TSHttpHookID</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_CACHE_LOOKUP_COMPLETE_HOOK</span></code></dt><dd><p>Called after the HTTP state machine has completed the cache lookup
for the document requested in the ongoing transaction. Register this
hook via <code class="docutils literal notranslate"><span class="pre">TSHttpTxnHookAdd</span></code> or <code class="docutils literal notranslate"><span class="pre">TSHttpHookAdd</span></code>. Corresponds to
the event <code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_CACHE_LOOKUP_COMPLETE</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_OS_DNS_HOOK</span></code></dt><dd><p>Called immediately after the HTTP state machine has completed a DNS
lookup of the origin server. The HTTP state machine will know the
origin server’s IP address at this point, which is useful for
performing both authentication and denylisting. Corresponds to the
event <code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_OS_DNS</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_POST_REMAP_HOOK</span></code></dt><dd><p>Called immediately after remapping occurs, before cache lookup.
Corresponds to the event <code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_POST_REMAP</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_PRE_REMAP_HOOK</span></code></dt><dd><p>Called after the request header is read from the client, before any
remapping of the headers occurs. Corresponds to the event
<code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_PRE_REMAP</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_READ_CACHE_HDR_HOOK</span></code></dt><dd><p>Called immediately after the request and response header of a
previously-cached object is read from cache. This hook is only
called if the document is being served from cache. Corresponds to
the event <code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_READ_CACHE_HDR</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_READ_RESPONSE_HDR_HOOK</span></code></dt><dd><p>Called immediately after the response header is read from the origin
server or parent proxy. Corresponds to the event
<code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_READ_RESPONSE_HDR</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_RESPONSE_TRANSFORM_HOOK</span></code></dt><dd><p>See <a class="reference internal" href="../http-transformations/index.en.html#transformations"><span class="std std-ref">“Transformations”</span></a>
for information about transformation hooks.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_READ_REQUEST_HDR_HOOK</span></code></dt><dd><p>Called immediately after the request header is read from the client.
Corresponds to the event <code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_READ_REQUEST_HDR</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_REQUEST_TRANSFORM_HOOK</span></code></dt><dd><p>See <a class="reference internal" href="../http-transformations/index.en.html#transformations"><span class="std std-ref">“Transformations”</span></a>
for information about transformation hooks.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_SELECT_ALT_HOOK</span></code></dt><dd><p>See <a class="reference internal" href="http-alternate-selection.en.html"><span class="doc">“HTTP Alternate Selection”</span></a> for
information about the alternate selection mechanism.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_SEND_RESPONSE_HDR_HOOK</span></code></dt><dd><p>Called immediately before the proxy’s response header is written to
the client; this hook is usually used for modifying the response
header. Corresponds to the event
<code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_SEND_RESPONSE_HDR</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_SEND_REQUEST_HDR_HOOK</span></code></dt><dd><p>Called immediately before the proxy’s request header is sent to the
origin server or the parent proxy. This hook is not called if the
document is being served from cache. This hook is usually used for
modifying the proxy’s request header before it is sent to the origin
server or parent proxy.</p>
</dd>
</dl>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>TS_HTTP_SEND_REQUEST_HDR_HOOK may callback several times when the
OS crashed. Be careful to use functions such as TSContDestroy in
TS_HTTP_SEND_REQUEST_HDR_HOOK hook.</p>
</div>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_SSN_CLOSE_HOOK</span></code></dt><dd><p>Called when an HTTP session ends. A session ends when the client
connection is closed. You can only add this hook as a global hook</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_SSN_START_HOOK</span></code></dt><dd><p>Called when an HTTP session is started. A session starts when a
client connects to Traffic Server. You can only add this hook as a
global hook.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_TXN_CLOSE_HOOK</span></code></dt><dd><p>Called when an HTTP transaction ends.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">TS_HTTP_TXN_START_HOOK</span></code></dt><dd><p>Called when an HTTP transaction is started. A transaction starts
when either a client connects to Traffic Server and data is
available on the connection, or a previous client connection that
was left open for keep alive has new data available.</p>
</dd>
</dl>
<p>The function you use to add a global HTTP hook is
<a class="reference internal" href="../../api/functions/TSHttpHookAdd.en.html#c.TSHttpHookAdd" title="TSHttpHookAdd"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSHttpHookAdd()</span></code></a>.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="http-sessions.en.html" class="btn btn-neutral float-right" title="HTTP Sessions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.en.html" class="btn btn-neutral float-left" title="Hooks and Transactions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, dev@trafficserver.apache.org

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>
 


</body>
</html>