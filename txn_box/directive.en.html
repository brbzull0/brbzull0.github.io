

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Directives &mdash; Transaction Box</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Selection" href="selection.en.html" />
    <link rel="prev" title="Feature Expressions" href="expr.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Transaction Box Plugin
          

          
            
            <img src="_static/balcora-gate-400x400.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="txn_box.en.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="txn_box.en.html#configuration">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.en.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.en.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="expr.en.html">Feature Expressions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Directives</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#note">note</a></li>
<li class="toctree-l3"><a class="reference internal" href="#redirect">redirect</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="selection.en.html">Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="guide.en.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.en.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="arch.en.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ExtractorReference.en.html">Extractor Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ExtractorReference.en.html#extractors">Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/DirectiveReference.en.html">Directive Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ComparisonReference.en.html">Comparison Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ModifierReference.en.html">Modifier Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="future.en.html">Future Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.en.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev/dev-guide.en.html">Developer Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="reference.en.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Transaction Box Plugin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Directives</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/directive.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="directives">
<span id="directive"></span><h1>Directives<a class="headerlink" href="#directives" title="Permalink to this headline">¶</a></h1>
<p>Directives are implemented by subclassing <span>Directive</span>. The general convention is to prefix the
directive name with “Do_” to form a class name.</p>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<div class="section" id="note">
<h3>note<a class="headerlink" href="#note" title="Permalink to this headline">¶</a></h3>
<p>Consider a directive to log a “NOTE” in “diag.logs”. Fundamentally this can be done by calling
the Traffic Server utility method <span>ts::Log_Note</span> and passing a string view. The directive is simply a
wrapper around this, to extact the view and then log it.</p>
<p>By convention the class is named <code class="docutils literal notranslate"><span class="pre">Do_note</span></code> and the declaration is</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Do_note</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Directive</span>
<span class="p">{</span>
  <span class="k">using</span> <span class="n">self_type</span>  <span class="o">=</span> <span class="n">Do_note</span><span class="p">;</span>   <span class="c1">///&lt; Self reference type.</span>
  <span class="k">using</span> <span class="n">super_type</span> <span class="o">=</span> <span class="n">Directive</span><span class="p">;</span> <span class="c1">///&lt; Super type.</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">KEY</span><span class="p">{</span><span class="s">&quot;note&quot;</span><span class="p">};</span> <span class="c1">///&lt; Name of directive.</span>
  <span class="c1">/// Valid hooks for this directive.</span>
  <span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="n">HookMask</span> <span class="n">HOOKS</span><span class="p">{</span><span class="n">MaskFor</span><span class="p">(</span><span class="n">Hook</span><span class="o">::</span><span class="n">POST_LOAD</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">TXN_START</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">CREQ</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">PREQ</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">URSP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">PRSP</span><span class="p">,</span>
                                             <span class="n">Hook</span><span class="o">::</span><span class="n">PRE_REMAP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">POST_REMAP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">REMAP</span><span class="p">)};</span>

  <span class="c1">/// Runtime invocation.</span>
  <span class="n">Errata</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">Context</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

  <span class="c1">/// Load from configuration.</span>
  <span class="k">static</span> <span class="n">Rv</span><span class="o">&lt;</span><span class="n">Handle</span><span class="o">&gt;</span> <span class="n">load</span><span class="p">(</span><span class="n">Config</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">CfgStaticData</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">drtv_node</span><span class="p">,</span> <span class="n">swoc</span><span class="o">::</span><span class="n">TextView</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">swoc</span><span class="o">::</span><span class="n">TextView</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">key_value</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="n">Expr</span> <span class="n">_msg</span><span class="p">;</span> <span class="c1">///&lt; Message to log.</span>

  <span class="cm">/** Constructor.</span>
<span class="cm">   *</span>
<span class="cm">   * @param msg Parsed feature expression for message.</span>
<span class="cm">   */</span>
  <span class="n">Do_note</span><span class="p">(</span><span class="n">Expr</span> <span class="o">&amp;&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Each directive has a key that is the name of the directive, it is best to declare this as a
<code class="code docutils literal notranslate"><span class="pre">std::string</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>  <span class="k">using</span> <span class="n">super_type</span> <span class="o">=</span> <span class="n">Directive</span><span class="p">;</span> <span class="c1">///&lt; Super type.</span>
<span class="hll"><span class="k">public</span><span class="o">:</span>
</span>  <span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">KEY</span><span class="p">{</span><span class="s">&quot;note&quot;</span><span class="p">};</span> <span class="c1">///&lt; Name of directive.</span>
  <span class="c1">/// Valid hooks for this directive.</span>
  <span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="n">HookMask</span> <span class="n">HOOKS</span><span class="p">{</span><span class="n">MaskFor</span><span class="p">(</span><span class="n">Hook</span><span class="o">::</span><span class="n">POST_LOAD</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">TXN_START</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">CREQ</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">PREQ</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">URSP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">PRSP</span><span class="p">,</span>
                                             <span class="n">Hook</span><span class="o">::</span><span class="n">PRE_REMAP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">POST_REMAP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">REMAP</span><span class="p">)};</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">inline</span></code> enables the member to be initialized in the class declaration. In this case the
directive is usable on any hook and so all of them are listed. The class <span>HookMask</span> is used to
hold a bit mask of the valid hooks. The utility function <span>MaskFor</span> can be used to create a bit
mask from hook enumeration values.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>  <span class="k">using</span> <span class="n">super_type</span> <span class="o">=</span> <span class="n">Directive</span><span class="p">;</span> <span class="c1">///&lt; Super type.</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">KEY</span><span class="p">{</span><span class="s">&quot;note&quot;</span><span class="p">};</span> <span class="c1">///&lt; Name of directive.</span>
<span class="hll">  <span class="c1">/// Valid hooks for this directive.</span>
</span><span class="hll">  <span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="n">HookMask</span> <span class="n">HOOKS</span><span class="p">{</span><span class="n">MaskFor</span><span class="p">(</span><span class="n">Hook</span><span class="o">::</span><span class="n">POST_LOAD</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">TXN_START</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">CREQ</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">PREQ</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">URSP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">PRSP</span><span class="p">,</span>
</span><span class="hll">                                             <span class="n">Hook</span><span class="o">::</span><span class="n">PRE_REMAP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">POST_REMAP</span><span class="p">,</span> <span class="n">Hook</span><span class="o">::</span><span class="n">REMAP</span><span class="p">)};</span>
</span></pre></div>
</div>
<p>The first requirement of the directive implementation is loading from the configuration to create an
instance of the directive class. The framework, when expecting a directive, checks if the node is an
object. If so, the keys in the object are checked for being a directive by matching the key name
with a table of directive names. If there is a match, the corresponding load functor is invoked.
Multiple arguments are passed to the functor.</p>
<dl class="simple">
<dt><code class="code docutils literal notranslate"><span class="pre">Config&amp;</span> <span class="pre">cfg</span></code></dt><dd><p>A reference to the configuration object, which contains the configuration loading context. See <span>Config</span>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">CfgStaticData</span></code></dt><dd><p>Every registered directive gets a config level block of information. This is a reference to that
for the configuration being loaded. See <span>CfgStaticData</span>.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">YAML::Node</span> <span class="pre">const&amp;</span> <span class="pre">drtv_node</span></code></dt><dd><p>The directive map (YAML node). This is the YAML map that contains the directive key.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">TextView</span> <span class="pre">const&amp;</span> <span class="pre">name</span></code></dt><dd><p>The name of the directive. This is the same as the value in the directive table. In most cases it
is irrelevant. In the cases of a group of similar directives, a single load functor could load
all of them, distinguishing the exact case with this value.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">TextView</span> <span class="pre">const&amp;</span> <span class="pre">arg</span></code></dt><dd><p>A directive key can have an argument, which is additional text attached to the directive name
with a period separator. Although implementationally arbitrary, the convention is the argument
(if any) should be used to select the target of the directive if the value can’t be known at
compile time. Data used to perform the directive should be in the value of the directive key.</p>
</dd>
<dt><code class="code docutils literal notranslate"><span class="pre">YAML::Node</span> <span class="pre">const&amp;</span> <span class="pre">key_value</span></code></dt><dd><p>The value of the directive key. Note this can be any type of YAML data, including nested objects.
This is not processed beyond being validated as valid YAML.</p>
</dd>
</dl>
<p>It is the responsibility of the load functor to do any further processing of the <em>key_value</em>
and construct an instance of the directive class using that information. If the functor is
implemented as a method it must be a static method as by definition there is no directive instance
yet.</p>
<p>Here is an example of using this directive.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">do</span><span class="p">:</span>
<span class="hll"><span class="p p-Indicator">-</span> <span class="nt">note</span><span class="p">:</span> <span class="s">&quot;Something&#39;s</span><span class="nv"> </span><span class="s">happen</span><span class="nv"> </span><span class="s">here&quot;</span>
</span></pre></div>
</div>
<p>The “do” key contains a list of directives, each of which is an object. The first such object is the
<code class="docutils literal notranslate"><span class="pre">note</span></code> object. It will be invoked with <em>drtv_node</em> being the object in the list for “do”, while
<em>name</em> will be “note” and <em>key_value</em> the string <code class="docutils literal notranslate"><span class="pre">&quot;Something's</span> <span class="pre">happening</span> <span class="pre">here&quot;</span></code>.</p>
<p>Loading implementation is straight forward. The value is expected to be a feature expression and all
that needs done is to store it in the instance for use at run time.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Rv</span><span class="o">&lt;</span><span class="n">Directive</span><span class="o">::</span><span class="n">Handle</span><span class="o">&gt;</span>
<span class="n">Do_note</span><span class="o">::</span><span class="n">load</span><span class="p">(</span><span class="n">Config</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">CfgStaticData</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">drtv_node</span><span class="p">,</span> <span class="n">swoc</span><span class="o">::</span><span class="n">TextView</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span> <span class="n">swoc</span><span class="o">::</span><span class="n">TextView</span> <span class="k">const</span> <span class="o">&amp;</span><span class="p">,</span>
              <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">key_value</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="p">[</span><span class="n">msg_fmt</span><span class="p">,</span> <span class="n">msg_errata</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">parse_expr</span><span class="p">(</span><span class="n">key_value</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg_errata</span><span class="p">.</span><span class="n">is_ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">msg_errata</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">(</span><span class="s">While parsing message at {} for &quot;{}&quot; directive at {}.</span><span class="dl">)</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_value</span><span class="p">.</span><span class="n">Mark</span><span class="p">(),</span> <span class="n">KEY</span><span class="p">,</span> <span class="n">drtv_node</span><span class="p">.</span><span class="n">Mark</span><span class="p">());</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">msg_errata</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">Handle</span><span class="p">{</span><span class="k">new</span> <span class="n">self_type</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">msg_fmt</span><span class="p">)}};</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span>Config::parse_expr</span> is used to parse the value as a feature expression. If not successful, the
lower level error is augmented with context information about the directive and returned. Otherwise
the parsed expression is stored in a newly created instance which is then returned.</p>
<p>When used at runtime, the <code class="code docutils literal notranslate"><span class="pre">invoke</span></code> method is called.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Errata</span>
<span class="nf">Do_note::invoke</span><span class="p">(</span><span class="n">Context</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">TextView</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">extract_view</span><span class="p">(</span><span class="n">_msg</span><span class="p">);</span>
  <span class="n">ts</span><span class="o">::</span><span class="n">Log_Note</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{};</span>
<span class="p">}</span>
</pre></div>
</div>
<p><em>ctx</em> is a per transaction context and serves as the root of accessible data structures. In
this case the parsed feature expression is passed to <span>Context::extract_view</span> to extract the
expression as a string, which is the logged.</p>
</div>
<div class="section" id="redirect">
<h3>redirect<a class="headerlink" href="#redirect" title="Permalink to this headline">¶</a></h3>
<p>A more complex example would be the <code class="docutils literal notranslate"><span class="pre">redirect</span></code> directive.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">redirect</span><span class="p">:</span>
   <span class="nt">location</span><span class="p">:</span> <span class="s">&quot;http://example.one&quot;</span>
   <span class="nt">status</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">302</span>
   <span class="nt">body</span><span class="p">:</span> <span class="s">&quot;Redirecting</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">{this::location}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">please</span><span class="nv"> </span><span class="s">update</span><span class="nv"> </span><span class="s">your</span><span class="nv"> </span><span class="s">links.&quot;</span>
</pre></div>
</div>
<p>For loading from configuration, <code class="code docutils literal notranslate"><span class="pre">key-value</span></code> is an object, with keys <code class="docutils literal notranslate"><span class="pre">location</span></code>, <code class="docutils literal notranslate"><span class="pre">status</span></code>,
and <code class="docutils literal notranslate"><span class="pre">body</span></code>, which must be handled by the directive implementation. <span>FeatureGroup</span> is a
support class to support directives with multiple keys. It is not required but does provide much of
the boiler plate needed in this situation.</p>
<p>Some of the complexity stems from the fact that while the directive must be invoked on a relatively
early hook, the implementation must do some “fix ups” on a later hook and that information must be
cached between hooks. A structure is defined to hold this data</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>  <span class="k">struct</span> <span class="nc">CtxInfo</span> <span class="p">{</span>
    <span class="n">TextView</span> <span class="n">_location</span><span class="p">;</span> <span class="c1">///&lt; Redirect target location.</span>
    <span class="n">TextView</span> <span class="n">_reason</span><span class="p">;</span>   <span class="c1">///&lt; Status text.</span>
  <span class="p">};</span>
</pre></div>
</div>
<p>The significant problem is not storing this information, but finding it later. A pointer cannot be
stored in the instance, because there is only one per configuration instance which can be invoked in
multiple transactions simultaneously. The solution is to reserve the storage at the configuration
level which creates a fixed offset (per configuration) for storage in the per transaction context.
This is a (somewhat) expensive resource as such storage is reserved on every transaction even if not
used. The context storage reservation can vary between configuration instances (because the set of
directives reserving storage can vary) therefore configuration storage must be obtained to store
the reservation.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>  <span class="k">struct</span> <span class="nc">CfgInfo</span> <span class="p">{</span>
    <span class="n">ReservedSpan</span> <span class="n">_ctx_span</span><span class="p">;</span> <span class="c1">///&lt; Reserved span for @c CtxInfo.</span>
  <span class="p">};</span>
</pre></div>
</div>
<p>Note the context data is shared among all instances of this directive. This is acceptable
because for any specific transaction there can be only one redirection so it being overridden if
multiple instances are invoked for a transaction is useful.</p>
<p>Configuration loading tracks how many instances of a directive have been loaded. The first time a
directive is encountered, a functor is invoked. By default this is an empty function but it can
be replaced per directive. This is used by the “redirect” directive.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Do_redirect</span><span class="o">::</span><span class="n">cfg_init</span><span class="p">(</span><span class="n">Config</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">CfgStaticData</span> <span class="k">const</span> <span class="o">*</span><span class="n">rtti</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="n">cfg_info</span> <span class="o">=</span> <span class="n">rtti</span><span class="o">-&gt;</span><span class="n">_cfg_store</span><span class="p">.</span><span class="n">rebind</span><span class="o">&lt;</span><span class="n">CfgInfo</span><span class="o">&gt;</span><span class="p">().</span><span class="n">data</span><span class="p">();</span>
  <span class="k">new</span> <span class="p">(</span><span class="n">cfg_info</span><span class="p">)</span> <span class="n">CfgInfo</span><span class="p">;</span> <span class="c1">// Initialize the span.</span>
  <span class="c1">// Only one redirect can be effective per transaction, therefore shared state per context is best.</span>
  <span class="n">cfg_info</span><span class="o">-&gt;</span><span class="n">_ctx_span</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">reserve_ctx_storage</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CtxInfo</span><span class="p">));</span>
  <span class="n">cfg</span><span class="p">.</span><span class="n">reserve_slot</span><span class="p">(</span><span class="n">FIXUP_HOOK</span><span class="p">);</span> <span class="c1">// needed to fix up &quot;Location&quot; field in proxy response.</span>
  <span class="k">return</span> <span class="p">{};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is passed the configuration instance and the per directive static information. This is useful
for data that is per directive per configuration. For “redirect” this is for reserving per context
storage and reserving a hook slot to use for the fix ups.</p>
<p>When using a feature group, each key becomes associated with an index and those indices are used
to access key information. There is a presumption that the value for every key is a feature
expression, but additional type checking can be done after loading. The group can be loaded
as a single scalar, as a list, or as an object (set of keys). Keys can be marked as required in
which case it is an error if the key is not present. After loading, the key indices can be found
by name and cached for fast lookup during invocation.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="selection.en.html" class="btn btn-neutral float-right" title="Selection" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="expr.en.html" class="btn btn-neutral float-left" title="Feature Expressions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Verizon Media.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>