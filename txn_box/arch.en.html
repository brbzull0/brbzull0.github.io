

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Architecture &mdash; Transaction Box</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Extractor Reference" href="user/ExtractorReference.en.html" />
    <link rel="prev" title="Examples" href="examples.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Transaction Box Plugin
          

          
            
            <img src="_static/balcora-gate-400x400.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="txn_box.en.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="txn_box.en.html#configuration">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.en.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.en.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="expr.en.html">Feature Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="directive.en.html">Directives</a></li>
<li class="toctree-l1"><a class="reference internal" href="selection.en.html">Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="guide.en.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.en.html">Examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#extending">Extending</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#extractor">Extractor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#comparison">Comparison</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="user/ExtractorReference.en.html">Extractor Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ExtractorReference.en.html#extractors">Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/DirectiveReference.en.html">Directive Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ComparisonReference.en.html">Comparison Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ModifierReference.en.html">Modifier Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="future.en.html">Future Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.en.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev/dev-guide.en.html">Developer Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="reference.en.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Transaction Box Plugin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Architecture</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/arch.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="architecture">
<span id="arch"></span><h1>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h1>
<div class="section" id="extending">
<h2>Extending<a class="headerlink" href="#extending" title="Permalink to this headline">¶</a></h2>
<p>TxnBox is intended to be easily extendible with regard to adding new directives, comparisons,
and extractors. For each such extension there are two major phases that must be supported,
loading and invoking.</p>
<p>Loading is parsing data in the configuration file. Invoking happens during transaction processing.</p>
<div class="section" id="extractor">
<h3>Extractor<a class="headerlink" href="#extractor" title="Permalink to this headline">¶</a></h3>
<p>An extractor gathers data and provides it to the plugin. While this is usually data in a transaction
that is not required. The gathered data is called a <a class="reference internal" href="reference.en.html#term-feature"><span class="xref std std-term">feature</span></a>. Every extractor must be able to
provide its feature in string format. It can also provide the feature in one of a few predefined
feature types -</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">INTEGER</span></code>, a signed integral value.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">BOOL</span></code>, a boolean value that is the equivalent of <code class="code docutils literal notranslate"><span class="pre">true</span></code> and <code class="code docutils literal notranslate"><span class="pre">false</span></code>.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">IP_ADDR</span></code>, an IP address.</p></li>
</ul>
<p>Other feature types may be supported in the future.</p>
<p>An extractor must inherit from <span>Extractor</span>.</p>
</div>
<div class="section" id="comparison">
<h3>Comparison<a class="headerlink" href="#comparison" title="Permalink to this headline">¶</a></h3>
<p>A comparison compares fixed data to a feature and potentially provides some side effects on a
successful match. At a minimum, the comparison class implementation must provide a function operator
overload which performs the run time comparison with the feature. This can will be one or more of
several overloads. The precise methods depend on which feature types are supported.</p>
<blockquote>
<div><ul class="simple">
<li><p>String - feature argument type is <code class="code docutils literal notranslate"><span class="pre">swoc::TextView</span></code>.</p></li>
<li><p>Boolean - feature argument type is <code class="code docutils literal notranslate"><span class="pre">bool</span></code>.</p></li>
<li><p>Number - feature argument type is <code class="code docutils literal notranslate"><span class="pre">intmax_t</span></code>.</p></li>
<li><p>IP Address - feature argument type is <code class="code docutils literal notranslate"><span class="pre">swoc::IPAddr</span></code>.</p></li>
</ul>
</div></blockquote>
<p>This is the only required elements, but there are several others which are very convienient and
should be added unless there is a reason to not do so.</p>
<ul class="simple">
<li><p>A <code class="code docutils literal notranslate"><span class="pre">static</span></code> <code class="code docutils literal notranslate"><span class="pre">const</span></code> <code class="code docutils literal notranslate"><span class="pre">std::string</span></code> which contains the name of the comparison.</p></li>
<li><p>A <code class="code docutils literal notranslate"><span class="pre">static</span></code> <code class="code docutils literal notranslate"><span class="pre">const</span></code> <span>FeatureMask</span> which contains the valid feature types for the comparison.</p></li>
<li><p>A <code class="code docutils literal notranslate"><span class="pre">static</span></code> <code class="code docutils literal notranslate"><span class="pre">load</span></code> method which constructs an instance from YAML configuration.</p></li>
<li><p>Storage for the comparison fixed data.</p></li>
</ul>
<p>The former could be hardwired wherever it is used, but having a single copy is better. The
<code class="code docutils literal notranslate"><span class="pre">load</span></code> method could be done with a free function or a lambda but again it is better to
consolidate this in the class itself.</p>
<p>To illustrate, consider the <code class="code docutils literal notranslate"><span class="pre">suffix</span></code> comparison. The bare minimum class definition is:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Cmp_Suffix</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Comparison</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
   <span class="kt">bool</span> <span class="k">operator</span><span class="p">()</span> <span class="p">(</span><span class="n">Context</span><span class="o">&amp;</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">TextView</span><span class="o">&amp;</span> <span class="n">text</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Because <code class="code docutils literal notranslate"><span class="pre">Cmp_Suffix</span></code> class is only valid for string features, it provides only the
<code class="code docutils literal notranslate"><span class="pre">TextView</span></code> overload. The more complete declaration would be:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Cmp_Suffix</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Comparison</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
   <span class="k">static</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">KEY</span><span class="p">;</span>
   <span class="k">static</span> <span class="k">const</span> <span class="n">FeatureMask</span> <span class="n">TYPES</span><span class="p">;</span>

   <span class="kt">bool</span> <span class="nf">operator</span><span class="p">()</span> <span class="p">(</span><span class="n">Context</span><span class="o">&amp;</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">TextView</span><span class="o">&amp;</span> <span class="n">text</span><span class="p">)</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>

   <span class="k">static</span> <span class="n">Rv</span><span class="o">&lt;</span><span class="n">Handle</span><span class="o">&gt;</span> <span class="n">load</span><span class="p">(</span><span class="n">Config</span><span class="o">&amp;</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">cmp_node</span><span class="p">,</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">key_node</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>
   <span class="n">Extractor</span><span class="o">::</span><span class="n">Expr</span> <span class="n">_value</span><span class="p">;</span> <span class="c1">///&lt; Suffix value to compare.</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">is_valid_for</span></code> method is defined to return <code class="code docutils literal notranslate"><span class="pre">true</span></code> only for the <code class="code docutils literal notranslate"><span class="pre">VIEW</span></code> feature
type, which is consistent with providing only the <code class="code docutils literal notranslate"><span class="pre">swoc::TextView</span></code> function operator
overload. That method calls <code class="code docutils literal notranslate"><span class="pre">TextView::ends_with</span></code> to do the check.</p>
<p>In order to be available to the configuration, the comparison must be passed, along with its name,
to the <span>Comparison::define</span> method. There are various initialization mechanism, the one used
inside TxnBox looks like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="p">{</span>
<span class="p">[[</span><span class="n">maybe_unused</span><span class="p">]]</span> <span class="kt">bool</span> <span class="n">INITIALIZED</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
   <span class="n">Comparison</span><span class="o">::</span><span class="n">define</span><span class="p">(</span><span class="n">Cmp_Suffix</span><span class="o">::</span><span class="n">KEY</span><span class="p">,</span> <span class="n">Cmp_Suffix</span><span class="o">::</span><span class="n">TYPES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Cmp_Suffix</span><span class="o">::</span><span class="n">load</span><span class="p">);</span>

   <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span> <span class="p">();</span>
</pre></div>
</div>
<p>More detail is available at <span>Cmp_Suffix</span>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="user/ExtractorReference.en.html" class="btn btn-neutral float-right" title="Extractor Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="examples.en.html" class="btn btn-neutral float-left" title="Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Verizon Media.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>