

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Miscellaneous &mdash; Transaction Box</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Developer Guide" href="dev/dev-guide.en.html" />
    <link rel="prev" title="Future Work" href="future.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Transaction Box Plugin
          

          
            
            <img src="_static/balcora-gate-400x400.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="txn_box.en.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="txn_box.en.html#configuration">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.en.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.en.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="expr.en.html">Feature Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="directive.en.html">Directives</a></li>
<li class="toctree-l1"><a class="reference internal" href="selection.en.html">Selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="guide.en.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.en.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="arch.en.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ExtractorReference.en.html">Extractor Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ExtractorReference.en.html#extractors">Extractors</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/DirectiveReference.en.html">Directive Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ComparisonReference.en.html">Comparison Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="user/ModifierReference.en.html">Modifier Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="future.en.html">Future Work</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Miscellaneous</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#issues">Issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#working-with-http-fields">Working with HTTP Fields</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#access-control">Access Control</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reverse-mapping">Reverse Mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#referer-remapping">Referer Remapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#recv-port">RECV_PORT</a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-b-testing">A/B Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#real-life">Real Life</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#legacy-appliances">Legacy Appliances</a></li>
<li class="toctree-l4"><a class="reference internal" href="#query-only">Query Only</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cache-ttl">Cache TTL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mutual-tls">Mutual TLS</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dev/dev-guide.en.html">Developer Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="reference.en.html">Glossary</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Transaction Box Plugin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Miscellaneous</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/misc.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="miscellaneous">
<h1>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h1>
<p>This is text that should be in the document but doesn’t have a good place at the moment.</p>
<div class="section" id="issues">
<h2>Issues<a class="headerlink" href="#issues" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>What happens to the remap requirement? What counts as a remap match? Currently adding a
comparison “always” which always matches, so that can count as a match.</p></li>
<li><p>How optional should <code class="docutils literal notranslate"><span class="pre">do</span></code> nodes be? For instance, for selection cases is it OK to omit the
node entirely if there’s nothing to actually do, it’s just a match for some other reason (e.g.
to prevent requests that match from matching subsequent cases)?</p>
<p>Thinking about this more, it should be possible to omit the comparison or the <code class="docutils literal notranslate"><span class="pre">do</span></code>.</p>
<ul class="simple">
<li><p>If the comparison is omitted, it always matches.</p></li>
<li><p>If the <code class="docutils literal notranslate"><span class="pre">do</span></code> is omitted, then nothing is done.</p></li>
</ul>
</li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ua-req-host</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">suffix</span><span class="p">:</span> <span class="s">&quot;.org&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
      <span class="nt">select</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;apache&quot;</span>
         <span class="nt">do</span><span class="p">:</span> <span class="c1"># stuff for the exact domain &quot;apache.org&quot;</span>
      <span class="p p-Indicator">-</span>  <span class="nt">suffix</span><span class="p">:</span> <span class="s">&quot;.apache&quot;</span>
         <span class="nt">do</span><span class="p">:</span>
         <span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
            <span class="nt">select</span><span class="p">:</span>
            <span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;mail&quot;</span>
               <span class="nt">do</span><span class="p">:</span> <span class="c1"># handle mail.apache.org</span>
            <span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;id&quot;</span>
               <span class="nt">do</span><span class="p">:</span> <span class="c1"># handle id.apache.org</span>
            <span class="c1"># more comparisons</span>
</pre></div>
</div>
<div class="section" id="working-with-http-fields">
<h3>Working with HTTP Fields<a class="headerlink" href="#working-with-http-fields" title="Permalink to this headline">¶</a></h3>
<p>Due to history and bad practices, working with the fields in an HTTP message can be challenging.
Unfortunately this makes the configuration for these more intricate.</p>
<p>The general case, where there is a single field with a single value it straight forward. A field
extractor (such as <a class="reference internal" href="user/ExtractorReference.en.html#proxy-req-field" title="proxy-req-field"><code class="xref txb txb-ex docutils literal notranslate"><span class="pre">proxy-req-field</span></code></a>) can be used to get the value, and a field directive
(such as <a class="reference internal" href="user/DirectiveReference.en.html#proxy-req-field" title="proxy-req-field"><code class="xref txb txb-drtv docutils literal notranslate"><span class="pre">proxy-req-field</span></code></a>) to change it.</p>
<p>Some fields are defined to be <a class="reference external" href="https://tools.ietf.org/html/rfc7230#section-3.2.6">multi-valued</a>
in which case the field value is really a list. On the other hand, there are exceptions to this
as well, most notably <a class="reference external" href="https://tools.ietf.org/html/rfc6265#section-4.1">Set-Cookie</a> which,
while multi-valued, does not follow the standard mechanism.</p>
<p>To handle all of these cases, the extension field of the field extractors can be used to force
the field to be handled either by value or by field. In both cases the result is a tuple to which
the standard <a class="reference internal" href="user/DirectiveReference.en.html#with" title="with"><code class="xref txb txb-drtv docutils literal notranslate"><span class="pre">with</span></code></a> tuple handling can be used.</p>
<p>In addition, if the field is handled by field, there is special support in the corresponding field
directive to modifying that specific field in the message.</p>
<p>For illustrative purposes, the examples will use the upstream response (“ursp”) extractors and
directives, but all of this applies to the client request (“creq”), proxy request (“preq”), and
proxy response (“prsp”) extractors and directives in exactly the same way.</p>
<p>In the case of single valued field such as “Server” fields, the value is extracted using
<code class="docutils literal notranslate"><span class="pre">ursp-field&lt;Server&gt;`</span> <span class="pre">and</span> <span class="pre">can</span> <span class="pre">be</span> <span class="pre">changed</span> <span class="pre">with</span> <span class="pre">the</span> <span class="pre">directive</span> <span class="pre">``ursp-field&lt;Server&gt;</span></code>. Here is an
example that looks at the “Transfer-Encoding” field to check for chunked encoding</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">upstream-field&lt;Transfer-Encoding&gt;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match&lt;nc&gt;</span><span class="p">:</span> <span class="s">&quot;chunked&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
      <span class="c1"># ... whatever</span>
</pre></div>
</div>
<p>Another example is setting the “Server” field to “TxnBox-Enhanced-Server” if it is not already set</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">upstream-field&lt;Server&gt;</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="nv">upstream-field&lt;Server&gt;</span> <span class="p p-Indicator">,</span> <span class="p p-Indicator">{</span><span class="nt"> else</span><span class="p">:</span> <span class="s">&quot;TxnBox-Enhanced-Server&quot;</span> <span class="p p-Indicator">}</span> <span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>Finally, for fields like “Set-Cookie”, handling must be done by the actual fields in the message
header. Here is an example that walks the “Set-Cookie” fields and if the domain is set to
“example.one”, that specific field is removed.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">upstream-rsp-field&lt;Set-Cookie&gt;</span>
<span class="nt">for-each</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
   <span class="nt">select</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">contains&lt;nc&gt;</span><span class="p">:</span> <span class="s">&quot;Domain=example.one;&quot;</span>
      <span class="nt">do</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">upstream-field&lt;...&gt;</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NULL</span>
</pre></div>
</div>
<p>The notation “…” is a reference to the active feature, just as it as an extractor. Not all
directives support this - if one does, this is noted in the deescription along with the associated
extractor(s) that extract a corresponding active feature. In particular, a field directive of
this form can only be used with an active feature by the corresponding extractor. In this case,
<code class="docutils literal notranslate"><span class="pre">ua-req-field&lt;...&gt;</span></code> would be invalid, only <code class="docutils literal notranslate"><span class="pre">upstream-rsp-field&lt;...&gt;</span></code> will work because the active feature
was extracted by the <code class="docutils literal notranslate"><span class="pre">upstream-rsp-field</span></code> extractor.</p>
<p>It’s interesting to compare this to an alternative that looks similar but isn’t quite the same</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">upstream-rsp-field&lt;Set-Cookie&gt;::by-field</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">for-all</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">contains&lt;nc&gt;</span><span class="p">:</span> <span class="s">&quot;Domain=example.one;&quot;</span>
      <span class="nt">do</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">upstream-rsp-field&lt;...&gt;</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NULL</span>
</pre></div>
</div>
<p>The difference is <code class="docutils literal notranslate"><span class="pre">for-all</span></code> is a comparison and will stop at the first element that doesn’t match.
<code class="docutils literal notranslate"><span class="pre">for-each</span></code> will always do all elements. Similar differences exist if <code class="docutils literal notranslate"><span class="pre">for-any</span></code> or <code class="docutils literal notranslate"><span class="pre">for-none</span></code>
are used. A way around this difference would be</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ursp-field&lt;Set-Cookie&gt;::by-field</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">for-all</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">contains&lt;nc&gt;</span><span class="p">:</span> <span class="s">&quot;Domain=example.one;&quot;</span>
      <span class="nt">do</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">ursp-field&lt;...&gt;</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NULL</span>
   <span class="p p-Indicator">-</span> <span class="p p-Indicator">{}</span> <span class="c1"># always match</span>
</pre></div>
</div>
<p>While this will work by causing every element to match, it’s a bit obscure and easy to get wrong. If
every element in a tuple needs to be processed, use <code class="docutils literal notranslate"><span class="pre">for-each</span></code>.</p>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>For request URLs of the form “A.apache.org/path”, change to “apache.org/A/path”. This example has
the full configuration to demonstrate that. Later examples have just the relevant configuration and
assume this outer wrapper is present.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">txn_box</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">when</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">creq</span>
  <span class="nt">do</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ua-req-host</span>
    <span class="nt">select</span><span class="p">:</span>
    <span class="p p-Indicator">-</span>  <span class="nt">suffix</span><span class="p">:</span> <span class="s">&quot;.apache.org&quot;</span>
       <span class="nt">do</span><span class="p">:</span>
       <span class="p p-Indicator">-</span>  <span class="nt">rewrite-url</span><span class="p">:</span> <span class="s">&quot;{ua-req-scheme}://apache.org/{...}{ua-req-path}&quot;</span>
    <span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;apache.org&quot;</span>
       <span class="c1"># Explicitly do nothing with the base host name to count as &quot;matched&quot;.</span>
</pre></div>
</div>
<div class="section" id="access-control">
<h3>Access Control<a class="headerlink" href="#access-control" title="Permalink to this headline">¶</a></h3>
<p>Access to upstream resources can be controlled on a fine grained level by doing a selection and
using the <code class="code docutils literal notranslate"><span class="pre">deny</span></code> directive. For instance, if access to <code class="docutils literal notranslate"><span class="pre">id.example.one</span></code> should be restricted
to the <code class="docutils literal notranslate"><span class="pre">GET</span></code>, <code class="docutils literal notranslate"><span class="pre">POST</span></code>, and <code class="docutils literal notranslate"><span class="pre">HEAD</span></code> methods, this could be done wth</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ua-req-url</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;id.example.one&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ua-req-method</span>
      <span class="nt">select</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">none-of</span><span class="p">:</span>
            <span class="nt">match</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;GET&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;POST&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;HEAD&quot;</span> <span class="p p-Indicator">]</span>
         <span class="nt">do</span><span class="p">:</span>
            <span class="nt">deny</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">proxy-req-field@Access</span><span class="p">:</span> <span class="s">&quot;Allowed&quot;</span> <span class="c1"># mark OK and let the request go through.</span>
</pre></div>
</div>
<p>If the method is not one of the allowed ones, the <code class="code docutils literal notranslate"><span class="pre">select</span></code> matches resulting in a denial.
Otherwise, because there is no match, further directives in the outside <code class="code docutils literal notranslate"><span class="pre">select</span></code> continue
to be performed and the transaction proceeds.</p>
<p>This could be done in another way</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{creq.url}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;id.example.one&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{ua-req-method}&quot;</span>
      <span class="nt">select</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;GET&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;POST&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;HEAD&quot;</span> <span class="p p-Indicator">]</span>
         <span class="nt">do</span><span class="p">:</span>
            <span class="nt">set-field</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;Access&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;Allowed&quot;</span> <span class="p p-Indicator">]</span> <span class="c1"># mark OK and let the request go through.</span>
   <span class="p p-Indicator">-</span>  <span class="nt">deny</span><span class="p">:</span>
</pre></div>
</div>
<p>The overall flow is the same - if the method doesn’t match an allowed, the <code class="code docutils literal notranslate"><span class="pre">with</span></code> is passed
over and the <code class="code docutils literal notranslate"><span class="pre">deny</span></code> is performed. Which of these is better depends on how much additional
processing is to be done.</p>
<p>In either case, the <code class="code docutils literal notranslate"><span class="pre">set-field</span></code> directive isn’t required, it is present for illustrative
purposes. This form of the innter <code class="code docutils literal notranslate"><span class="pre">select</span></code> works as well.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{creq.method}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">not</span><span class="p">:</span>
      <span class="nt">match</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;GET&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;POST&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;HEAD&quot;</span> <span class="p p-Indicator">]</span>
   <span class="nt">do</span><span class="p">:</span>
      <span class="nt">deny</span><span class="p">:</span>
</pre></div>
</div>
<p>More complex situations can be handled. Suppose all methods were to be allowed from the loopback
address. That could be done (considering just the access control <code class="code docutils literal notranslate"><span class="pre">select</span></code>) with</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{inbound.remove_addr}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">in</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;127.0.0.0/8&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;::1&quot;</span> <span class="p p-Indicator">]</span>
   <span class="nt">do</span><span class="p">:</span> <span class="c1"># nothing</span>
<span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{creq.method}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">not</span><span class="p">:</span>
      <span class="nt">match</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;GET&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;POST&quot;</span> <span class="p p-Indicator">]</span>
   <span class="nt">do</span><span class="p">:</span>
      <span class="nt">deny</span><span class="p">:</span>
</pre></div>
</div>
</div>
<div class="section" id="reverse-mapping">
<h3>Reverse Mapping<a class="headerlink" href="#reverse-mapping" title="Permalink to this headline">¶</a></h3>
<p>If the URL “example.one” is rewritten to “some.place”, then it useful to rewrite the <code class="docutils literal notranslate"><span class="pre">Location</span></code>
header from “some.place” to “example.one”. This could be done as</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{ua-req-host}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;example.one&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">rewrite-url-host</span><span class="p">:</span> <span class="s">&quot;some.place&quot;</span>
   <span class="p p-Indicator">-</span>  <span class="nt">when</span><span class="p">:</span> <span class="s">&quot;send-response&quot;</span>
      <span class="nt">do</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{prsp.field::Location}&quot;</span>
         <span class="nt">select</span><span class="p">:</span>
         <span class="p p-Indicator">-</span>  <span class="nt">prefix</span><span class="p">:</span> <span class="s">&quot;http://some.place&quot;</span>
            <span class="nt">do</span><span class="p">:</span>
            <span class="p p-Indicator">-</span>  <span class="nt">set-field</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;Location&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;http://example.com{...}&quot;</span> <span class="p p-Indicator">]</span>
</pre></div>
</div>
</div>
<div class="section" id="referer-remapping">
<h3>Referer Remapping<a class="headerlink" href="#referer-remapping" title="Permalink to this headline">¶</a></h3>
<p>While there is no direct support for the old style referer remapping, it is straight forward to
achieve the same functionality using the field “Referer” extractor and selection.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{creq.field::Referer}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;&quot;</span> <span class="c1"># no referrer, equivalent to the &quot;-&quot; notation</span>
   <span class="nt">do</span><span class="p">:</span>
      <span class="nt">deny</span><span class="p">:</span> <span class="c1"># must have referer</span>
<span class="p p-Indicator">-</span>  <span class="nt">suffix</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;.example.one&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;.friends.one&quot;</span> <span class="p p-Indicator">]</span>
   <span class="nt">do</span><span class="p">:</span>
      <span class="nt">rewrite-url-host</span><span class="p">:</span> <span class="s">&quot;example.one&quot;</span>
<span class="p p-Indicator">-</span>  <span class="nt">else</span><span class="p">:</span>
   <span class="nt">do</span><span class="p">:</span>
      <span class="nt">rewrite-url</span><span class="p">:</span> <span class="s">&quot;http://example.com/denied&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="recv-port">
<h3>RECV_PORT<a class="headerlink" href="#recv-port" title="Permalink to this headline">¶</a></h3>
<p>As with referer remapping, this is easily done by extracting and selecting on the local (proxy) port.
To restrict the URL “example.one” to connections to the local port 8180</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{ua-req-host}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;example.one&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
      <span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{inbound.local_port}&quot;</span>
      <span class="nt">select</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">ne</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8180</span>
         <span class="nt">do</span><span class="p">:</span>
            <span class="nt">deny</span><span class="p">:</span>
</pre></div>
</div>
<p>Note because of the no backtrack rule, the request will pass through unmodified if allowed. If it
needed to be changed to “special.example.one” that would be</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{ua-req-host}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;example.one&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
      <span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{inbound.local_port}&quot;</span>
      <span class="nt">select</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">eq</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8180</span>
         <span class="nt">do</span><span class="p">:</span>
            <span class="nt">set-url-host</span><span class="p">:</span> <span class="s">&quot;special.example.on&quot;</span>
      <span class="p p-Indicator">-</span>  <span class="nt">else</span><span class="p">:</span>
         <span class="nt">do</span><span class="p">:</span>
            <span class="nt">deny</span><span class="p">:</span>
</pre></div>
</div>
</div>
<div class="section" id="a-b-testing">
<h3>A/B Testing<a class="headerlink" href="#a-b-testing" title="Permalink to this headline">¶</a></h3>
<p>The random extractor and the hash modifier are useful for doing bucket testing, where some
proportion of requests should be routed to a staging system instead of the main production upstream.
This can be done randomly per request with the random extractor, or more deterministically using the
has modifier.</p>
<p>Presuming the production destination is “example.one” and the test destination is “stage.example.one”
then 1% of traffic can be sent to the staging system with</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{ua-req-host}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;example.com&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{rand::100}&quot;</span>
      <span class="nt">select</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">eq</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
         <span class="nt">do</span><span class="p">:</span>
         <span class="p p-Indicator">-</span>  <span class="nt">rewrite-url</span><span class="p">:</span> <span class="s">&quot;http://stage.example.com&quot;</span>
      <span class="p p-Indicator">-</span>  <span class="nt">always</span><span class="p">:</span> <span class="c1"># match to allow unmodified request to continue.</span>
</pre></div>
</div>
<p>To be more deterministic, the bucket could be based on the client IP address.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{ua-req-host}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;example.com&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;{inbound.remove_addr}&quot;</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">{</span><span class="nt"> hash</span><span class="p">:</span> <span class="nv">100</span><span class="p p-Indicator">}</span> <span class="p p-Indicator">]</span>
      <span class="nt">select</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">eq</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
         <span class="nt">do</span><span class="p">:</span>
         <span class="p p-Indicator">-</span>  <span class="nt">rewrite-url</span><span class="p">:</span> <span class="s">&quot;http://stage.example.com&quot;</span>
      <span class="p p-Indicator">-</span>  <span class="nt">always</span><span class="p">:</span> <span class="c1"># match to allow unmodified request to continue.</span>
</pre></div>
</div>
<p>As another alternative, this could be done with a cookie in the client request. If the cookie was
“example” with the test bucket indicated by the value “test”, then it would be.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{ua-req-host}&quot;</span>
<span class="nt">select</span><span class="p">:</span>
<span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;example.com&quot;</span>
   <span class="nt">do</span><span class="p">:</span>
   <span class="p p-Indicator">-</span>  <span class="nt">with</span><span class="p">:</span> <span class="s">&quot;{creq.cookie::example}&quot;</span>
      <span class="nt">select</span><span class="p">:</span>
      <span class="p p-Indicator">-</span>  <span class="nt">match</span><span class="p">:</span> <span class="s">&quot;test&quot;</span>
         <span class="nt">do</span><span class="p">:</span>
         <span class="p p-Indicator">-</span>  <span class="nt">rewrite-url</span><span class="p">:</span> <span class="s">&quot;http://stage.example.com&quot;</span>
      <span class="p p-Indicator">-</span>  <span class="nt">always</span><span class="p">:</span> <span class="c1"># match to allow unmodified request to continue.</span>
</pre></div>
</div>
</div>
<div class="section" id="real-life">
<h3>Real Life<a class="headerlink" href="#real-life" title="Permalink to this headline">¶</a></h3>
<p>The following examples are not intended to be illustrative, but are based on actual production
requests from internal sources or on the mailing list. These are here to serve as a guide to
implementation.</p>
<div class="section" id="legacy-appliances">
<h4>Legacy Appliances<a class="headerlink" href="#legacy-appliances" title="Permalink to this headline">¶</a></h4>
<p>Support for legacy appliances is required. The problem is these have very old TLS stacks and among
other things do not provide SNI data. However, it is unacceptable to accept such connections in
general. The requirement is therefore to allow such connections only to specific upstream
destinations and fail the connection otherwise.</p>
</div>
<div class="section" id="query-only">
<h4>Query Only<a class="headerlink" href="#query-only" title="Permalink to this headline">¶</a></h4>
<p>Rewrite the URL iff there is a non-empty query string.</p>
</div>
<div class="section" id="cache-ttl">
<h4>Cache TTL<a class="headerlink" href="#cache-ttl" title="Permalink to this headline">¶</a></h4>
<p>Set a cache TTL if</p>
<ul class="simple">
<li><p>From a specific domain.</p></li>
<li><p>There are no cache TTL control fields.</p></li>
</ul>
<p>This is a bit tricky because multiple fields are involved. Could this be done via an extraction
vector, or better by doing a single extraction of all fields and checking if that is empty?</p>
</div>
<div class="section" id="mutual-tls">
<h4>Mutual TLS<a class="headerlink" href="#mutual-tls" title="Permalink to this headline">¶</a></h4>
<p>Control remapping based on whether the user agent provided a TLS certificate, whether the
certificate was verified, and whether the SNI name is in a whitelist.</p>
<p class="rubric">Footnotes</p>
<dl class="footnote brackets">
<dt class="label" id="id1"><span class="brackets">*</span></dt>
<dd><p>Literals are treated internally as extractors that “extract” the literal string. In practice every
feature string is an array of extractors.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="dev/dev-guide.en.html" class="btn btn-neutral float-right" title="Developer Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="future.en.html" class="btn btn-neutral float-left" title="Future Work" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Verizon Media.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>