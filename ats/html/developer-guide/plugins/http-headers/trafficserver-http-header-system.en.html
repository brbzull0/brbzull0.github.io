

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Traffic Server HTTP Header System &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/override.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Header Functions" href="header-functions.en.html" />
    <link rel="prev" title="HTTP Headers" href="index.en.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="traffic-server-http-header-system">
<span id="developer-plugins-http-headers-system"></span><h1>Traffic Server HTTP Header System<a class="headerlink" href="#traffic-server-http-header-system" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="no-null-terminated-strings">
<h2>No Null-Terminated Strings<a class="headerlink" href="#no-null-terminated-strings" title="Permalink to this headline">¶</a></h2>
<p>It’s not safe to assume that string data contained in marshal buffers
(such as URLs and MIME fields) is stored in null-terminated string
copies. Therefore, your plugins should always use the length parameter
when retrieving or manipulating these strings. You <strong>cannot</strong> pass in
<code class="docutils literal notranslate"><span class="pre">NULL</span></code> for string-length return values; string values returned from
marshall buffers are not null-terminated. If you need a null-terminated
value, then use <code class="docutils literal notranslate"><span class="pre">TSstrndup</span></code> to automatically null-terminate a string.
The strings that come back and are not null-terminated <strong>cannot</strong> be
passed into the common <code class="docutils literal notranslate"><span class="pre">str*()</span></code> routines</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Values returned from a marshall buffer can be <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, which means the
field or object requested does not exist.</p>
</div>
<p>For example (from the <code class="docutils literal notranslate"><span class="pre">denylist_1</span></code> sample)</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span><span class="n">host_string</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">host_length</span><span class="p">;</span>
<span class="n">host_string</span> <span class="o">=</span> <span class="n">TSUrlHostGet</span> <span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="n">url_loc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_length</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsites</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span> <span class="p">(</span><span class="n">host_string</span><span class="p">,</span> <span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">host_length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See the sample plugins for additional examples.</p>
</div>
<div class="section" id="duplicate-mime-fields-are-not-coalesced">
<h2>Duplicate MIME Fields Are Not Coalesced<a class="headerlink" href="#duplicate-mime-fields-are-not-coalesced" title="Permalink to this headline">¶</a></h2>
<p>MIME headers can contain more than one MIME field with the same name.
Earlier versions of Traffic Server joined multiple fields with the same
name into one field with composite values. This behavior came at a
performance cost and caused interoperability problems with older clients
and servers. Therefore, this version of Traffic Server does not coalesce
duplicate fields.</p>
<p>Properly-behaving plugins should check for the presence of duplicate
fields and then iterate over the duplicate fields via
<a class="reference internal" href="../../api/functions/TSMimeHdrFieldNextDup.en.html#c.TSMimeHdrFieldNextDup" title="TSMimeHdrFieldNextDup"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMimeHdrFieldNextDup()</span></code></a>.</p>
</div>
<div class="section" id="mime-fields-always-belong-to-an-associated-mime-header">
<h2>MIME Fields Always Belong to an Associated MIME Header<a class="headerlink" href="#mime-fields-always-belong-to-an-associated-mime-header" title="Permalink to this headline">¶</a></h2>
<p>When using Traffic Server, you cannot create a new MIME field without an
associated MIME header or HTTP header; MIME fields are always seen as
part of a MIME header or HTTP header.</p>
<p>To use a MIME field, you must specify the MIME header or HTTP header to
which it belongs - this is called the field’s <strong>parent header</strong>. The
<code class="docutils literal notranslate"><span class="pre">TSMimeField*</span></code> functions in older versions of the SDK have been
deprecated, as they do not require the parent header as inputs. The
current version of Traffic Server uses new functions, the
<strong>``TSMimeHdrField``</strong> series, which require you to specify the location
of the parent header along with the location of the MIME field. For
every deprecated <em>``TSMimeField``</em> function, there is a new, preferred
<code class="docutils literal notranslate"><span class="pre">TSMimeHdrField*</span></code> function. Therefore, you should use the
<strong>``TSMimeHdrField``</strong> functions instead of the deprecated
<em>``TSMimeField``</em> series. Examples are provided below.</p>
<p>Instead of:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSMLoc</span> <span class="n">TSMimeFieldCreate</span> <span class="p">(</span><span class="n">TSMBuffer</span> <span class="n">bufp</span><span class="p">)</span>
</pre></div>
</div>
<p>You should use:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSMLoc</span> <span class="n">TSMimeHdrFieldCreate</span> <span class="p">(</span><span class="n">TSMBuffer</span> <span class="n">bufp</span><span class="p">,</span> <span class="n">TSMLoc</span> <span class="n">hdr</span><span class="p">)</span>
</pre></div>
</div>
<p>Instead of:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">TSMimeFieldCopyValues</span> <span class="p">(</span><span class="n">TSMBuffer</span> <span class="n">dest_bufp</span><span class="p">,</span> <span class="n">TSMLoc</span> <span class="n">dest_offset</span><span class="p">,</span>
   <span class="n">TSMBuffer</span> <span class="n">src_bufp</span><span class="p">,</span> <span class="n">TSMLoc</span> <span class="n">src_offset</span><span class="p">)</span>
</pre></div>
</div>
<p>You should use:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">TSMimeHdrFieldCopyValues</span> <span class="p">(</span><span class="n">TSMBuffer</span> <span class="n">dest_bufp</span><span class="p">,</span> <span class="n">TSMLoc</span> <span class="n">dest_hdr</span><span class="p">,</span>
   <span class="n">TSMLoc</span> <span class="n">dest_field</span><span class="p">,</span> <span class="n">TSMBuffer</span> <span class="n">src_bufp</span><span class="p">,</span> <span class="n">TSMLoc</span> <span class="n">src_hdr</span><span class="p">,</span> <span class="n">TSMLoc</span>
   <span class="n">src_field</span><span class="p">)</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">TSMimeHdrField*</span></code> function prototypes, the <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> field
corresponds to the <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> offset used the deprecated
<code class="docutils literal notranslate"><span class="pre">TSMimeField*</span></code> functions (see the discussion of parent <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> in
the following section).</p>
</div>
<div class="section" id="release-marshal-buffer-handles">
<h2>Release Marshal Buffer Handles<a class="headerlink" href="#release-marshal-buffer-handles" title="Permalink to this headline">¶</a></h2>
<p>When you fetch a component object or create a new object, you get back a
handle to the object location. The handle is either an <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> for an
object location or <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*</span></code> for a string location. You can manipulate
the object through these handles, but when you are finished you need to
release the handle to free up system resources.</p>
<p>The general guideline is to release all <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> and string handles
you retrieve. The one exception is the string returned by
<code class="docutils literal notranslate"><span class="pre">TSUrlStringGet</span></code>, which must be freed by a call to <code class="docutils literal notranslate"><span class="pre">TSfree</span></code>.</p>
<p>The handle release functions expect three arguments: the marshal buffer
containing the data, the location of the parent object, and the location
of the object to be released. The parent location is usually clear from
the creation of the <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> or string. For example, if your plugin
had the following calls:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">url_loc</span> <span class="o">=</span> <span class="n">TSHttpHdrUrlGet</span> <span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="n">hdr_loc</span><span class="p">);</span>
<span class="n">host_string</span> <span class="o">=</span> <span class="n">TSUrlHostGet</span> <span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="n">url_loc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host_length</span><span class="p">);</span>
</pre></div>
</div>
<p>then your plugin would have to call:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSHandleMLocRelease</span> <span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="n">hdr_loc</span><span class="p">,</span> <span class="n">url_loc</span><span class="p">);</span>
</pre></div>
</div>
<p>If an <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> is obtained from a transaction, then it does not have a
parent <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code>. Use the null <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> constant <code class="docutils literal notranslate"><span class="pre">TS_NULL_MLOC</span></code> as
its parent. For example, if your plugin calls:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSHttpTxnClientReqGet</span> <span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_loc</span><span class="p">);</span>
</pre></div>
</div>
<p>then you must release <code class="docutils literal notranslate"><span class="pre">hdr_loc</span></code> with:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSHandleMLocRelease</span> <span class="p">(</span><span class="n">bufp</span><span class="p">,</span> <span class="n">TS_NULL_MLOC</span><span class="p">,</span> <span class="n">hdr_loc</span><span class="p">);</span>
</pre></div>
</div>
<p>You need to use <code class="docutils literal notranslate"><span class="pre">TS_NULL_MLOC</span></code> to release any <code class="docutils literal notranslate"><span class="pre">TSMLoc</span></code> handles
retrieved by the <code class="docutils literal notranslate"><span class="pre">TSHttpTxn*Get</span></code> functions.</p>
<p>Here’s an example using a new <code class="docutils literal notranslate"><span class="pre">TSMimeHdrField</span></code> function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSHttpTxnServerRespGet</span><span class="p">(</span> <span class="n">txnp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_bufp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_hdr_loc</span> <span class="p">);</span>
<span class="n">new_field_loc</span> <span class="o">=</span> <span class="n">TSMimeHdrFieldCreate</span> <span class="p">(</span><span class="n">resp_bufp</span><span class="p">,</span> <span class="n">resp_hdr_loc</span><span class="p">);</span>
<span class="n">TSHandleMLocRelease</span> <span class="p">(</span> <span class="n">resp_bufp</span><span class="p">,</span> <span class="n">resp_hdr_loc</span><span class="p">,</span> <span class="n">new_field_loc</span><span class="p">);</span>
<span class="n">TSHandleMLocRelease</span> <span class="p">(</span> <span class="n">resp_bufp</span><span class="p">,</span> <span class="n">TS_NULL_MLOC</span><span class="p">,</span> <span class="n">resp_hdr_loc</span><span class="p">);</span>
</pre></div>
</div>
<p>See the sample plugins for many more examples.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You should release handles before reenabling the HTTP transaction.
In other words, call <code class="docutils literal notranslate"><span class="pre">TSHandleMLocRelease</span></code> before <code class="docutils literal notranslate"><span class="pre">TSHttpTxnReenable</span></code>.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.en.html">Plugin Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.en.html">Developer’s Guide</a><ul>
  <li><a href="../index.en.html">Plugin Development</a><ul>
  <li><a href="index.en.html">HTTP Headers</a><ul>
      <li>Previous: <a href="index.en.html" title="previous chapter">HTTP Headers</a></li>
      <li>Next: <a href="header-functions.en.html" title="next chapter">Header Functions</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/developer-guide/plugins/http-headers/trafficserver-http-header-system.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>