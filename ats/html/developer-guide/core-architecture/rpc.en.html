

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RPC &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="URL Rewrite Architecture" href="url_rewrite_architecture.en.html" />
    <link rel="prev" title="Header Heap" href="heap.en.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <span class="target" id="developer-doc-rpc"></span><div class="section" id="rpc">
<h1>RPC<a class="headerlink" href="#rpc" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>In order for programs in different address spaces (remote clients and <strong class="program">traffic_manager</strong>) to communicate with <strong class="program">traffic_server</strong>, there is a RPC mechanism in <a class="reference external" href="https://github.com/apache/trafficserver/blob/master/mgmt/">mgmt/</a>.</p>
<p>This is a simple serialization style RPC which runs over unix domain sockets. The following sections will detail the runtime structure, serialization mechanisms and how messages are passed from remote clients to <strong class="program">traffic_server</strong>.</p>
</div>
<div class="section" id="runtime-structure">
<h2>Runtime Structure<a class="headerlink" href="#runtime-structure" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center">
<p class="plantuml">
<object data="../../_images/plantuml-a27448718329ef0c6ba0c294f9329ae4f3811161.svg" type="image/svg+xml" style="width:527px;height:291px;">
<img src="../../_images/plantuml-a27448718329ef0c6ba0c294f9329ae4f3811161.png" alt="hide empty members

node &quot;traffic_manager&quot;
node &quot;traffic_server&quot;

[traffic_ctl] &lt;-d-&gt; [traffic_manager] : Remote RPC
[other remote clients] &lt;-u-&gt; [traffic_manager] : Remote RPC
[traffic_manager] &lt;-r-&gt; [traffic_server] : Local RPC
[traffic_server] &lt;-r-&gt; [plugin] : Hook"/>

</object></p>
</div>
<p><strong class="program">traffic_manager</strong> opens a unix domain socket to receive commands from remote clients. <strong class="program">traffic_manager</strong> also has a unix domain socket connection with <strong class="program">traffic_server</strong> to communicate.</p>
</div>
<div class="section" id="message-passing">
<h2>Message Passing<a class="headerlink" href="#message-passing" title="Permalink to this headline">¶</a></h2>
<p>Sequence diagram for a command sent from <strong class="program">traffic_ctl</strong> to when it is received by a plugin.</p>
<div class="figure align-default">
<img alt="../../_images/RPC-sequence-diagram.svg" src="../../_images/RPC-sequence-diagram.svg" /></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently a fire and forget model. traffic_manager sends out an asynchronous  signal without any acknowledgment. It then proceeds to send a response itself.</p>
</div>
</div>
<div class="section" id="remote-rpc-vs-local-rpc">
<h2>Remote RPC vs Local RPC<a class="headerlink" href="#remote-rpc-vs-local-rpc" title="Permalink to this headline">¶</a></h2>
<p>The RPC API for remote clients, such as <strong class="program">traffic_ctl</strong>, etc, is different from the RPC API used between <strong class="program">traffic_manager</strong> and <strong class="program">traffic_server</strong>.</p>
<p><strong class="program">traffic_manager</strong> acts like a bridge for remote clients to interact with <strong class="program">traffic_server</strong>. Thus, it is currently impossible to do things like have <strong class="program">traffic_ctl</strong> directly send messages to <strong class="program">traffic_server</strong>. Classes suffixed with “Remote”, ie. <a class="reference external" href="https://github.com/apache/trafficserver/blob/master/CoreAPIRemote.cc">CoreAPIRemote.cc</a>, and classes suffixed with “Local”, ie. <a class="reference external" href="https://github.com/apache/trafficserver/blob/master/NetworkUtilsLocal.cc">NetworkUtilsLocal.cc</a> are for remote and local clients, respectively. The following sections will note which set of RPC’s are relevant.</p>
</div>
<div class="section" id="serialization-mechanism">
<h2>Serialization Mechanism<a class="headerlink" href="#serialization-mechanism" title="Permalink to this headline">¶</a></h2>
<dl class="cpp class">
<dt id="_CPPv412MgmtMarshall">
<span id="_CPPv312MgmtMarshall"></span><span id="_CPPv212MgmtMarshall"></span><span id="MgmtMarshall"></span><em class="property">class </em><code class="sig-name descname">MgmtMarshall</code><a class="headerlink" href="#_CPPv412MgmtMarshall" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This is the class used to marshall data objects. It provides functions to marshall and unmarshall data. Each data object is associated with a field. Fields are of <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv416MgmtMarshallType" title="MgmtMarshallType"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">MgmtMarshallType</span></code></a>:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>MGMT_MARSHALL_INT</strong> : 4 bytes.</p></li>
<li><p><strong>MGMT_MARSHALL_LONG</strong> : 8 bytes.</p></li>
<li><p><strong>MGMT_MARSHALL_STRING</strong> : 4 bytes to indicate the string size in bytes, followed by the entire string and NULL terminator.</p></li>
<li><p><strong>MGMT_MARSHALL_DATA</strong> : 4 byt es to indicate data size in bytes, followed by the entire data object.</p></li>
</ul>
</div></blockquote>
</dd></dl>

<p>When data is actually sent over a connection it must first be serialized. This is the general serialization mechanism for RPC communication.</p>
<p>Generally, for remote clients sending messages to <strong class="program">traffic_server</strong>, the message is serialized using remote RPC APIs. The serialized message is sent to <strong class="program">traffic_manager</strong> and <strong class="program">traffic_manager</strong> then simply relays the message to <strong class="program">traffic_server</strong>. <strong class="program">traffic_server</strong> eventually unserializes the message.</p>
<p>Details for how <strong class="program">traffic_manager</strong> and <strong class="program">traffic_server</strong> communicate are documented in the next section.</p>
<div class="section" id="marshalling">
<h3>Marshalling:<a class="headerlink" href="#marshalling" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><dl class="cpp function">
<dt id="_CPPv421mgmt_message_marshallPv6size_tPK16MgmtMarshallTypejz">
<span id="_CPPv321mgmt_message_marshallPv6size_tPK16MgmtMarshallTypejz"></span><span id="_CPPv221mgmt_message_marshallPv6size_tPK16MgmtMarshallTypejz"></span><span id="mgmt_message_marshall__voidP.s.MgmtMarshallTypeCP.unsigned.z"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv47ssize_t" title="ssize_t">ssize_t</a> <code class="sig-name descname">mgmt_message_marshall</code><span class="sig-paren">(</span>void *<em>buf</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv46size_t" title="size_t">size_t</a> <em>remain</em>, <em class="property">const</em> <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv416MgmtMarshallType" title="MgmtMarshallType">MgmtMarshallType</a> *<em>fields</em>, unsigned <em>count</em>, ...<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv421mgmt_message_marshallPv6size_tPK16MgmtMarshallTypejz" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Variable argument wrapper for <code class="docutils literal notranslate"><span class="pre">mgmt_message_marshall_v</span></code>. Allows for different data types to be marshalled together as long as a field is specified for each data object. Arguments should be references to objects to be marshalled.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv423mgmt_message_marshall_vPv6size_tPK16MgmtMarshallTypej7va_list">
<span id="_CPPv323mgmt_message_marshall_vPv6size_tPK16MgmtMarshallTypej7va_list"></span><span id="_CPPv223mgmt_message_marshall_vPv6size_tPK16MgmtMarshallTypej7va_list"></span><span id="mgmt_message_marshall_v__voidP.s.MgmtMarshallTypeCP.unsigned.va_list"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv47ssize_t" title="ssize_t">ssize_t</a> <code class="sig-name descname">mgmt_message_marshall_v</code><span class="sig-paren">(</span>void *<em>buf</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv46size_t" title="size_t">size_t</a> <em>remain</em>, <em class="property">const</em> <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv416MgmtMarshallType" title="MgmtMarshallType">MgmtMarshallType</a> *<em>fields</em>, unsigned <em>count</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv47va_list" title="va_list">va_list</a> <em>ap</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv423mgmt_message_marshall_vPv6size_tPK16MgmtMarshallTypej7va_list" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This function goes through all the data objects and serializes them together into a buffer. Based on the field, the number of bytes is determined and if there is enough space, it is written into the buffer.</p>
</dd></dl>

</div></blockquote>
</div>
<div class="section" id="unmarshalling">
<h3>Unmarshalling:<a class="headerlink" href="#unmarshalling" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><dl class="cpp function">
<dt id="_CPPv418mgmt_message_parsePKv6size_tPK16MgmtMarshallTypejz">
<span id="_CPPv318mgmt_message_parsePKv6size_tPK16MgmtMarshallTypejz"></span><span id="_CPPv218mgmt_message_parsePKv6size_tPK16MgmtMarshallTypejz"></span><span id="mgmt_message_parse__voidCP.s.MgmtMarshallTypeCP.unsigned.z"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv47ssize_t" title="ssize_t">ssize_t</a> <code class="sig-name descname">mgmt_message_parse</code><span class="sig-paren">(</span><em class="property">const</em> void *<em>buf</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv46size_t" title="size_t">size_t</a> <em>len</em>, <em class="property">const</em> <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv416MgmtMarshallType" title="MgmtMarshallType">MgmtMarshallType</a> *<em>fields</em>, unsigned <em>count</em>, ...<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv418mgmt_message_parsePKv6size_tPK16MgmtMarshallTypejz" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Variable argument wrapper for <code class="docutils literal notranslate"><span class="pre">mgmt_message_parse_v</span></code>. Reference to data object to store unmarshalled message needed for variable arguments.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv420mgmt_message_parse_vPKv6size_tPK16MgmtMarshallTypej7va_list">
<span id="_CPPv320mgmt_message_parse_vPKv6size_tPK16MgmtMarshallTypej7va_list"></span><span id="_CPPv220mgmt_message_parse_vPKv6size_tPK16MgmtMarshallTypej7va_list"></span><span id="mgmt_message_parse_v__voidCP.s.MgmtMarshallTypeCP.unsigned.va_list"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv47ssize_t" title="ssize_t">ssize_t</a> <code class="sig-name descname">mgmt_message_parse_v</code><span class="sig-paren">(</span><em class="property">const</em> void *<em>buf</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv46size_t" title="size_t">size_t</a> <em>len</em>, <em class="property">const</em> <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv416MgmtMarshallType" title="MgmtMarshallType">MgmtMarshallType</a> *<em>fields</em>, unsigned <em>count</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv47va_list" title="va_list">va_list</a> <em>ap</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv420mgmt_message_parse_vPKv6size_tPK16MgmtMarshallTypej7va_list" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This function parses all the serialized. Based on the field, the number of bytes to be read is determined and copied into a <code class="docutils literal notranslate"><span class="pre">MgmtMarshallAnyPtr</span></code>.</p>
</dd></dl>

</div></blockquote>
</div>
</div>
<div class="section" id="local-serialization">
<h2>Local Serialization<a class="headerlink" href="#local-serialization" title="Permalink to this headline">¶</a></h2>
<p>A RPC message is sent as a <a class="reference internal" href="#_CPPv414MgmtMessageHdr" title="MgmtMessageHdr"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">MgmtMessageHdr</span></code></a> followed by the serialized data in bytes. Serialization is very simple as the interface for communication between <strong class="program">traffic_manager</strong> and <strong class="program">traffic_server</strong> only allows for <a class="reference internal" href="#_CPPv414MgmtMessageHdr" title="MgmtMessageHdr"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">MgmtMessageHdr</span></code></a>, which is a fixed size, and raw data in the form of <code class="code docutils literal notranslate"><span class="pre">char*</span></code> to be sent. A header specifies a <em>msg_id</em> and the <em>data_len</em>. On a read, the header is <em>always</em> first read. Based on the length of the data payload, the correct number of bytes is then read from the socket. On a write, the header is first populated and sent on the socket, followed by the raw data.</p>
<dl class="cpp class">
<dt id="_CPPv414MgmtMessageHdr">
<span id="_CPPv314MgmtMessageHdr"></span><span id="_CPPv214MgmtMessageHdr"></span><span id="MgmtMessageHdr"></span><em class="property">class </em><code class="sig-name descname">MgmtMessageHdr</code><a class="headerlink" href="#_CPPv414MgmtMessageHdr" title="Permalink to this definition">¶</a><br /></dt>
<dd><dl class="cpp member">
<dt id="_CPPv4N14MgmtMessageHdr6msg_idE">
<span id="_CPPv3N14MgmtMessageHdr6msg_idE"></span><span id="_CPPv2N14MgmtMessageHdr6msg_idE"></span><span id="MgmtMessageHdr::msg_id__i"></span>int <code class="sig-name descname">msg_id</code><a class="headerlink" href="#_CPPv4N14MgmtMessageHdr6msg_idE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>ID for the event or signal to be sent.</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv4N14MgmtMessageHdr8data_lenE">
<span id="_CPPv3N14MgmtMessageHdr8data_lenE"></span><span id="_CPPv2N14MgmtMessageHdr8data_lenE"></span><span id="MgmtMessageHdr::data_len__i"></span>int <code class="sig-name descname">data_len</code><a class="headerlink" href="#_CPPv4N14MgmtMessageHdr8data_lenE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Length in bytes of the message.</p>
</dd></dl>

</dd></dl>

<p class="plantuml">
<object data="../../_images/plantuml-074ea7ae8f47c3844f6169bcf272356d1eeee74d.svg" type="image/svg+xml" style="width:736px;height:913px;">
<img src="../../_images/plantuml-074ea7ae8f47c3844f6169bcf272356d1eeee74d.png" alt="|Write|
start
:populate msg_id;
:populate data_len;
|#LightGreen|Socket|
:send MgmtMessageHdr;
|Write|
:get the raw data;
note left : casts from\nchar* to void*
|Socket|
:send raw data;
|Read|
:different address space;
: ...\nsome time later;
|Socket|
:read MgmtMessageHdr;
|Read|
:get data_len;
|Socket|
:read data_len bytes;
|Read|
:choose callback based on msg_id\nand send raw data;
stop"/>

</object></p>
</div>
<div class="section" id="rpc-api-for-remote-clients">
<h2>RPC API for remote clients<a class="headerlink" href="#rpc-api-for-remote-clients" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/apache/trafficserver/blob/master/NetworkMessage.cc">NetworkMessage.cc</a> provides a set of APIs for remote clients to communicate with <strong class="program">traffic_manager</strong>.</p>
<p><strong class="program">traffic_manager</strong> will then send a response with the return value. The return value only indicates if the request was successfully propagated to <strong class="program">traffic_server</strong>. Thus, there is no way currently for <strong class="program">traffic_server</strong> to send information back to remote clients.</p>
<dl class="cpp function">
<dt id="_CPPv417send_mgmt_requestRK19mgmt_message_sender6OpTypez">
<span id="_CPPv317send_mgmt_requestRK19mgmt_message_sender6OpTypez"></span><span id="_CPPv217send_mgmt_requestRK19mgmt_message_sender6OpTypez"></span><span id="send_mgmt_request__mgmt_message_senderCR.OpType.z"></span><a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv411TSMgmtError" title="TSMgmtError">TSMgmtError</a> <code class="sig-name descname">send_mgmt_request</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv419mgmt_message_sender" title="mgmt_message_sender">mgmt_message_sender</a> &amp;<em>snd</em>, <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv46OpType" title="OpType">OpType</a> <em>optype</em>, ...<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv417send_mgmt_requestRK19mgmt_message_sender6OpTypez" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<dl class="cpp function">
<dt id="_CPPv417send_mgmt_requesti6OpTypez">
<span id="_CPPv317send_mgmt_requesti6OpTypez"></span><span id="_CPPv217send_mgmt_requesti6OpTypez"></span><span id="send_mgmt_request__i.OpType.z"></span><a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv411TSMgmtError" title="TSMgmtError">TSMgmtError</a> <code class="sig-name descname">send_mgmt_request</code><span class="sig-paren">(</span>int <em>fd</em>, <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv46OpType" title="OpType">OpType</a> <em>optype</em>, ...<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv417send_mgmt_requesti6OpTypez" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Send a request from a remote client to <strong class="program">traffic_manager</strong>.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv418send_mgmt_responsei6OpTypez">
<span id="_CPPv318send_mgmt_responsei6OpTypez"></span><span id="_CPPv218send_mgmt_responsei6OpTypez"></span><span id="send_mgmt_response__i.OpType.z"></span><a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv411TSMgmtError" title="TSMgmtError">TSMgmtError</a> <code class="sig-name descname">send_mgmt_response</code><span class="sig-paren">(</span>int <em>fd</em>, <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv46OpType" title="OpType">OpType</a> <em>optype</em>, ...<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv418send_mgmt_responsei6OpTypez" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Send a response from <strong class="program">traffic_manager</strong> to remote client.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv415send_mgmt_errori6OpType11TSMgmtError">
<span id="_CPPv315send_mgmt_errori6OpType11TSMgmtError"></span><span id="_CPPv215send_mgmt_errori6OpType11TSMgmtError"></span><span id="send_mgmt_error__i.OpType.TSMgmtError"></span><a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv411TSMgmtError" title="TSMgmtError">TSMgmtError</a> <code class="sig-name descname">send_mgmt_error</code><span class="sig-paren">(</span>int <em>fd</em>, <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv46OpType" title="OpType">OpType</a> <em>optype</em>, <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv411TSMgmtError" title="TSMgmtError">TSMgmtError</a> <em>error</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv415send_mgmt_errori6OpType11TSMgmtError" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Send err from <strong class="program">traffic_manager</strong> to remote client.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv417recv_mgmt_requestPv6size_t6OpTypez">
<span id="_CPPv317recv_mgmt_requestPv6size_t6OpTypez"></span><span id="_CPPv217recv_mgmt_requestPv6size_t6OpTypez"></span><span id="recv_mgmt_request__voidP.s.OpType.z"></span><a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv411TSMgmtError" title="TSMgmtError">TSMgmtError</a> <code class="sig-name descname">recv_mgmt_request</code><span class="sig-paren">(</span>void *<em>buf</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv46size_t" title="size_t">size_t</a> <em>buflen</em>, <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv46OpType" title="OpType">OpType</a> <em>optype</em>, ...<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv417recv_mgmt_requestPv6size_t6OpTypez" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Read request from remote client. Used by <strong class="program">traffic_manager</strong>.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv418recv_mgmt_responsePv6size_t6OpTypez">
<span id="_CPPv318recv_mgmt_responsePv6size_t6OpTypez"></span><span id="_CPPv218recv_mgmt_responsePv6size_t6OpTypez"></span><span id="recv_mgmt_response__voidP.s.OpType.z"></span><a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv411TSMgmtError" title="TSMgmtError">TSMgmtError</a> <code class="sig-name descname">recv_mgmt_response</code><span class="sig-paren">(</span>void *<em>buf</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv46size_t" title="size_t">size_t</a> <em>buflen</em>, <a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv46OpType" title="OpType">OpType</a> <em>optype</em>, ...<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv418recv_mgmt_responsePv6size_t6OpTypez" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Read response from <strong class="program">traffic_manager</strong>. Used by remote clients.</p>
</dd></dl>

<div class="section" id="using-remote-rpc-api-example">
<h3>Using Remote RPC API Example<a class="headerlink" href="#using-remote-rpc-api-example" title="Permalink to this headline">¶</a></h3>
<p>This details how a remote client may use the <a class="reference external" href="https://github.com/apache/trafficserver/blob/master/NetworkMessage.cc">NetworkMessage.cc</a> interface to send messages to <strong class="program">traffic_manager</strong>. Leveraging <a class="reference internal" href="#_CPPv417send_mgmt_requestRK19mgmt_message_sender6OpTypez" title="send_mgmt_request"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">send_mgmt_request()</span></code></a> with a <a class="reference internal" href="#_CPPv419mgmt_message_sender" title="mgmt_message_sender"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">mgmt_message_sender</span></code></a> which specifies how <em>send</em> a message, a remote client can implement its own way to send messages to <strong class="program">traffic_manager</strong> to allow for things such as preprocessing messages.</p>
<dl class="cpp class">
<dt id="_CPPv419mgmt_message_sender">
<span id="_CPPv319mgmt_message_sender"></span><span id="_CPPv219mgmt_message_sender"></span><span id="mgmt_message_sender"></span><em class="property">class </em><code class="sig-name descname">mgmt_message_sender</code><a class="headerlink" href="#_CPPv419mgmt_message_sender" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<dl class="cpp class">
<dt id="_CPPv414mgmtapi_sender">
<span id="_CPPv314mgmtapi_sender"></span><span id="_CPPv214mgmtapi_sender"></span><span id="mgmtapi_sender"></span><em class="property">class </em><code class="sig-name descname">mgmtapi_sender</code> : <em class="property">public</em> <a class="reference internal" href="#_CPPv419mgmt_message_sender" title="mgmt_message_sender">mgmt_message_sender</a><a class="headerlink" href="#_CPPv414mgmtapi_sender" title="Permalink to this definition">¶</a><br /></dt>
<dd><dl class="cpp function">
<dt id="_CPPv4NK14mgmtapi_sender4sendEPv6size_t">
<span id="_CPPv3NK14mgmtapi_sender4sendEPv6size_t"></span><span id="_CPPv2NK14mgmtapi_sender4sendEPv6size_t"></span><span id="mgmtapi_sender::send__voidP.sC"></span><a class="reference internal" href="../api/types/TSMgmtTypes.en.html#_CPPv411TSMgmtError" title="TSMgmtError">TSMgmtError</a> <code class="sig-name descname">send</code><span class="sig-paren">(</span>void *<em>msg</em>, <a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv46size_t" title="size_t">size_t</a> <em>msglen</em><span class="sig-paren">)</span> <em class="property">const</em> <em class="property">override</em><a class="headerlink" href="#_CPPv4NK14mgmtapi_sender4sendEPv6size_t" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p>Specifies how the message is to be sent. Can do things such as serialization or preprocessing based on parameters.</p>
</dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MGMTAPI_SEND_MESSAGE(fd, optype, ...) send_mgmt_request(mgmtapi_sender(fd), (optype), __VA_ARGS__)</span>
</pre></div>
</div>
<p>Now, using this macro, messages can easily be sent. For example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">TSMgmtError</span> <span class="n">ret</span><span class="p">;</span>
<span class="n">MgmtMarshallData</span> <span class="n">reply</span>    <span class="o">=</span> <span class="p">{</span><span class="k">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

<span class="c1">// create and send request</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">MGMTAPI_SEND_MESSAGE</span><span class="p">(</span><span class="n">main_socket_fd</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">optype</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TS_ERR_OKAY</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// get a response</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">recv_mgmt_message</span><span class="p">(</span><span class="n">main_socket_fd</span><span class="p">,</span> <span class="n">reply</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">TS_ERR_OKAY</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="rpc-api-for-tserver-and-tmanager">
<h2>RPC API for <strong class="program">traffic_server</strong> and <strong class="program">traffic_manager</strong><a class="headerlink" href="#rpc-api-for-tserver-and-tmanager" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center">
<img alt="../../_images/RPC-states.svg" src="../../_images/RPC-states.svg" /></div>
<p><a class="reference internal" href="#_CPPv412LocalManager" title="LocalManager"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">LocalManager</span></code></a> and <a class="reference internal" href="#_CPPv414ProcessManager" title="ProcessManager"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">ProcessManager</span></code></a> follow similar workflows. A manager will poll the socket for any messages. If it is able to read a message, it will handle it based on the <em>msg_id</em> from the <a class="reference internal" href="#_CPPv414MgmtMessageHdr" title="MgmtMessageHdr"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">MgmtMessageHdr</span></code></a> and select a callback to run asynchoronously. The async callback will add a response, if any, to an outgoing event queue within the class. A manager will continue to poll and read on the socket as long as there are messages available. Two things can stop a manager from polling.</p>
<ol class="arabic simple">
<li><p>there are no longer any messages on the socket for a <em>timeout</em> time period.</p></li>
<li><p>an external event, for example, a <strong class="program">traffic_ctl</strong> command, triggers an <code class="docutils literal notranslate"><span class="pre">eventfd</span></code> to tell the manager to stop polling. In the case of an external event, the manager will finish reading anything on the socket, but it will not wait for any timeout period. So, if there are three pending events on the socket, all three will be processed and then immediately after, the manager will stop polling.</p></li>
</ol>
<p>Once a manager is done polling, it will begin to send out messages from it’s outgoing event queue. It continues to do this until there are no more messages left. Note that as a manager is polling, it is unable to write anything on the socket itself so the number of messages read will always be exhaustive.</p>
<dl class="cpp class">
<dt id="_CPPv411BaseManager">
<span id="_CPPv311BaseManager"></span><span id="_CPPv211BaseManager"></span><span id="BaseManager"></span><em class="property">class </em><code class="sig-name descname">BaseManager</code><a class="headerlink" href="#_CPPv411BaseManager" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<div class="section" id="localmanager">
<h3>LocalManager<a class="headerlink" href="#localmanager" title="Permalink to this headline">¶</a></h3>
<dl class="cpp class">
<dt id="_CPPv412LocalManager">
<span id="_CPPv312LocalManager"></span><span id="_CPPv212LocalManager"></span><span id="LocalManager"></span><em class="property">class </em><code class="sig-name descname">LocalManager</code> : <em class="property">public</em> <a class="reference internal" href="#_CPPv411BaseManager" title="BaseManager">BaseManager</a><a class="headerlink" href="#_CPPv412LocalManager" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This class is used by <strong class="program">traffic_manager</strong> to communicate with <strong class="program">traffic_server</strong></p>
<dl class="cpp function">
<dt id="_CPPv4N12LocalManager21pollMgmtProcessServerEv">
<span id="_CPPv3N12LocalManager21pollMgmtProcessServerEv"></span><span id="_CPPv2N12LocalManager21pollMgmtProcessServerEv"></span><span id="LocalManager::pollMgmtProcessServer"></span>void <code class="sig-name descname">pollMgmtProcessServer</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N12LocalManager21pollMgmtProcessServerEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This function watches the socket and handles incoming messages from processes. Used in the main event loop of <strong class="program">traffic_manager</strong>.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N12LocalManager22sendMgmtMsgToProcessesEP14MgmtMessageHdr">
<span id="_CPPv3N12LocalManager22sendMgmtMsgToProcessesEP14MgmtMessageHdr"></span><span id="_CPPv2N12LocalManager22sendMgmtMsgToProcessesEP14MgmtMessageHdr"></span><span id="LocalManager::sendMgmtMsgToProcesses__MgmtMessageHdrP"></span>void <code class="sig-name descname">sendMgmtMsgToProcesses</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv414MgmtMessageHdr" title="MgmtMessageHdr">MgmtMessageHdr</a> *<em>mh</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N12LocalManager22sendMgmtMsgToProcessesEP14MgmtMessageHdr" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This function is used by <strong class="program">traffic_manager</strong> to process the messages based on <em>msg_id</em>. It then sends the message to <strong class="program">traffic_server</strong> over sockets.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="processmanager">
<h3>ProcessManager<a class="headerlink" href="#processmanager" title="Permalink to this headline">¶</a></h3>
<dl class="cpp class">
<dt id="_CPPv414ProcessManager">
<span id="_CPPv314ProcessManager"></span><span id="_CPPv214ProcessManager"></span><span id="ProcessManager"></span><em class="property">class </em><code class="sig-name descname">ProcessManager</code> : <em class="property">public</em> <a class="reference internal" href="#_CPPv411BaseManager" title="BaseManager">BaseManager</a><a class="headerlink" href="#_CPPv414ProcessManager" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This class is used by <strong class="program">traffic_server</strong> to communicate with <strong class="program">traffic_manager</strong></p>
<dl class="cpp function">
<dt id="_CPPv4N14ProcessManager16pollLMConnectionEv">
<span id="_CPPv3N14ProcessManager16pollLMConnectionEv"></span><span id="_CPPv2N14ProcessManager16pollLMConnectionEv"></span><span id="ProcessManager::pollLMConnection"></span>int <code class="sig-name descname">pollLMConnection</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14ProcessManager16pollLMConnectionEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This function periodically polls the socket to see if there are any messages from the <a class="reference internal" href="#_CPPv412LocalManager" title="LocalManager"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">LocalManager</span></code></a>.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14ProcessManager13signalManagerEiPKci">
<span id="_CPPv3N14ProcessManager13signalManagerEiPKci"></span><span id="_CPPv2N14ProcessManager13signalManagerEiPKci"></span><span id="ProcessManager::signalManager__i.cCP.i"></span>void <code class="sig-name descname">signalManager</code><span class="sig-paren">(</span>int <em>msg_id</em>, <em class="property">const</em> char *<em>data_raw</em>, int <em>data_len</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14ProcessManager13signalManagerEiPKci" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>This function sends messages to the <a class="reference internal" href="#_CPPv412LocalManager" title="LocalManager"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">LocalManager</span></code></a> using sockets.</p>
</dd></dl>

</dd></dl>

<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic simple">
<li><p>Both <a class="reference internal" href="#_CPPv4N12LocalManager21pollMgmtProcessServerEv" title="LocalManager::pollMgmtProcessServer"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">LocalManager::pollMgmtProcessServer()</span></code></a> and <a class="reference internal" href="#_CPPv4N14ProcessManager16pollLMConnectionEv" title="ProcessManager::pollLMConnection"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">ProcessManager::pollLMConnection()</span></code></a> actually use <code class="docutils literal notranslate"><span class="pre">select</span></code>, not <code class="docutils literal notranslate"><span class="pre">poll</span></code> or <code class="docutils literal notranslate"><span class="pre">epoll</span></code>, underneath.</p></li>
</ol>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/index.en.html">Plugin Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.en.html">Developer’s Guide</a><ul>
  <li><a href="index.en.html">Core Architecture</a><ul>
      <li>Previous: <a href="heap.en.html" title="previous chapter">Header Heap</a></li>
      <li>Next: <a href="url_rewrite_architecture.en.html" title="next chapter">URL Rewrite Architecture</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/developer-guide/core-architecture/rpc.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>