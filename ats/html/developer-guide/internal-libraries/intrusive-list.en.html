

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IntrusiveDList &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="IntrusiveHashMap" href="intrusive-hash-map.en.html" />
    <link rel="prev" title="BufferWriter" href="buffer-writer.en.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="intrusivedlist">
<h1>IntrusiveDList<a class="headerlink" href="#intrusivedlist" title="Permalink to this headline">¶</a></h1>
<p><a class="reference internal" href="#_CPPv4I0E14IntrusiveDList" title="IntrusiveDList"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">IntrusiveDList</span></code></a> is a class that provides a double linked list using pointers embedded in the
object. <a class="reference internal" href="#_CPPv4I0E14IntrusiveDList" title="IntrusiveDList"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">IntrusiveDList</span></code></a> also acts as a queue. No memory management is done - objects can be
added to and removed from the list but the allocation and deallocation of the objects must be
handled outside the class. This class supports an STL compliant bidirectional iteration. The
iterators automatically convert to pointer as in normal use of this class the contained elements
will be referenced by pointers.</p>
</div>
<div class="section" id="definition">
<h1>Definition<a class="headerlink" href="#definition" title="Permalink to this headline">¶</a></h1>
<dl class="cpp class">
<dt id="_CPPv4I0E14IntrusiveDList">
<span id="_CPPv3I0E14IntrusiveDList"></span><span id="_CPPv2I0E14IntrusiveDList"></span>template&lt;typename <code class="sig-name descname">L</code>&gt;<br /><em class="property">class </em><code class="sig-name descname">IntrusiveDList</code><a class="headerlink" href="#_CPPv4I0E14IntrusiveDList" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>A double linked list / queue based on links inside the objects. The element type, <code class="code docutils literal notranslate"><span class="pre">T</span></code>, is
deduced from the return type of the link accessor methods in <em>L</em>.</p>
<dl class="field-list simple">
<dt class="field-odd">Template Parameters</dt>
<dd class="field-odd"><p><strong>L</strong> – List item descriptor</p>
</dd>
</dl>
<p>The descriptor, <em>L</em>, is a type that provides the operations on list elements required by
the container.</p>
<dl class="cpp type">
<dt id="_CPPv4N14IntrusiveDList10value_typeE">
<span id="_CPPv3N14IntrusiveDList10value_typeE"></span><span id="_CPPv2N14IntrusiveDList10value_typeE"></span><span id="IntrusiveDList::value_type"></span><em class="property">type </em><code class="sig-name descname">value_type</code><a class="headerlink" href="#_CPPv4N14IntrusiveDList10value_typeE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The type of elements in the container, deduced from the return types of the link accessor methods
in <em>L</em>.</p>
</dd></dl>

<dl>
<dt><em>L</em></dt><dd><dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList8next_ptrEP10value_type">
<span id="_CPPv3N14IntrusiveDList8next_ptrEP10value_type"></span><span id="_CPPv2N14IntrusiveDList8next_ptrEP10value_type"></span><span id="IntrusiveDList::next_ptr__value_typeP"></span><em class="property">static</em> <a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *&amp;<code class="sig-name descname">next_ptr</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<em>elt</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList8next_ptrEP10value_type" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return a reference to the next element pointer embedded in the element <em>elt</em>.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList8prev_ptrEP10value_type">
<span id="_CPPv3N14IntrusiveDList8prev_ptrEP10value_type"></span><span id="_CPPv2N14IntrusiveDList8prev_ptrEP10value_type"></span><span id="IntrusiveDList::prev_ptr__value_typeP"></span><em class="property">static</em> <a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *&amp;<code class="sig-name descname">prev_ptr</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<em>elt</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList8prev_ptrEP10value_type" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return a reference to the previous element pointer embedded in the element <em>elt</em>.</p>
</dd></dl>

</dd>
</dl>
<dl class="cpp type">
<dt id="_CPPv4N14IntrusiveDList8iteratorE">
<span id="_CPPv3N14IntrusiveDList8iteratorE"></span><span id="_CPPv2N14IntrusiveDList8iteratorE"></span><span id="IntrusiveDList::iterator"></span><em class="property">type </em><code class="sig-name descname">iterator</code><a class="headerlink" href="#_CPPv4N14IntrusiveDList8iteratorE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>An STL compliant bidirectional iterator on elements in the list. <a class="reference internal" href="#_CPPv4N14IntrusiveDList8iteratorE" title="IntrusiveDList::iterator"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">iterator</span></code></a> has a user
defined conversion to <code class="code docutils literal notranslate"><span class="pre">value_type</span> <span class="pre">*</span></code> for convenience in use.</p>
</dd></dl>

<dl class="cpp type">
<dt id="_CPPv4N14IntrusiveDList14const_iteratorE">
<span id="_CPPv3N14IntrusiveDList14const_iteratorE"></span><span id="_CPPv2N14IntrusiveDList14const_iteratorE"></span><span id="IntrusiveDList::const_iterator"></span><em class="property">type </em><code class="sig-name descname">const_iterator</code><a class="headerlink" href="#_CPPv4N14IntrusiveDList14const_iteratorE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>An STL compliant bidirectional constant iterator on elements in the list. <a class="reference internal" href="#_CPPv4N14IntrusiveDList14const_iteratorE" title="IntrusiveDList::const_iterator"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">const_iterator</span></code></a> has a user
defined conversion to <code class="code docutils literal notranslate"><span class="pre">const</span> <span class="pre">value_type</span> <span class="pre">*</span></code> for convenience in use.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList4headEv">
<span id="_CPPv3N14IntrusiveDList4headEv"></span><span id="_CPPv2N14IntrusiveDList4headEv"></span><span id="IntrusiveDList::head"></span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<code class="sig-name descname">head</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList4headEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return a pointer to the head element in the list. This may be <code class="code docutils literal notranslate"><span class="pre">nullptr</span></code> if the list is empty.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList4tailEv">
<span id="_CPPv3N14IntrusiveDList4tailEv"></span><span id="_CPPv2N14IntrusiveDList4tailEv"></span><span id="IntrusiveDList::tail"></span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<code class="sig-name descname">tail</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList4tailEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return a pointer to the tail element in the list. This may be <code class="code docutils literal notranslate"><span class="pre">nullptr</span></code> if the list is empty.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList5clearEv">
<span id="_CPPv3N14IntrusiveDList5clearEv"></span><span id="_CPPv2N14IntrusiveDList5clearEv"></span><span id="IntrusiveDList::clear"></span><a class="reference internal" href="#_CPPv4I0E14IntrusiveDList" title="IntrusiveDList">IntrusiveDList</a> &amp;<code class="sig-name descname">clear</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList5clearEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Remove all elements from the list. This only removes, no deallocation nor destruction is performed.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4NK14IntrusiveDList5countEv">
<span id="_CPPv3NK14IntrusiveDList5countEv"></span><span id="_CPPv2NK14IntrusiveDList5countEv"></span><span id="IntrusiveDList::countC"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv46size_t" title="size_t">size_t</a> <code class="sig-name descname">count</code><span class="sig-paren">(</span><span class="sig-paren">)</span> <em class="property">const</em><a class="headerlink" href="#_CPPv4NK14IntrusiveDList5countEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return the number of elements in the list.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList6appendEP10value_type">
<span id="_CPPv3N14IntrusiveDList6appendEP10value_type"></span><span id="_CPPv2N14IntrusiveDList6appendEP10value_type"></span><span id="IntrusiveDList::append__value_typeP"></span><a class="reference internal" href="#_CPPv4I0E14IntrusiveDList" title="IntrusiveDList">IntrusiveDList</a> &amp;<code class="sig-name descname">append</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<em>elt</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList6appendEP10value_type" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Append <em>elt</em> to the list.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList7prependEP10value_type">
<span id="_CPPv3N14IntrusiveDList7prependEP10value_type"></span><span id="_CPPv2N14IntrusiveDList7prependEP10value_type"></span><span id="IntrusiveDList::prepend__value_typeP"></span><a class="reference internal" href="#_CPPv4I0E14IntrusiveDList" title="IntrusiveDList">IntrusiveDList</a> &amp;<code class="sig-name descname">prepend</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<em>elt</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList7prependEP10value_type" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Prepend <em>elt</em> to the list.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList9take_headEv">
<span id="_CPPv3N14IntrusiveDList9take_headEv"></span><span id="_CPPv2N14IntrusiveDList9take_headEv"></span><span id="IntrusiveDList::take_head"></span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<code class="sig-name descname">take_head</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList9take_headEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Remove the head element and return a pointer to it. May be <code class="code docutils literal notranslate"><span class="pre">nullptr</span></code> if the list is empty.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList9take_tailEv">
<span id="_CPPv3N14IntrusiveDList9take_tailEv"></span><span id="_CPPv2N14IntrusiveDList9take_tailEv"></span><span id="IntrusiveDList::take_tail"></span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<code class="sig-name descname">take_tail</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList9take_tailEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Remove the tail element and return a pointer to it. May be <code class="code docutils literal notranslate"><span class="pre">nullptr</span></code> if the list is empty.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList5eraseERK8iterator">
<span id="_CPPv3N14IntrusiveDList5eraseERK8iterator"></span><span id="_CPPv2N14IntrusiveDList5eraseERK8iterator"></span><span id="IntrusiveDList::erase__iteratorCR"></span><a class="reference internal" href="#_CPPv4N14IntrusiveDList8iteratorE" title="IntrusiveDList::iterator">iterator</a> <code class="sig-name descname">erase</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N14IntrusiveDList8iteratorE" title="IntrusiveDList::iterator">iterator</a> &amp;<em>loc</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList5eraseERK8iterator" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Remove the element at <em>loc</em>. Return the element after <em>loc</em>.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList5eraseERK8iteratorRK8iterator">
<span id="_CPPv3N14IntrusiveDList5eraseERK8iteratorRK8iterator"></span><span id="_CPPv2N14IntrusiveDList5eraseERK8iteratorRK8iterator"></span><span id="IntrusiveDList::erase__iteratorCR.iteratorCR"></span><a class="reference internal" href="#_CPPv4N14IntrusiveDList8iteratorE" title="IntrusiveDList::iterator">iterator</a> <code class="sig-name descname">erase</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N14IntrusiveDList8iteratorE" title="IntrusiveDList::iterator">iterator</a> &amp;<em>start</em>, <em class="property">const</em> <a class="reference internal" href="#_CPPv4N14IntrusiveDList8iteratorE" title="IntrusiveDList::iterator">iterator</a> &amp;<em>limit</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList5eraseERK8iteratorRK8iterator" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Remove the elements in the half open range from and including <em>start</em>
to but not including <em>limit</em>.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList12iterator_forEP10value_type">
<span id="_CPPv3N14IntrusiveDList12iterator_forEP10value_type"></span><span id="_CPPv2N14IntrusiveDList12iterator_forEP10value_type"></span><span id="IntrusiveDList::iterator_for__value_typeP"></span><a class="reference internal" href="#_CPPv4N14IntrusiveDList8iteratorE" title="IntrusiveDList::iterator">iterator</a> <code class="sig-name descname">iterator_for</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<em>value</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList12iterator_forEP10value_type" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return an <a class="reference internal" href="#_CPPv4N14IntrusiveDList8iteratorE" title="IntrusiveDList::iterator"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">iterator</span></code></a> that refers to <em>value</em>. <em>value</em> is checked for being in a
list but there is no guarantee it is in this list. If <em>value</em> is not in a list then the
end iterator is returned.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N14IntrusiveDList12iterator_forEPK10value_type">
<span id="_CPPv3N14IntrusiveDList12iterator_forEPK10value_type"></span><span id="_CPPv2N14IntrusiveDList12iterator_forEPK10value_type"></span><span id="IntrusiveDList::iterator_for__value_typeCP"></span><a class="reference internal" href="#_CPPv4N14IntrusiveDList14const_iteratorE" title="IntrusiveDList::const_iterator">const_iterator</a> <code class="sig-name descname">iterator_for</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N14IntrusiveDList10value_typeE" title="IntrusiveDList::value_type">value_type</a> *<em>value</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N14IntrusiveDList12iterator_forEPK10value_type" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return a <a class="reference internal" href="#_CPPv4N14IntrusiveDList14const_iteratorE" title="IntrusiveDList::const_iterator"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">const_iterator</span></code></a> that refers to <em>value</em>. <em>value</em> is checked for being
in a list but there is no guarantee it is in this list. If <em>value</em> is not in a list then
the end iterator is returned.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<p>An instance of <a class="reference internal" href="#_CPPv4I0E14IntrusiveDList" title="IntrusiveDList"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">IntrusiveDList</span></code></a> acts as a container for items, maintaining a doubly linked
list / queue of the objects and tracking the number of objects in the container. There are methods
for appending, prepending, and inserting (both before and after a specific element already in the
list). Some care must be taken because it is too expensive to check for an element already being in
the list or in another list. The internal links are set to <code class="code docutils literal notranslate"><span class="pre">nullptr</span></code>, therefore one simple check
for being in a list is if either internal link is not <code class="code docutils literal notranslate"><span class="pre">nullptr</span></code>. This requires initializing the
internal links to <code class="code docutils literal notranslate"><span class="pre">nullptr</span></code>.</p>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>In this example the goal is to have a list of <code class="code docutils literal notranslate"><span class="pre">Message</span></code> objects. First the class is declared
along with the internal linkage support.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="k">using</span> <span class="n">self_type</span> <span class="o">=</span> <span class="n">Message</span><span class="p">;</span> <span class="c1">///&lt; Self reference type.</span>

<span class="k">public</span><span class="o">:</span>
  <span class="c1">// Message severity level.</span>
  <span class="k">enum</span> <span class="n">Severity</span> <span class="p">{</span> <span class="n">LVL_DEBUG</span><span class="p">,</span> <span class="n">LVL_INFO</span><span class="p">,</span> <span class="n">LVL_WARN</span><span class="p">,</span> <span class="n">LVL_ERROR</span> <span class="p">};</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">_text</span><span class="p">;</span> <span class="c1">// Text of the message.</span>
  <span class="n">Severity</span> <span class="n">_severity</span><span class="p">{</span><span class="n">LVL_DEBUG</span><span class="p">};</span>
  <span class="kt">int</span> <span class="n">_indent</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="c1">// indentation level for display.</span>

  <span class="c1">// Intrusive list support.</span>
  <span class="k">struct</span> <span class="n">Linkage</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">self_type</span> <span class="o">*&amp;</span><span class="n">next_ptr</span><span class="p">(</span><span class="n">self_type</span> <span class="o">*</span><span class="p">);</span> <span class="c1">// Link accessor.</span>
    <span class="k">static</span> <span class="n">self_type</span> <span class="o">*&amp;</span><span class="n">prev_ptr</span><span class="p">(</span><span class="n">self_type</span> <span class="o">*</span><span class="p">);</span> <span class="c1">// Link accessor.</span>

    <span class="n">self_type</span> <span class="o">*</span><span class="n">_next</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span> <span class="c1">// Forward link.</span>
    <span class="n">self_type</span> <span class="o">*</span><span class="n">_prev</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span> <span class="c1">// Backward link.</span>
  <span class="p">}</span> <span class="n">_link</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="nf">is_in_list</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">friend</span> <span class="k">class</span> <span class="nc">Container</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The struct <code class="code docutils literal notranslate"><span class="pre">Linkage</span></code> is used both to provide the descriptor to <a class="reference internal" href="#_CPPv4I0E14IntrusiveDList" title="IntrusiveDList"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">IntrusiveDList</span></code></a> and to
contain the link pointers. This isn’t necessary - the links could have been direct members
and the implementation of the link accessor methods adjusted. Because the links are intended to be
used only by a specific container class (<code class="code docutils literal notranslate"><span class="pre">Container</span></code>) the struct is made protected.</p>
<p>The implementation of the link accessor methods.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Message</span><span class="o">::</span><span class="n">Linkage</span><span class="o">::</span><span class="n">next_ptr</span><span class="p">(</span><span class="n">self_type</span> <span class="o">*</span><span class="n">that</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">self_type</span> <span class="o">*&amp;</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">that</span><span class="o">-&gt;</span><span class="n">_link</span><span class="p">.</span><span class="n">_next</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">auto</span>
<span class="n">Message</span><span class="o">::</span><span class="n">Linkage</span><span class="o">::</span><span class="n">prev_ptr</span><span class="p">(</span><span class="n">self_type</span> <span class="o">*</span><span class="n">that</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">self_type</span> <span class="o">*&amp;</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">that</span><span class="o">-&gt;</span><span class="n">_link</span><span class="p">.</span><span class="n">_prev</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A method to check if the message is in a list.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Message</span><span class="o">::</span><span class="n">is_in_list</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">_link</span><span class="p">.</span><span class="n">_next</span> <span class="o">||</span> <span class="n">_link</span><span class="p">.</span><span class="n">_prev</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The container class for the messages could be implemented as</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="k">using</span> <span class="n">self_type</span>   <span class="o">=</span> <span class="n">Container</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">MessageList</span> <span class="o">=</span> <span class="n">ts</span><span class="o">::</span><span class="n">IntrusiveDList</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">::</span><span class="n">Linkage</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="o">~</span><span class="n">Container</span><span class="p">();</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span> <span class="n">self_type</span> <span class="o">&amp;</span><span class="n">debug</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">Args</span> <span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">);</span>

  <span class="kt">size_t</span> <span class="nf">count</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
  <span class="n">self_type</span> <span class="o">&amp;</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">Message</span><span class="o">::</span><span class="n">Severity</span> <span class="n">max_severity</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">print</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="n">MessageList</span> <span class="n">_msgs</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">debug</span></code> method takes a format string (<em>fmt</em>) and an arbitrary set of arguments, formats
the arguments in to the string, and adds the new message to the list.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<span class="k">auto</span>
<span class="n">Container</span><span class="o">::</span><span class="n">debug</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">Args</span> <span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">self_type</span> <span class="o">&amp;</span>
<span class="p">{</span>
  <span class="n">Message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Message</span><span class="p">;</span>
  <span class="n">ts</span><span class="o">::</span><span class="n">bwprintv</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">_text</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward_as_tuple</span><span class="p">(</span><span class="n">args</span><span class="p">...));</span>
  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">_severity</span> <span class="o">=</span> <span class="n">Message</span><span class="o">::</span><span class="n">LVL_DEBUG</span><span class="p">;</span>
  <span class="n">_msgs</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">print</span></code> method demonstrates the use of the range <code class="code docutils literal notranslate"><span class="pre">for</span></code> loop on a list.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Container</span><span class="o">::</span><span class="n">print</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="nl">elt</span> <span class="p">:</span> <span class="n">_msgs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">elt</span><span class="p">.</span><span class="n">_severity</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">elt</span><span class="p">.</span><span class="n">_text</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The maximum severity level can also be computed even more easily using <code class="code docutils literal notranslate"><span class="pre">std::max_element</span></code>.
This find the element with the maximum severity and returns that severity, or <code class="code docutils literal notranslate"><span class="pre">LVL_DEBUG</span></code> if
no element is found (which happens if the list is empty).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Container</span><span class="o">::</span><span class="n">max_severity</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="n">spot</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max_element</span><span class="p">(</span><span class="n">_msgs</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">_msgs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                               <span class="p">[](</span><span class="n">Message</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">lhs</span><span class="p">,</span> <span class="n">Message</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">rhs</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">lhs</span><span class="p">.</span><span class="n">_severity</span> <span class="o">&lt;</span> <span class="n">rhs</span><span class="p">.</span><span class="n">_severity</span><span class="p">;</span> <span class="p">});</span>
  <span class="k">return</span> <span class="n">spot</span> <span class="o">==</span> <span class="n">_msgs</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">?</span> <span class="n">Message</span><span class="o">::</span><span class="n">Severity</span><span class="o">::</span><span class="nl">LVL_DEBUG</span> <span class="p">:</span> <span class="n">spot</span><span class="o">-&gt;</span><span class="n">_severity</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Other methods for the various severity levels would be implemented in a similar fashion. Because the
intrusive list does not do memory management, the container must clean that up itself, as in the
<code class="code docutils literal notranslate"><span class="pre">clear</span></code> method. A bit of care must be exercised because the links are in the elements, and
these links are used for iteration therefore using an iterator that references a deleted object is
risky. One approach, illustrated here, is to use <a class="reference internal" href="#_CPPv4N14IntrusiveDList9take_headEv" title="IntrusiveDList::take_head"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">IntrusiveDList::take_head()</span></code></a> to remove the
element before destroying it. Another option is to allocation the elements in a <a class="reference internal" href="MemArena.en.html#_CPPv48MemArena" title="MemArena"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">MemArena</span></code></a> to
avoid the need for any explicit cleanup.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Container</span><span class="o">::</span><span class="n">clear</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">self_type</span> <span class="o">&amp;</span>
<span class="p">{</span>
  <span class="n">Message</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="k">nullptr</span> <span class="o">!=</span> <span class="p">(</span><span class="n">msg</span> <span class="o">=</span> <span class="n">_msgs</span><span class="p">.</span><span class="n">take_head</span><span class="p">()))</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="n">msg</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">_msgs</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In some cases the elements of the list are subclasses and the links are declared in a super class
and are therefore of the super class type. For instance, in the unit test a class <code class="code docutils literal notranslate"><span class="pre">Thing</span></code> is
defined for testing.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>  <span class="n">Thing</span> <span class="o">*</span><span class="n">_next</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</pre></div>
</div>
<p>Later on, to validate use on a subclass, <code class="code docutils literal notranslate"><span class="pre">PrivateThing</span></code> is defined as a subclass of
<code class="code docutils literal notranslate"><span class="pre">Thing</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
</pre></div>
</div>
<p>However, the link members <code class="code docutils literal notranslate"><span class="pre">_next</span></code> and <code class="code docutils literal notranslate"><span class="pre">_prev</span></code> are of type <code class="code docutils literal notranslate"><span class="pre">Thing*</span></code> but the
descriptor for a list of <code class="code docutils literal notranslate"><span class="pre">PrivateThing</span></code> must have link accessors that return
<code class="code docutils literal notranslate"><span class="pre">PrivateThing</span> <span class="pre">*&amp;</span></code>. To make this easier a conversion template function is provided,
<code class="code docutils literal notranslate"><span class="pre">ts::ptr_ref_cast&lt;X,</span> <span class="pre">T&gt;</span></code> that converts a member of type <code class="code docutils literal notranslate"><span class="pre">T*</span></code> to a reference to a pointer
to <code class="code docutils literal notranslate"><span class="pre">X</span></code>, e.g. <code class="code docutils literal notranslate"><span class="pre">X*&amp;</span></code>. This is used in the setup for testing <code class="code docutils literal notranslate"><span class="pre">PrivateThing</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>    <span class="n">next_ptr</span><span class="p">(</span><span class="n">self_type</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="n">ts</span><span class="o">::</span><span class="n">ptr_ref_cast</span><span class="o">&lt;</span><span class="n">self_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">_next</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">static</span> <span class="n">self_type</span> <span class="o">*&amp;</span>
    <span class="n">prev_ptr</span><span class="p">(</span><span class="n">self_type</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">return</span> <span class="n">ts</span><span class="o">::</span><span class="n">ptr_ref_cast</span><span class="o">&lt;</span><span class="n">self_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">_prev</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
</pre></div>
</div>
<p>While this can be done directly with <code class="code docutils literal notranslate"><span class="pre">reinterpret_cast&lt;&gt;</span></code>, use of <code class="code docutils literal notranslate"><span class="pre">ts::ptr_cast</span></code> avoids
typographic errors and warnings about type punning caused by <code class="code docutils literal notranslate"><span class="pre">-fstrict-aliasing</span></code>.</p>
</div>
</div>
<div class="section" id="design-notes">
<h1>Design Notes<a class="headerlink" href="#design-notes" title="Permalink to this headline">¶</a></h1>
<p>The historic goal of this class is to replace the <code class="code docutils literal notranslate"><span class="pre">DLL</span></code> list support. The benefits of this are</p>
<ul class="simple">
<li><p>Remove dependency on the C preprocessor.</p></li>
<li><p>Provide greater flexibility in the internal link members. Because of the use of the descriptor
and its static methods, the links can be anywhere in the object, including in nested structures
or super classes. The links are declared like normal members and do not require specific macros.</p></li>
<li><p>Provide STL compliant iteration. This makes the class easier to use in general and particularly
in the case of range <code class="code docutils literal notranslate"><span class="pre">for</span></code> loops.</p></li>
<li><p>Track the number of items in the list.</p></li>
<li><p>Provide queue support, which is of such low marginal expense there is, IMHO, no point in
providing a separate class for it.</p></li>
</ul>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Internal libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/index.en.html">Plugin Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.en.html">Developer’s Guide</a><ul>
  <li><a href="index.en.html">Internal libraries</a><ul>
      <li>Previous: <a href="buffer-writer.en.html" title="previous chapter">BufferWriter</a></li>
      <li>Next: <a href="intrusive-hash-map.en.html" title="next chapter">IntrusiveHashMap</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/developer-guide/internal-libraries/intrusive-list.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>