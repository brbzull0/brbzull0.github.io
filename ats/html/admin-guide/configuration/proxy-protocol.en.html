

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proxy Protocol &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Interacting with Traffic Server" href="../interaction/index.en.html" />
    <link rel="prev" title="Hierarchical Caching" href="hierarchical-caching.en.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="proxy-protocol">
<span id="id1"></span><h1>Proxy Protocol<a class="headerlink" href="#proxy-protocol" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="https://www.haproxy.com/blog/haproxy/proxy-protocol/">PROXY protocol</a>
provides a means of passing connection information between layers of the proxy
infrastructure.  Without the PROXY protocol, Traffic Server would only have connection
information from the previous hop connecting to Traffic Server and not the actual
originating client connection information.  This can be done over either HTTP or
TLS connections.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The current version only supports transforming client IP from PROXY Version 1
header to the Forwarded: header.</p>
</div>
<p>In the current implementation, the client IP address in the PROXY protocol header
is passed to the origin server via an HTTP <a class="reference external" href="https://tools.ietf.org/html/rfc7239">Forwarded:</a> header.</p>
<p>The Proxy Protocol must be enabled on each port.  See
<a class="reference internal" href="../files/records.config.en.html#proxy-config-http-server-ports" title="records.config"><code class="xref ts ts-cv docutils literal notranslate"><span class="pre">proxy.config.http.server_ports</span></code></a> for information on how to enable the
Proxy Protocol on a port.  Once enabled, all incoming requests must be prefaced
with the PROXY v1 header.  Any request not preface by this header will be
dropped.</p>
<p>As a security measure, an optional list of trusted IP addresses may be
configured with <a class="reference internal" href="../files/records.config.en.html#proxy-config-http-proxy-protocol-allowlist" title="records.config"><code class="xref ts ts-cv docutils literal notranslate"><span class="pre">proxy.config.http.proxy_protocol_allowlist</span></code></a>.</p>
<blockquote>
<div><div class="admonition important">
<p class="admonition-title">Important</p>
<p>If the allowlist is configured, requests will only be accepted from these
IP addresses and must be prefaced with the PROXY v1 header.</p>
</div>
</div></blockquote>
<p>See <a class="reference internal" href="../files/records.config.en.html#proxy-config-http-insert-forwarded" title="records.config"><code class="xref ts ts-cv docutils literal notranslate"><span class="pre">proxy.config.http.insert_forwarded</span></code></a> for configuration information.
Detection of the PROXY protocol header is automatic.  If the PROXY header
precludes the request, it will automatically be parse and made available to the
Forwarded: request header sent to the origin server.</p>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>As an example, consider the following topology:</p>
<div class="figure align-center" id="id3">
<img alt="PROXY protocol transformed into a Forwarded: header" src="../../_images/proxy-protocol.png" />
<p class="caption"><span class="caption-text">PROXY protocol header flow</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>Without the PROXY protocol header, the client IP would only be reported
accurately to the Load Balancer.  Traffic Server would only see the connection from the
Load Balancer.  Similarly, the Web Server would only see the connection from
Traffic Server.  In the example above, if the client initiated a TLS connection, the Web
Server would see the connection originating from Traffic Server at <code class="docutils literal notranslate"><span class="pre">10.0.0.2</span></code>:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">Forwarded</span><span class="p">:</span> <span class="kr">for</span><span class="o">=</span><span class="mf">10.0.0.2</span><span class="p">;</span><span class="n">by</span><span class="o">=</span><span class="mf">10.0.0.1</span><span class="p">;</span><span class="n">proto</span><span class="o">=</span><span class="n">https</span><span class="p">;</span><span class="n">host</span><span class="o">=</span><span class="n">test000001</span><span class="p">.</span><span class="n">com</span>
</pre></div>
</div>
<p>If the Load Balancer has the Proxy Protocol enabled, requests sent through the
Load Balancer will be preceded with the PROXY header.  Traffic Server will detect the
PROXY header and transform that into the Forwarded: HTTP header if configured to
insert the Forwarded: header with the <code class="docutils literal notranslate"><span class="pre">for</span></code> parameter.  In the example above,
if the client initiated a TLS connection, the Web Server can use the Forwarded:
header to determine the TLS connection originated from the client at <code class="docutils literal notranslate"><span class="pre">192.168.1.100</span></code>:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="n">Forwarded</span><span class="p">:</span> <span class="kr">for</span><span class="o">=</span><span class="mf">192.168.2.100</span><span class="p">;</span><span class="n">by</span><span class="o">=</span><span class="mf">10.0.0.2</span><span class="p">;</span><span class="n">proto</span><span class="o">=</span><span class="n">https</span><span class="p">;</span><span class="n">host</span><span class="o">=</span><span class="n">test000001</span><span class="p">.</span><span class="n">com</span>
</pre></div>
</div>
<div class="section" id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt">The PROXY protocol Versions 1 &amp; 2</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc7239#page-6">Forwarded HTTP Extension</a></p></li>
</ul>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.en.html">Installing Traffic Server</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Proxy Cache Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interaction/index.en.html">Interacting with Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.en.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.en.html">Cache Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/index.en.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.en.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring/index.en.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuring-traffic-server.en.html">Configuring Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layer-4-routing.en.html">Layer 4 Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.en.html">Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files/index.en.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.en.html#audience">Audience</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-guide/index.en.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.en.html">Administrator’s Guide</a><ul>
  <li><a href="index.en.html">Proxy Cache Configuration</a><ul>
      <li>Previous: <a href="hierarchical-caching.en.html" title="previous chapter">Hierarchical Caching</a></li>
      <li>Next: <a href="../interaction/index.en.html" title="next chapter">Interacting with Traffic Server</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/configuration/proxy-protocol.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>