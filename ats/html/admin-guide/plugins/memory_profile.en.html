

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memory_profile Plugin &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Metalink Plugin" href="metalink.en.html" />
    <link rel="prev" title="Memcache Plugin" href="memcache.en.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="memory-profile-plugin">
<h1>Memory_profile Plugin<a class="headerlink" href="#memory-profile-plugin" title="Permalink to this headline">¶</a></h1>
<p>This plugin listens for plugin messages and invokes jemalloc control
operations.</p>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>Add the following line to <a class="reference internal" href="../files/plugin.config.en.html#std-configfile-plugin.config"><code class="xref std std-file docutils literal notranslate"><span class="pre">plugin.config</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">memory_profile</span><span class="o">.</span><span class="n">so</span>
</pre></div>
</div>
<p>In addition, Traffic Server must be able to read jemalloc configuration
information either through the <code class="docutils literal notranslate"><span class="pre">JEMALLOC_CONF</span></code> environment variable
or via the string sym linked to <code class="docutils literal notranslate"><span class="pre">/etc/malloc.conf</span></code>.</p>
<p>For example, if the string below is in <code class="docutils literal notranslate"><span class="pre">JEMALLOC_CONF</span></code> or in the sym link string, it
enables profiling and indicates that the memory dump prefix is <code class="docutils literal notranslate"><span class="pre">/tmp/jeprof</span></code>.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prof</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">prof_prefix</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">jeprof</span>
</pre></div>
</div>
<p>Details on configuration jemalloc options at <cite>&lt;http://jemalloc.net/jemalloc.3.html&gt;</cite>.
Changes to the configuration in <code class="docutils literal notranslate"><span class="pre">JEMALLOC_CONF</span></code> or <code class="docutils literal notranslate"><span class="pre">/etc/malloc.conf</span></code> require a process
restart to pick up.</p>
</div>
<div class="section" id="plugin-messages">
<h2>Plugin Messages<a class="headerlink" href="#plugin-messages" title="Permalink to this headline">¶</a></h2>
<p>The plugin responds to the following messages sent via traffic_ctl.</p>
<p>Message    Action
========== ===================================================================================
activate   Start jemalloc profiling. Useful if prof_active:false was in the configure string.</p>
<p>deactivate Stop jemalloc profiling.</p>
<p>dump       If profiling is enabled and active, it will generate a profile dump file.</p>
<p>stats      Print jemalloc statistics in traffic.out</p>
<p>The command below sends the stats message to the plugin causing the current statistics to be written to traffic.out:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_ctl</span> <span class="n">plugin</span> <span class="n">msg</span> <span class="n">memory_profile</span> <span class="n">stats</span>
</pre></div>
</div>
</div>
<div class="section" id="example-usage">
<h2>Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h2>
<p>If your run time configuration string is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prof</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="n">prof_prefix</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">jeprof</span><span class="p">:</span><span class="n">prof_active</span><span class="p">:</span><span class="n">false</span>
</pre></div>
</div>
<p>Traffic Server has started without profile sampling started.  Perhaps you didn’t want to profile the start up phase of Traffic Server.  To start
you need to send the activate message to the plugin:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_ctl</span> <span class="n">plugin</span> <span class="n">msg</span> <span class="n">memory_profile</span> <span class="n">activate</span>
</pre></div>
</div>
<p>If your run time configuration string does not indicate that the profiling is not started (e.g. the prof_active field is missing or set to true), you do not
need to send the activate message.</p>
<p>After waiting sometime for Traffic Server to gather some memory allocation data, you can send the dump message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_ctl</span> <span class="n">plugin</span> <span class="n">msg</span> <span class="n">memory_profile</span> <span class="n">dump</span>
</pre></div>
</div>
<p>This will cause a file containing information about the current state of the Traffic Server memory allocation to be dumped in a file prefixed
by the value of prof_prefix.  In this example, it would be something like <code class="docutils literal notranslate"><span class="pre">/tmp/jeprof.1234.0.m0.heap</span></code>, where 1234 is the process id
and 0 is a running counter indicating how many dumps have been performed on this process.  Each dump is independent of the others
and records the current stat of allocations since the profiling was activated.  The dump file can be processed by jeprof
to get text output or graphs. Details of how to use jeprof are in the man pages or <cite>&lt;https://manpages.debian.org/unstable/libjemalloc-dev/jeprof.1.en.html&gt;</cite>.</p>
<p>You may want to send the dump message periodically to analyze how the Traffic Server memory allocation changes over time.  This periodic dump can also be achieved by setting the
<code class="docutils literal notranslate"><span class="pre">lg_prof_interval</span></code> option in the run time configuration string.</p>
<p>If the profiling is taking a significant amount of processing time and affecting Traffic Server performance, send the deactivate message to turn off profiling.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_ctl</span> <span class="n">plugin</span> <span class="n">msg</span> <span class="n">memory_profile</span> <span class="n">deactivate</span>
</pre></div>
</div>
<p>Send the stats message to cause detailed jemalloc stats to be printed in traffic.out.  These stats represent activity since the start of the Traffic Server process.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_ctl</span> <span class="n">plugin</span> <span class="n">msg</span> <span class="n">memory_profile</span> <span class="n">stats</span>
</pre></div>
</div>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>Currently the plugin only functions for systems compiled against jemalloc.
Perhaps in the future, it can be augmented to interact with other memory
allocation systems.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.en.html">Installing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration/index.en.html">Proxy Cache Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interaction/index.en.html">Interacting with Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.en.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.en.html">Cache Storage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.en.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring/index.en.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuring-traffic-server.en.html">Configuring Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layer-4-routing.en.html">Layer 4 Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.en.html">Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files/index.en.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.en.html#audience">Audience</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-guide/index.en.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.en.html">Administrator’s Guide</a><ul>
  <li><a href="index.en.html">Plugins</a><ul>
      <li>Previous: <a href="memcache.en.html" title="previous chapter">Memcache Plugin</a></li>
      <li>Next: <a href="metalink.en.html" title="next chapter">Metalink Plugin</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/plugins/memory_profile.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>