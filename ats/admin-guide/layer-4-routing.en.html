

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Layer 4 Routing &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/override.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Performance Tuning" href="performance/index.en.html" />
    <link rel="prev" title="Configuring Traffic Server" href="configuring-traffic-server.en.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="layer-4-routing">
<span id="id1"></span><h1>Layer 4 Routing<a class="headerlink" href="#layer-4-routing" title="Permalink to this headline">¶</a></h1>
<p>Traffic Server supports a limited set of layer 4 routing options. In such use Traffic Server acts effectively as a
router, moving network data between two endpoints without modifying the data. The routing is
accomplished by examining the initial data from the inbound connection to decide the outbound
destination. The initial data is then sent to the destination and subsequently Traffic Server forwards all
data read on one connection to the other and vice versa.</p>
<div class="figure align-center">
<img alt="../_images/l4-basic-sequence.svg" src="../_images/l4-basic-sequence.svg" /></div>
<p>In this way it acts similarly to <a class="reference external" href="https://linux.die.net/man/1/nc">nc</a>.</p>
<p>The primary differences between different types of layer 4 routing is the mechanism by which Traffic Server
creates the outbound connection. This is described in detail in the type specific documentation.</p>
<div class="section" id="transparency">
<h2>Transparency<a class="headerlink" href="#transparency" title="Permalink to this headline">¶</a></h2>
<p>Transparency is in some sense layer 4 routing because the outbound connection is determined by
examining the destination address in the client TCP packets. This is discussed in detail
<a class="reference internal" href="configuration/transparent-proxy.en.html#transparent-proxy"><span class="std std-ref">elsewhere</span></a>.</p>
</div>
<div class="section" id="sni-routing">
<span id="id2"></span><h2>SNI Routing<a class="headerlink" href="#sni-routing" title="Permalink to this headline">¶</a></h2>
<p>Currently the only directly supported layer 4 routing (as of version 8.0) is SNI based routing. This
imposes the requirement on the traffic that the inbound connection must be TLS.</p>
<p>SNI routing is configured by <a class="reference internal" href="files/sni.yaml.en.html#std:configfile-sni.yaml"><code class="xref std std-file docutils literal notranslate"><span class="pre">sni.yaml</span></code></a>.</p>
<p>If SNI Routing is enabled the initial “<a class="reference external" href="https://tools.ietf.org/html/rfc5246#section-7.4.1.2">CLIENT HELLO</a>” data of an inbound TLS connection is
examined to extract the “<a class="reference external" href="https://tools.ietf.org/html/rfc3546#section-3.1">SNI</a>” value. This is
matched against the configuration data to select an action for the inbound connection. In this case
the option of interest is <code class="docutils literal notranslate"><span class="pre">tunnel_route</span></code>. If this is set then Traffic Server synthesizes an HTTP <code class="docutils literal notranslate"><span class="pre">CONNECT</span></code>
request to itself with the <code class="docutils literal notranslate"><span class="pre">tunnel_route</span></code> host and port as the upstream. That is, the inbound
connection is treated as if the user agent had sent a
<code class="docutils literal notranslate"><span class="pre">CONNECT</span></code> to the upstream and forwards the “<a class="reference external" href="https://tools.ietf.org/html/rfc5246#section-7.4.1.2">CLIENT HELLO</a>” to it. In addition to the method appearing
as <code class="docutils literal notranslate"><span class="pre">CONNECT</span></code>, be aware that logs printing the URL via the <code class="docutils literal notranslate"><span class="pre">&lt;%cquc&gt;</span></code> field format will show the
scheme in the URL as <code class="docutils literal notranslate"><span class="pre">tunnel</span></code>. The scheme as printed via <code class="docutils literal notranslate"><span class="pre">&lt;%cqus&gt;</span></code>, however, will show the
scheme used in the original client request.</p>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>Consider a Content Delivery Network (CDN) that has an edge layer of externally facing Traffic Server
instances. The goal is to enable external clients to connect to internal services and do their own
client certificate verification, possibly because distribution of private keys to the edge Traffic Server
instances is too difficult or too risky. To achieve this, the edge Traffic Server instances can be configured
to route inbound TLS connections with specific SNI values directly to the internal services without
TLS termination on the edge. This enables the edge to provide controlled external access to the
internal services without each internal service having to stand up its own edge. Note the services
do not require global routable addresses as long as the edge Traffic Server instances can route to the
services.</p>
<p>The basic set up is therefore</p>
<div class="figure align-center" id="id3">
<img alt="../_images/l4-example-cdn-layout.svg" src="../_images/l4-example-cdn-layout.svg" /><p class="caption"><span class="caption-text">A Client connects to an edge Traffic Server which forwards the connection to the internal Service.
The Client then negotiates TLS with the Service.</span></p>
</div>
<p>For the example, let us define two services inside the corporate network of Example, Inc.
<code class="docutils literal notranslate"><span class="pre">service-1</span></code> and <code class="docutils literal notranslate"><span class="pre">service-2</span></code>. <code class="docutils literal notranslate"><span class="pre">service-1</span></code> is on port 443 on host <code class="docutils literal notranslate"><span class="pre">app-server-29</span></code> while
<code class="docutils literal notranslate"><span class="pre">service-2</span></code> is on port 4443 on host <code class="docutils literal notranslate"><span class="pre">app-server-56</span></code>. The SNI routing set up for this would be</p>
<table border="1" class="docutils">
<colgroup>
<col width="41%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">SNI value</th>
<th class="head">Destination</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>service-1.example.com</td>
<td>app-server-29:443</td>
</tr>
<tr class="row-odd"><td>service-2.example.com</td>
<td>app-server-56:4443</td>
</tr>
</tbody>
</table>
<p>The <a class="reference internal" href="files/sni.yaml.en.html#std:configfile-sni.yaml"><code class="xref std std-file docutils literal notranslate"><span class="pre">sni.yaml</span></code></a> contents would be</p>
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sni</span><span class="p">:</span>
<span class="o">-</span> <span class="n">tunnel_route</span><span class="p">:</span> <span class="n">app</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mi">29</span><span class="p">:</span><span class="mi">443</span>
  <span class="n">fqdn</span><span class="p">:</span> <span class="n">service</span><span class="o">-</span><span class="mf">1.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="o">-</span> <span class="n">tunnel_route</span><span class="p">:</span> <span class="n">app</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mi">56</span><span class="p">:</span><span class="mi">4443</span>
  <span class="n">fqdn</span><span class="p">:</span> <span class="n">service</span><span class="o">-</span><span class="mf">2.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>In addition to this, in the <a class="reference internal" href="files/records.config.en.html#std:configfile-records.config"><code class="xref std std-file docutils literal notranslate"><span class="pre">records.config</span></code></a> file, edit <code class="docutils literal notranslate"><span class="pre">connect_ports</span></code> like so:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="files/records.config.en.html#proxy-config-http-connect-ports" title="records.config"><code class="xref ts ts-cv docutils literal notranslate"><span class="pre">proxy.config.http.connect_ports</span></code></a>: <code class="docutils literal notranslate"><span class="pre">443</span> <span class="pre">4443</span></code> to allow Traffic Server to connect
to the destination port</li>
</ul>
</div></blockquote>
<p>The sequence of network activity for a Client connecting to <code class="docutils literal notranslate"><span class="pre">service-2</span></code> is</p>
<div class="figure align-center">
<img alt="../_images/l4-sni-routing-seq.svg" src="../_images/l4-sni-routing-seq.svg" /></div>
<p>Note the destination for the outbound TCP connection and the HTTP <code class="docutils literal notranslate"><span class="pre">CONNECT</span></code> is the same. If this
is a problem (which it will be in general) a plugin is needed to change the URL in the <code class="docutils literal notranslate"><span class="pre">CONNECT</span></code>.
In this case the proxy request is available in the <a class="reference internal" href="../developer-guide/api/types/TSHttpHookID.en.html#c.TS_HTTP_TXN_START_HOOK" title="TS_HTTP_TXN_START_HOOK"><code class="xref c c-macro docutils literal notranslate"><span class="pre">TS_HTTP_TXN_START_HOOK</span></code></a> hook. This
cannot be done using remap because for a <code class="docutils literal notranslate"><span class="pre">CONNECT</span></code> there is no remap phase. Note that for a
tunneled connection like this, the only transaction hooks that will be triggered are
<a class="reference internal" href="../developer-guide/api/types/TSHttpHookID.en.html#c.TS_HTTP_TXN_START_HOOK" title="TS_HTTP_TXN_START_HOOK"><code class="xref c c-macro docutils literal notranslate"><span class="pre">TS_HTTP_TXN_START_HOOK</span></code></a> and <a class="reference internal" href="../developer-guide/api/types/TSHttpHookID.en.html#c.TS_HTTP_TXN_CLOSE_HOOK" title="TS_HTTP_TXN_CLOSE_HOOK"><code class="xref c c-macro docutils literal notranslate"><span class="pre">TS_HTTP_TXN_CLOSE_HOOK</span></code></a>. In addition, because Traffic Server
does not terminate (and therefore does not decrypt) the connection, it cannot be cached or served from
cache.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.en.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation/index.en.html">Installing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration/index.en.html">Proxy Cache Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="interaction/index.en.html">Interacting with Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="security/index.en.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="storage/index.en.html">Cache Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins/index.en.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="logging/index.en.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring/index.en.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring-traffic-server.en.html">Configuring Traffic Server</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Layer 4 Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance/index.en.html">Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="files/index.en.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="jsonrpc/index.en.html">JSONRPC API</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.en.html#audience">Audience</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.en.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.en.html">Administrator’s Guide</a><ul>
      <li>Previous: <a href="configuring-traffic-server.en.html" title="previous chapter">Configuring Traffic Server</a></li>
      <li>Next: <a href="performance/index.en.html" title="next chapter">Performance Tuning</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/admin-guide/layer-4-routing.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>