


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Lua Plugin &mdash; Apache Traffic Server 10.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Regex Remap Plugin" href="regex_remap.en.html" />
    <link rel="prev" title="Health Checks Plugin" href="healthchecks.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Apache Traffic Server
          

          
            
            <img src="../../_static/trans_logo_tm_380x69.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                10.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.en.html">Installing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration/index.en.html">Proxy Cache Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interaction/index.en.html">Interacting with Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.en.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.en.html">Cache Storage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Plugins</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.en.html#overview">Overview</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.en.html#stable-plugins">Stable plugins</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="s3_auth.en.html">AWS S3 Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="authproxy.en.html">AuthProxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="background_fetch.en.html">Background Fetch</a></li>
<li class="toctree-l4"><a class="reference internal" href="cachekey.en.html">Cache Key Manipulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="cache_promote.en.html">Cache Promotion Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="cache_range_requests.en.html">Cache Range Requests</a></li>
<li class="toctree-l4"><a class="reference internal" href="combo_handler.en.html">Combo Handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="conf_remap.en.html">Configuration Remap</a></li>
<li class="toctree-l4"><a class="reference internal" href="cookie_remap.en.html">Cookie Remap</a></li>
<li class="toctree-l4"><a class="reference internal" href="esi.en.html">ESI</a></li>
<li class="toctree-l4"><a class="reference internal" href="escalate.en.html">Escalate</a></li>
<li class="toctree-l4"><a class="reference internal" href="compress.en.html">Compress</a></li>
<li class="toctree-l4"><a class="reference internal" href="generator.en.html">Generator</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_rewrite.en.html">Header Rewrite</a></li>
<li class="toctree-l4"><a class="reference internal" href="healthchecks.en.html">Health Checks</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="regex_remap.en.html">Regex Remap</a></li>
<li class="toctree-l4"><a class="reference internal" href="regex_revalidate.en.html">Regex Revalidate</a></li>
<li class="toctree-l4"><a class="reference internal" href="remap_purge.en.html">Remap Purge</a></li>
<li class="toctree-l4"><a class="reference internal" href="stats_over_http.en.html">Stats over HTTP</a></li>
<li class="toctree-l4"><a class="reference internal" href="tcpinfo.en.html">TCPInfo</a></li>
<li class="toctree-l4"><a class="reference internal" href="xdebug.en.html">XDebug</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.en.html#experimental-plugins">Experimental plugins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.en.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring/index.en.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuring-traffic-server.en.html">Configuring Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layer-4-routing.en.html">Layer 4 Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.en.html">Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files/index.en.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.en.html#audience">Audience</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-guide/index.en.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apache Traffic Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.en.html">Administrator’s Guide</a> &raquo;</li>
        
          <li><a href="index.en.html">Plugins</a> &raquo;</li>
        
      <li>Lua Plugin</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/admin-guide/plugins/lua.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="lua-plugin">
<span id="admin-plugins-ts-lua"></span><h1>Lua Plugin<a class="headerlink" href="#lua-plugin" title="Permalink to this headline">¶</a></h1>
<p>This module embeds Lua, via the standard Lua 5.1 interpreter, into Apache Traffic Server™. With
this module, we can implement ATS plugin by writing Lua script instead of C
code. Lua code executed using this module can be 100% non-blocking because the
powerful Lua coroutines have been integrated into the ATS event model.</p>
<div class="section" id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h2>
<p><strong>test_hdr.lua</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Rhost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;rhost&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">req_host</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">Host</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;rhost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">req_host</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><strong>sethost.lua</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">HOSTNAME</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">function</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">argtb</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="c1">#argtb) &lt; 1 then</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">argtb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">..</span> <span class="s1">&#39; hostname parameter required!!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">end</span>
    <span class="n">HOSTNAME</span> <span class="o">=</span> <span class="n">argtb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HOSTNAME</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>This plugin is only built if LuaJIT (&gt;2.0.4) is installed. The configure option</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="k">with</span><span class="o">-</span><span class="n">luajit</span><span class="o">=&lt;</span><span class="n">path</span> <span class="n">to</span> <span class="n">luajit</span> <span class="n">prefix</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>can be used to specify a LuaJIT install. Otherwise, configure will use pkg-config to find a viable installation.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>This module acts as remap plugin of Traffic Server, so we should realize ‘do_remap’ or ‘do_os_response’ function in each
lua script. The path referencing a file with the lua script can be relative to the configuration directory or an absolute
path. We can write this in remap.config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">a</span><span class="o">.</span><span class="n">tbcdn</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">inner</span><span class="o">.</span><span class="n">tbcdn</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span> <span class="nd">@plugin</span><span class="o">=/</span><span class="n">XXX</span><span class="o">/</span><span class="n">tslua</span><span class="o">.</span><span class="n">so</span> <span class="nd">@pparam</span><span class="o">=/</span><span class="n">XXX</span><span class="o">/</span><span class="n">test_hdr</span><span class="o">.</span><span class="n">lua</span>
</pre></div>
</div>
<p>Sometimes we want to receive parameters and process them in the script, we should realize ‘__init__’ function in the lua
script, and we can write this in remap.config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span> <span class="nd">@plugin</span><span class="o">=/</span><span class="n">X</span><span class="o">/</span><span class="n">tslua</span><span class="o">.</span><span class="n">so</span> <span class="nd">@pparam</span><span class="o">=/</span><span class="n">X</span><span class="o">/</span><span class="n">sethost</span><span class="o">.</span><span class="n">lua</span> <span class="nd">@pparam</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">cn</span>
</pre></div>
</div>
<p>This module can also act as a global plugin of Traffic Server. In this case we should provide one of these functions in
each lua script:</p>
<ul class="simple">
<li><strong>‘do_global_txn_start’</strong></li>
<li><strong>‘do_global_txn_close’</strong></li>
<li><strong>‘do_global_os_dns’</strong></li>
<li><strong>‘do_global_pre_remap’</strong></li>
<li><strong>‘do_global_post_remap’</strong></li>
<li><strong>‘do_global_read_request’</strong></li>
<li><strong>‘do_global_send_request’</strong></li>
<li><strong>‘do_global_read_response’</strong></li>
<li><strong>‘do_global_send_response’</strong></li>
<li><strong>‘do_global_cache_lookup_complete’</strong></li>
<li><strong>‘do_global_read_cache’</strong></li>
</ul>
<p>We can write this in plugin.config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tslua</span><span class="o">.</span><span class="n">so</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">trafficserver</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">test_global_hdr</span><span class="o">.</span><span class="n">lua</span>
</pre></div>
</div>
<p>We can also define the number of Lua states to be used for the plugin. If it is used as global plugin, we can write the
following in plugin.config</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tslua</span><span class="o">.</span><span class="n">so</span> <span class="o">--</span><span class="n">states</span><span class="o">=</span><span class="mi">64</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">trafficserver</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">test_global_hdr</span><span class="o">.</span><span class="n">lua</span>
</pre></div>
</div>
<p>If it is used as remap plugin, we can write the following in remap.config to define the number of Lua states</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">a</span><span class="o">.</span><span class="n">tbcdn</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">inner</span><span class="o">.</span><span class="n">tbcdn</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span> <span class="nd">@plugin</span><span class="o">=/</span><span class="n">XXX</span><span class="o">/</span><span class="n">tslua</span><span class="o">.</span><span class="n">so</span> <span class="nd">@pparam</span><span class="o">=--</span><span class="n">states</span><span class="o">=</span><span class="mi">64</span> <span class="nd">@pparam</span><span class="o">=/</span><span class="n">XXX</span><span class="o">/</span><span class="n">test_hdr</span><span class="o">.</span><span class="n">lua</span>
</pre></div>
</div>
<p>The maximum number of allowed states is set to 256 which is also the
default states value.  The default value can be globally changed by
adding a configuration option to records.config.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONFIG</span> <span class="n">proxy</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">max_states</span> <span class="n">INT</span> <span class="mi">64</span>
</pre></div>
</div>
<p>Any per plugin –states value overrides this default value but must be less than or equal to this value.  This setting is not reloadable since it must be applied when all the lua states are first initialized.</p>
</div>
<div class="section" id="profiling">
<h2>Profiling<a class="headerlink" href="#profiling" title="Permalink to this headline">¶</a></h2>
<p>The lua module collects runtime statistics about the lua states, for remap
and global instances.  Per state stats are constantly maintained and are
made available through a lifecycle hook.  These may be accessed through:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_ctl</span> <span class="n">plugin</span> <span class="n">msg</span> <span class="n">ts_lua</span> <span class="n">stats_print</span>
</pre></div>
</div>
<p>Sample output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Feb</span>  <span class="mi">5</span> <span class="mi">19</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">15.072</span><span class="p">]</span> <span class="n">ts_lua</span> <span class="p">(</span><span class="n">remap</span><span class="p">)</span> <span class="nb">id</span><span class="p">:</span>    <span class="mi">0</span> <span class="n">gc_kb</span><span class="p">:</span>   <span class="mi">2508</span> <span class="n">gc_kb_max</span><span class="p">:</span>   <span class="mi">3491</span> <span class="n">threads</span><span class="p">:</span>  <span class="mi">417</span> <span class="n">threads_max</span><span class="p">:</span>  <span class="mi">438</span>
<span class="p">[</span><span class="n">Feb</span>  <span class="mi">5</span> <span class="mi">19</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">15.072</span><span class="p">]</span> <span class="n">ts_lua</span> <span class="p">(</span><span class="n">remap</span><span class="p">)</span> <span class="nb">id</span><span class="p">:</span>    <span class="mi">1</span> <span class="n">gc_kb</span><span class="p">:</span>   <span class="mi">1896</span> <span class="n">gc_kb_max</span><span class="p">:</span>   <span class="mi">3646</span> <span class="n">threads</span><span class="p">:</span>  <span class="mi">417</span> <span class="n">threads_max</span><span class="p">:</span>  <span class="mi">446</span>
<span class="p">[</span><span class="n">Feb</span>  <span class="mi">5</span> <span class="mi">19</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">15.072</span><span class="p">]</span> <span class="n">ts_lua</span> <span class="p">(</span><span class="n">remap</span><span class="p">)</span> <span class="nb">id</span><span class="p">:</span>    <span class="mi">2</span> <span class="n">gc_kb</span><span class="p">:</span>   <span class="mi">3376</span> <span class="n">gc_kb_max</span><span class="p">:</span>   <span class="mi">3740</span> <span class="n">threads</span><span class="p">:</span>  <span class="mi">417</span> <span class="n">threads_max</span><span class="p">:</span>  <span class="mi">442</span>
</pre></div>
</div>
<p>Max values may be reset at any time by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_ctl</span> <span class="n">plugin</span> <span class="n">msg</span> <span class="n">ts_lua</span> <span class="n">stats_reset</span>
</pre></div>
</div>
<p>Summary statistics are aggregated every 5s and are available as metrics.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traffic_ctl</span> <span class="n">metric</span> <span class="n">match</span> <span class="n">lua</span>
</pre></div>
</div>
<p>Sample output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plugin</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="k">global</span><span class="o">.</span><span class="n">states</span> <span class="mi">8</span>
<span class="n">plugin</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">gc_bytes_min</span> <span class="mi">4804608</span>
<span class="n">plugin</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">gc_bytes_mean</span> <span class="mi">5552537</span>
<span class="n">plugin</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">gc_bytes_max</span> <span class="mi">5779456</span>
<span class="n">plugin</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">threads_min</span> <span class="mi">31</span>
<span class="n">plugin</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">threads_mean</span> <span class="mi">44</span>
<span class="n">plugin</span><span class="o">.</span><span class="n">lua</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">threads_max</span> <span class="mi">146</span>
</pre></div>
</div>
</div>
<div class="section" id="ts-api-for-lua">
<h2>TS API for Lua<a class="headerlink" href="#ts-api-for-lua" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>The API is exposed to Lua in the form of one standard packages <code class="docutils literal notranslate"><span class="pre">ts</span></code>. This package is in the default global scope and
is always available within lua script. This package can be introduced into Lua like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s1">&#39;Hello World&#39;</span><span class="p">)</span>
<span class="n">ts</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-process-uuid">
<h3>ts.process.uuid<a class="headerlink" href="#ts-process-uuid" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.process.uuid()</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> This function returns the global process id.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">uuid</span><span class="p">()</span>  <span class="o">--</span> <span class="n">a436bae6</span><span class="o">-</span><span class="mi">082</span><span class="n">c</span><span class="o">-</span><span class="mi">4805</span><span class="o">-</span><span class="mi">86</span><span class="n">af</span><span class="o">-</span><span class="mi">78</span><span class="n">a5916c4a91</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-now">
<h3>ts.now<a class="headerlink" href="#ts-now" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.now()</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> This function returns the time since the Epoch (00:00:00 UTC, January 1, 1970), measured in seconds. It
includes milliseconds as the decimal part.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  <span class="o">--</span> <span class="mf">1395221053.123</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-debug">
<h3>ts.debug<a class="headerlink" href="#ts-debug" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.debug(TAG?, MESSAGE)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: Log the MESSAGE to traffic.out if debug TAG is enabled(the default TAG is <strong>ts_lua</strong>).</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;I am in do_remap now.&#39;</span><span class="p">)</span>
<span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;scw&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We should write this TAG in records.config(If TAG is missing, default TAG will be set):</p>
<p><code class="docutils literal notranslate"><span class="pre">CONFIG</span> <span class="pre">proxy.config.diags.debug.tags</span> <span class="pre">STRING</span> <span class="pre">TAG</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-error">
<h3>ts.error<a class="headerlink" href="#ts-error" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.error(MESSAGE)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: Log the MESSAGE to error.log</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;This is an error message&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-fatal">
<h3>ts.fatal<a class="headerlink" href="#ts-fatal" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.fatal(MESSAGE)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: Log the MESSAGE to error.log and shutdown Traffic Server</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s1">&#39;This is an fatal message&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-emergency">
<h3>ts.emergency<a class="headerlink" href="#ts-emergency" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.emergency(MESSAGE)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: Log the MESSAGE to error.log and shutdown Traffic Server</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">emergency</span><span class="p">(</span><span class="s1">&#39;This is an emergency message&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-status">
<h3>ts.status<a class="headerlink" href="#ts-status" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.status(MESSAGE)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: Log the MESSAGE to error.log as status</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-note">
<h3>ts.note<a class="headerlink" href="#ts-note" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.note(MESSAGE)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: Log the MESSAGE to error.log as note</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-warning">
<h3>ts.warning<a class="headerlink" href="#ts-warning" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.warning(MESSAGE)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: Log the MESSAGE to error.log as warning</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-alert">
<h3>ts.alert<a class="headerlink" href="#ts-alert" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.alert(MESSAGE)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: Log the MESSAGE to error.log as alert</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-basic-internal-information">
<h3>TS Basic Internal Information<a class="headerlink" href="#ts-basic-internal-information" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.get_install_dir()</em>
<strong>syntax:</strong> <em>ts.get_runtime_dir()</em>
<strong>syntax:</strong> <em>ts.get_config_dir()</em>
<strong>syntax:</strong> <em>ts.get_plugin_dir()</em>
<strong>syntax:</strong> <em>ts.get_traffic_server_version()</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description</strong>: get basic internal information for the TS instance, such as install directory, runtime directory,
config directory, plugin directory and version of ATS</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">config_dir</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_config_dir</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="remap-status-constants">
<h3>Remap status constants<a class="headerlink" href="#remap-status-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> do_remap</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_REMAP_NO_REMAP</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">TS_LUA_REMAP_DID_REMAP</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">TS_LUA_REMAP_NO_REMAP_STOP</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">TS_LUA_REMAP_DID_REMAP_STOP</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">TS_LUA_REMAP_ERROR</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>These constants are usually used as return value of do_remap function.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-to-url-host">
<h3>ts.remap.get_to_url_host<a class="headerlink" href="#ts-remap-get-to-url-host" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_to_url_host()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “to” host of the remap rule</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">to_host</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">remap</span><span class="o">.</span><span class="n">get_to_url_host</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">to_host</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-to-url-port">
<h3>ts.remap.get_to_url_port<a class="headerlink" href="#ts-remap-get-to-url-port" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_to_url_port()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “to” port of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-to-url-scheme">
<h3>ts.remap.get_to_url_scheme<a class="headerlink" href="#ts-remap-get-to-url-scheme" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_to_url_scheme()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “to” scheme of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-to-uri">
<h3>ts.remap.get_to_uri<a class="headerlink" href="#ts-remap-get-to-uri" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_to_uri()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “to” path of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-to-url">
<h3>ts.remap.get_to_url<a class="headerlink" href="#ts-remap-get-to-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_to_url()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “to” url of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-from-url-host">
<h3>ts.remap.get_from_url_host<a class="headerlink" href="#ts-remap-get-from-url-host" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_from_url_host()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “from” host of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-from-url-port">
<h3>ts.remap.get_from_url_port<a class="headerlink" href="#ts-remap-get-from-url-port" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_from_url_port()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “from” port of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-from-url-scheme">
<h3>ts.remap.get_from_url_scheme<a class="headerlink" href="#ts-remap-get-from-url-scheme" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_from_url_scheme()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “from” scheme of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-from-uri">
<h3>ts.remap.get_from_uri<a class="headerlink" href="#ts-remap-get-from-uri" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_from_uri()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “from” path of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-remap-get-from-url">
<h3>ts.remap.get_from_url<a class="headerlink" href="#ts-remap-get-from-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.remap.get_from_url()</em></p>
<p><strong>context:</strong> do_remap</p>
<p><strong>description</strong>: retrieve the “from” url of the remap rule</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-hook">
<h3>ts.hook<a class="headerlink" href="#ts-hook" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.hook(HOOK_POINT, FUNCTION)</em></p>
<p><strong>context:</strong> global or do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: Hooks are points in http transaction processing where we can step in and do some work. FUNCTION will be
called when the http transaction steps in to HOOK_POINT.</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SHE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;belief&#39;</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then the client will get the response like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">ATS</span><span class="o">/</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">0</span>
<span class="n">SHE</span><span class="p">:</span> <span class="n">belief</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">Keep</span><span class="o">-</span><span class="n">Alive</span>
<span class="o">...</span>
</pre></div>
</div>
<p>You can create global hook as well</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_some_work</span><span class="p">()</span>
   <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;do_some_work&#39;</span><span class="p">)</span>
   <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>

<span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_READ_REQUEST_HDR</span><span class="p">,</span> <span class="n">do_some_work</span><span class="p">)</span>
</pre></div>
</div>
<p>Or you can do it this way</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_READ_REQUEST_HDR</span><span class="p">,</span>
    <span class="n">function</span><span class="p">()</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;do_some_work&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Also the return value of the function will control how the transaction will be re-enabled. Return value of 0 will cause
the transaction to be re-enabled normally (TS_EVENT_HTTP_CONTINUE). Return value of 1 will be using TS_EVENT_HTTP_ERROR
instead.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="hook-point-constants">
<h3>Hook point constants<a class="headerlink" href="#hook-point-constants" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_HOOK_OS_DNS</span>
<span class="n">TS_LUA_HOOK_PRE_REMAP</span>
<span class="n">TS_LUA_HOOK_READ_CACHE_HDR</span>
<span class="n">TS_LUA_HOOK_TXN_CLOSE</span>
<span class="n">TS_LUA_HOOK_POST_REMAP</span>
<span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span>
<span class="n">TS_LUA_HOOK_READ_REQUEST_HDR</span>
<span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span>
<span class="n">TS_LUA_HOOK_READ_RESPONSE_HDR</span>
<span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span>
<span class="n">TS_LUA_REQUEST_TRANSFORM</span>
<span class="n">TS_LUA_RESPONSE_TRANSFORM</span>
</pre></div>
</div>
<p>These constants are usually used in ts.hook method call.</p>
<p>Additional Information:</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="24%" />
<col width="19%" />
<col width="18%" />
<col width="19%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Hook Point</th>
<th class="head">Lua Hook Point constant</th>
<th class="head">Hook function be
registered  within
do_remap() via
ts.hook()?</th>
<th class="head">Hook function be
registered within
do_os_response()
via ts.hook()?</th>
<th class="head">Hook function be
registered within
global context via
ts.hook()?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>TS_HTTP_TXN
_START_HOOK</td>
<td>TS_LUA_HOOK
_TXN_START</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-odd"><td>TS_HTTP_READ
_REQUEST_HDR_HOOK</td>
<td>TS_LUA_HOOK
_READ_REQUEST_HDR</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-even"><td>TS_HTTP_PRE
_REMAP_HOOK</td>
<td>TS_LUA_HOOK
_PRE_REMAP</td>
<td>NO</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-odd"><td>TS_HTTP_POST
_REMAP_HOOK</td>
<td>TS_LUA_HOOK
_POST_REMAP</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-even"><td>TS_HTTP_READ
_CACHE_HDR_HOOK</td>
<td>TS_LUA_HOOK
_READ_CACHE_HDR</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-odd"><td>TS_HTTP_OS
_DNS_HOOK</td>
<td>TS_LUA_HOOK
_OS_DNS</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-even"><td>TS_HTTP_CACHE
_LOOKUP_COMPLETE_HOOK</td>
<td>TS_LUA_HOOK
_CACHE_LOOKUP_COMPLETE</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-odd"><td>TS_HTTP_SEND
_REQUEST_HDR_HOOK</td>
<td>TS_LUA_HOOK
_SEND_REQUEST_HDR</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-even"><td>TS_HTTP_READ
_RESPONSE_HDR_HOOK</td>
<td>TS_LUA_HOOK
_READ_RESPONSE_HDR</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr class="row-odd"><td>TS_HTTP_SEND
_RESPONSE_HDR_HOOK</td>
<td>TS_LUA_HOOK
_SEND_RESPONSE_HDR</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr class="row-even"><td>TS_HTTP_REQUEST
_TRANSFORM_HOOK</td>
<td>TS_LUA_REQUEST_TRANSFORM</td>
<td>YES</td>
<td>NO</td>
<td>YES</td>
</tr>
<tr class="row-odd"><td>TS_HTTP_RESPONSE
_TRANSFORM_HOOK</td>
<td>TS_LUA_RESPONSE_TRANSFORM</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
</tr>
<tr class="row-even"><td>TS_HTTP_TXN
_CLOSE_HOOK</td>
<td>TS_LUA_HOOK_TXN_CLOSE</td>
<td>YES</td>
<td>YES</td>
<td>YES</td>
</tr>
</tbody>
</table>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-ctx">
<h3>ts.ctx<a class="headerlink" href="#ts-ctx" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.ctx[KEY] = VALUE</em></p>
<p><strong>syntax:</strong> <em>VALUE = ts.ctx[KEY]</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This table can be used to store per-request Lua context data and has a life time identical to the
current request.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;F-Header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;hdr&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;hdr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then the client will get the response like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">ATS</span><span class="o">/</span><span class="mf">3.2</span><span class="o">.</span><span class="mi">0</span>
<span class="n">F</span><span class="o">-</span><span class="n">Header</span><span class="p">:</span> <span class="n">foo</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">Keep</span><span class="o">-</span><span class="n">Alive</span>
<span class="o">...</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-method">
<h3>ts.client_request.get_method<a class="headerlink" href="#ts-client-request-get-method" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_method()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to retrieve the current client request’s method name. String like “GET” or
“POST” is returned.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-set-method">
<h3>ts.client_request.set_method<a class="headerlink" href="#ts-client-request-set-method" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.set_method()</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> This function can be used to override the current client request’s method with METHOD_NAME.</p>
</div>
<div class="section" id="ts-client-request-get-version">
<h3>ts.client_request.get_version<a class="headerlink" href="#ts-client-request-get-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ver = ts.client_request.get_version()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Return the http version string of the client request.</p>
<p>Current possible values are 1.0, 1.1, and 0.9.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-set-version">
<h3>ts.client_request.set_version<a class="headerlink" href="#ts-client-request-set-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.set_version(VERSION_STR)</em></p>
<p><strong>context:</strong> do_remap or do_global_* or later</p>
<p><strong>description:</strong> Set the http version of the client request with the VERSION_STR</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-uri">
<h3>ts.client_request.get_uri<a class="headerlink" href="#ts-client-request-get-uri" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_uri()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or later</p>
<p><strong>description:</strong> This function can be used to retrieve the client request’s path.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st?a=1</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">/st</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-set-uri">
<h3>ts.client_request.set_uri<a class="headerlink" href="#ts-client-request-set-uri" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.set_uri(PATH)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> This function can be used to override the client request’s path.</p>
<p>The PATH argument must be a Lua string and starts with <code class="docutils literal notranslate"><span class="pre">/</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-uri-args">
<h3>ts.client_request.get_uri_args<a class="headerlink" href="#ts-client-request-get-uri-args" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_uri_args()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to retrieve the client request’s query string.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">query</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri_args</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st?a=1&amp;b=2</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">a=1&amp;b=2</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-set-uri-args">
<h3>ts.client_request.set_uri_args<a class="headerlink" href="#ts-client-request-set-uri-args" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.set_uri_args(QUERY_STRING)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> This function can be used to override the client request’s query string.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">set_uri_args</span><span class="p">(</span><span class="s1">&#39;n=6&amp;p=7&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-uri-params">
<h3>ts.client_request.get_uri_params<a class="headerlink" href="#ts-client-request-get-uri-params" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_uri_params()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to retrieve the client request’s parameter string.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">query</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri_params</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st;a=1</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">a=1</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-set-uri-params">
<h3>ts.client_request.set_uri_params<a class="headerlink" href="#ts-client-request-set-uri-params" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.set_uri_params(PARAMETER_STRING)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> This function can be used to override the client request’s parameter string.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">set_uri_params</span><span class="p">(</span><span class="s1">&#39;n=6&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-url">
<h3>ts.client_request.get_url<a class="headerlink" href="#ts-client-request-get-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_url()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to retrieve the client request url (<a class="reference internal" href="../../developer-guide/api/functions/TSUrlStringGet.en.html#c.TSHttpTxnEffectiveUrlStringGet" title="TSHttpTxnEffectiveUrlStringGet"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSHttpTxnEffectiveUrlStringGet()</span></code></a>).</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">url</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_url</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-pristine-url">
<h3>ts.client_request.get_pristine_url<a class="headerlink" href="#ts-client-request-get-pristine-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_pristine_url()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to retrieve the client request pristine url.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">url</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_pristine_url</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st?a=1&amp;b=2</span> <span class="pre">HTTP/1.1\r\nHost:</span> <span class="pre">a.tbcdn.cn\r\n...</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">http://a.tbcdn.cn/st?a=1&amp;b=2</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-header-header">
<h3>ts.client_request.header.HEADER<a class="headerlink" href="#ts-client-request-header-header" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.header.HEADER = VALUE</em></p>
<p><strong>syntax:</strong> <em>ts.client_request.header[HEADER] = VALUE</em></p>
<p><strong>syntax:</strong> <em>VALUE = ts.client_request.header.HEADER</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Set, add to, clear or get the current client request’s HEADER.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">ua</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ua</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;a.tbcdn.cn&#39;</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st</span> <span class="pre">HTTP/1.1\r\nHost:</span> <span class="pre">b.tb.cn\r\nUser-Agent:</span> <span class="pre">Mozilla/5.0\r\n...</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">Mozilla/5.0</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-headers">
<h3>ts.client_request.get_headers<a class="headerlink" href="#ts-client-request-get-headers" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_headers()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Returns a Lua table holding all the headers for the current client request.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">hdrs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">hdrs</span><span class="p">)</span> <span class="n">do</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">k</span><span class="o">..</span><span class="s1">&#39;: &#39;</span><span class="o">..</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st</span> <span class="pre">HTTP/1.1\r\nHost:</span> <span class="pre">b.tb.cn\r\nUser-Aget:</span> <span class="pre">Mozilla/5.0\r\nAccept:</span> <span class="pre">*/*</span></code> will yield the output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">cn</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-client-addr-get-addr">
<h3>ts.client_request.client_addr.get_addr<a class="headerlink" href="#ts-client-request-client-addr-get-addr" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.client_addr.get_addr()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: This function can be used to get socket address of the client.</p>
<p>The ts.client_request.client_addr.get_addr function returns three values, ip is a string, port and family is number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">client_addr</span><span class="o">.</span><span class="n">get_addr</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>               <span class="o">--</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">231.17</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>             <span class="o">--</span> <span class="mi">17786</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">family</span><span class="p">)</span>           <span class="o">--</span> <span class="mi">2</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-client-addr-get-incoming-port">
<h3>ts.client_request.client_addr.get_incoming_port<a class="headerlink" href="#ts-client-request-client-addr-get-incoming-port" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.client_addr.get_incoming_port()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: This function can be used to get incoming port of the request.</p>
<p>The ts.client_request.client_addr.get_incoming_port function returns incoming port as number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">client_addr</span><span class="o">.</span><span class="n">get_incoming_port</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>             <span class="o">--</span> <span class="mi">80</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-url-host">
<h3>ts.client_request.get_url_host<a class="headerlink" href="#ts-client-request-get-url-host" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>host = ts.client_request.get_url_host()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Return the <code class="docutils literal notranslate"><span class="pre">host</span></code> field of the request url.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">url_host</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_url_host</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">url_host</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/liuyurou.txt</span> <span class="pre">HTTP/1.1\r\nHost:</span> <span class="pre">192.168.231.129:8080\r\n...</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">192.168.231.129</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-set-url-host">
<h3>ts.client_request.set_url_host<a class="headerlink" href="#ts-client-request-set-url-host" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.set_url_host(str)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> Set <code class="docutils literal notranslate"><span class="pre">host</span></code> field of the request url with <code class="docutils literal notranslate"><span class="pre">str</span></code>. This function is used to change the address of the
origin server, and we should return TS_LUA_REMAP_DID_REMAP(_STOP) in do_remap.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">set_url_host</span><span class="p">(</span><span class="s1">&#39;192.168.231.130&#39;</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">set_url_port</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">set_url_scheme</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">TS_LUA_REMAP_DID_REMAP</span>
<span class="n">end</span>
</pre></div>
</div>
<p>remap.config like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">231.129</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">231.129</span><span class="p">:</span><span class="mi">9999</span><span class="o">/</span>
</pre></div>
</div>
<p>Then server request will connect to <code class="docutils literal notranslate"><span class="pre">192.168.231.130:80</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-url-port">
<h3>ts.client_request.get_url_port<a class="headerlink" href="#ts-client-request-get-url-port" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>port = ts.client_request.get_url_port()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Returns the <code class="docutils literal notranslate"><span class="pre">port</span></code> field of the request url as a Lua number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">url_port</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_url_port</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">url_port</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/liuyurou.txt</span> <span class="pre">HTTP/1.1\r\nHost:</span> <span class="pre">192.168.231.129:8080\r\n...</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">8080</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-set-url-port">
<h3>ts.client_request.set_url_port<a class="headerlink" href="#ts-client-request-set-url-port" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.set_url_port(NUMBER)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> Set <code class="docutils literal notranslate"><span class="pre">port</span></code> field of the request url with <code class="docutils literal notranslate"><span class="pre">NUMBER</span></code>. This function is used to change the address of
the origin server, and we should return TS_LUA_REMAP_DID_REMAP(_STOP) in do_remap.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-url-scheme">
<h3>ts.client_request.get_url_scheme<a class="headerlink" href="#ts-client-request-get-url-scheme" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>scheme = ts.client_request.get_url_scheme()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Return the <code class="docutils literal notranslate"><span class="pre">scheme</span></code> field of the request url.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">url_scheme</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_url_scheme</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">url_scheme</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/liuyurou.txt</span> <span class="pre">HTTP/1.1\r\nHost:</span> <span class="pre">192.168.231.129:8080\r\n...</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">http</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-set-url-scheme">
<h3>ts.client_request.set_url_scheme<a class="headerlink" href="#ts-client-request-set-url-scheme" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.set_url_scheme(str)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> Set <code class="docutils literal notranslate"><span class="pre">scheme</span></code> field of the request url with <code class="docutils literal notranslate"><span class="pre">str</span></code>. This function is used to change the scheme of the
server request, and we should return TS_LUA_REMAP_DID_REMAP(_STOP) in do_remap.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-ssl-reused">
<h3>ts.client_request.get_ssl_reused<a class="headerlink" href="#ts-client-request-get-ssl-reused" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_ssl_reused()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: This function can be used to know if the SSL session has been reused (1) or not (0)</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">ssl_reused</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_ssl_reused</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ssl_reused</span><span class="p">)</span>             <span class="o">--</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-ssl-protocol">
<h3>ts.client_request.get_ssl_protocol<a class="headerlink" href="#ts-client-request-get-ssl-protocol" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_ssl_protocol()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: This function can be used to get the SSL protocol used to communicate with the client</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">ssl_protocol</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_ssl_protocol</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ssl_protocol</span><span class="p">)</span>             <span class="o">--</span> <span class="n">TLSv1</span><span class="o">.</span><span class="mi">2</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-ssl-cipher">
<h3>ts.client_request.get_ssl_cipher<a class="headerlink" href="#ts-client-request-get-ssl-cipher" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_ssl_cipher()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: This function can be used to get the SSL cipher used to communicate with the client</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">ssl_cipher</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_ssl_cipher</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ssl_cipher</span><span class="p">)</span>             <span class="o">--</span> <span class="n">ECDHE</span><span class="o">-</span><span class="n">ECDSA</span><span class="o">-</span><span class="n">AES256</span><span class="o">-</span><span class="n">GCM</span><span class="o">-</span><span class="n">SHA384</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-request-get-ssl-curve">
<h3>ts.client_request.get_ssl_curve<a class="headerlink" href="#ts-client-request-get-ssl-curve" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_request.get_ssl_curve()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: This function can be used to get the SSL Elliptic curve used to communicate with the client</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">ssl_curve</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_ssl_curve</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ssl_curve</span><span class="p">)</span>             <span class="o">--</span> <span class="n">X25519</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-set-cache-url">
<h3>ts.http.set_cache_url<a class="headerlink" href="#ts-http-set-cache-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.set_cache_url(KEY_URL)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> This function can be used to modify the cache key for the client request.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">set_cache_url</span><span class="p">(</span><span class="s1">&#39;http://a.tbcdn.cn/foo&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-cache-lookup-url">
<h3>ts.http.get_cache_lookup_url<a class="headerlink" href="#ts-http-get-cache-lookup-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_cache_lookup_url()</em></p>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<p><strong>description:</strong> This function can be used to get the cache lookup url for the client request.</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">set_cache_lookup_url</span><span class="p">(</span><span class="s1">&#39;http://bad.com/bad.html&#39;</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_cache_lookup_url</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-set-cache-lookup-url">
<h3>ts.http.set_cache_lookup_url<a class="headerlink" href="#ts-http-set-cache-lookup-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.set_cache_lookup_url()</em></p>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<p><strong>description:</strong> This function can be used to set the cache lookup url for the client request.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-redo-cache-lookup">
<h3>ts.http.redo_cache_lookup<a class="headerlink" href="#ts-http-redo-cache-lookup" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.redo_cache_lookup()</em></p>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<p><strong>description:</strong> This function can be used to redo cache lookup with a different url.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-parent-proxy">
<h3>ts.http.get_parent_proxy<a class="headerlink" href="#ts-http-get-parent-proxy" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_parent_proxy()</em></p>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<p><strong>description:</strong> This function can be used to get the parent proxy host and port.</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">set_parent_proxy</span><span class="p">(</span><span class="s1">&#39;test1.test.com&#39;</span><span class="p">,</span> <span class="mi">1111</span><span class="p">)</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_parent_proxy</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-set-parent-proxy">
<h3>ts.http.set_parent_proxy<a class="headerlink" href="#ts-http-set-parent-proxy" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.set_parent_proxy()</em></p>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<p><strong>description:</strong> This function can be used to set the parent proxy host and name.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-parent-selection-url">
<h3>ts.http.get_parent_selection_url<a class="headerlink" href="#ts-http-get-parent-selection-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_parent_selection_url()</em></p>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<p><strong>description:</strong> This function can be used to get the parent selection url for the client request.</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">set_parent_selection_url</span><span class="p">(</span><span class="s1">&#39;http://bad.com/bad.html&#39;</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_parent_selection_url</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-set-parent-selection-url">
<h3>ts.http.set_parent_selection_url<a class="headerlink" href="#ts-http-set-parent-selection-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.set_parent_selection_url()</em></p>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<p><strong>description:</strong> This function can be used to set the parent selection url for the client request.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-set-server-resp-no-store">
<h3>ts.http.set_server_resp_no_store<a class="headerlink" href="#ts-http-set-server-resp-no-store" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.set_server_resp_no_store(status)</em></p>
<p><strong>context:</strong> do_global_read_response</p>
<p><strong>description:</strong> This function can be used to signal ATS to not store the response in cache</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">set_server_resp_no_store</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-set-resp">
<h3>ts.http.set_resp<a class="headerlink" href="#ts-http-set-resp" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.set_resp(CODE, BODY)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> This function can be used to set response for the client with the CODE status and BODY string.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">set_resp</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s2">&quot;Document access failed :)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the response like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">403</span> <span class="n">Forbidden</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">20</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">06</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">43</span> <span class="n">GMT</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">ATS</span><span class="o">/</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="n">no</span><span class="o">-</span><span class="n">store</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Language</span><span class="p">:</span> <span class="n">en</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">27</span>

<span class="n">Document</span> <span class="n">access</span> <span class="n">failed</span> <span class="p">:)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-cache-lookup-status">
<h3>ts.http.get_cache_lookup_status<a class="headerlink" href="#ts-http-get-cache-lookup-status" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_cache_lookup_status()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE hook point</p>
<p><strong>description:</strong> This function can be used to get cache lookup status.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">cache_status</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_cache_lookup_status</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cache_status</span> <span class="o">==</span> <span class="n">TS_LUA_CACHE_LOOKUP_HIT_FRESH</span> <span class="n">then</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;hit&#39;</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;not hit&#39;</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-set-cache-lookup-status">
<h3>ts.http.set_cache_lookup_status<a class="headerlink" href="#ts-http-set-cache-lookup-status" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.set_cache_lookup_status()</em></p>
<p><strong>context:</strong> function after TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE hook point</p>
<p><strong>description:</strong> This function can be used to set cache lookup status.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">cache_status</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_cache_lookup_status</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cache_status</span> <span class="o">==</span> <span class="n">TS_LUA_CACHE_LOOKUP_HIT_FRESH</span> <span class="n">then</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;hit&#39;</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;not hit&#39;</span><span class="p">)</span>
    <span class="n">end</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">set_cache_lookup_status</span><span class="p">(</span><span class="n">TS_LUA_CACHE_LOOKUP_MISS</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="http-cache-lookup-status-constants">
<h3>Http cache lookup status constants<a class="headerlink" href="#http-cache-lookup-status-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> global</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_CACHE_LOOKUP_MISS</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">TS_LUA_CACHE_LOOKUP_HIT_STALE</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">TS_LUA_CACHE_LOOKUP_HIT_FRESH</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">TS_LUA_CACHE_LOOKUP_SKIPPED</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-cached-response-get-status">
<h3>ts.cached_response.get_status<a class="headerlink" href="#ts-cached-response-get-status" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>status = ts.cached_response.get_status()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE hook point or later</p>
<p><strong>description:</strong> This function can be used to retrieve the status code of the cached response. A Lua number will be
returned.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">cache_status</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_cache_lookup_status</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cache_status</span> <span class="o">==</span> <span class="n">TS_LUA_CACHE_LOOKUP_HIT_FRESH</span> <span class="n">then</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">cached_response</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>         <span class="o">--</span> <span class="mi">200</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-cached-response-get-version">
<h3>ts.cached_response.get_version<a class="headerlink" href="#ts-cached-response-get-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ver = ts.cached_response.get_version()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE hook point or later</p>
<p><strong>description:</strong> Return the http version string of the cached response.</p>
<p>Current possible values are 1.0, 1.1, and 0.9.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-cached-response-header-header">
<h3>ts.cached_response.header.HEADER<a class="headerlink" href="#ts-cached-response-header-header" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>VALUE = ts.cached_response.header.HEADER</em></p>
<p><strong>syntax:</strong> <em>VALUE = ts.cached_response.header[HEADER]</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE hook point or later</p>
<p><strong>description:</strong> get the current cached response’s HEADER.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_cache_lookup_status</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">TS_LUA_CACHE_LOOKUP_HIT_FRESH</span> <span class="n">then</span>
        <span class="n">local</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">cached_response</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>         <span class="o">--</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-cached-response-get-headers">
<h3>ts.cached_response.get_headers<a class="headerlink" href="#ts-cached-response-get-headers" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.cached_response.get_headers()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE hook point or later</p>
<p><strong>description:</strong> Returns a Lua table holding all the headers for the current cached response.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_cache_lookup_status</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">TS_LUA_CACHE_LOOKUP_HIT_FRESH</span> <span class="n">then</span>
        <span class="n">hdrs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">cached_response</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">hdrs</span><span class="p">)</span> <span class="n">do</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">k</span><span class="o">..</span><span class="s1">&#39;: &#39;</span><span class="o">..</span><span class="n">v</span><span class="p">)</span>
        <span class="n">end</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Thu</span><span class="p">,</span> <span class="mi">20</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">06</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">20</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="nb">max</span><span class="o">-</span><span class="n">age</span><span class="o">=</span><span class="mi">864000</span>
<span class="n">Last</span><span class="o">-</span><span class="n">Modified</span><span class="p">:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">19</span> <span class="n">May</span> <span class="mi">2013</span> <span class="mi">13</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">01</span> <span class="n">GMT</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Ranges</span><span class="p">:</span> <span class="nb">bytes</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">15</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">ATS</span><span class="o">/</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-get-uri">
<h3>ts.server_request.get_uri<a class="headerlink" href="#ts-server-request-get-uri" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.get_uri()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description:</strong> This function can be used to retrieve the server request’s path.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/am.txt?a=1</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">/am.txt</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-set-uri">
<h3>ts.server_request.set_uri<a class="headerlink" href="#ts-server-request-set-uri" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.set_uri(PATH)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point</p>
<p><strong>description:</strong> This function can be used to override the server request’s path.</p>
<p>The PATH argument must be a Lua string and starts with <code class="docutils literal notranslate"><span class="pre">/</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-get-uri-args">
<h3>ts.server_request.get_uri_args<a class="headerlink" href="#ts-server-request-get-uri-args" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.get_uri_args()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description:</strong> This function can be used to retrieve the server request’s query string.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">query</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">get_uri_args</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st?a=1&amp;b=2</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">a=1&amp;b=2</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-set-uri-args">
<h3>ts.server_request.set_uri_args<a class="headerlink" href="#ts-server-request-set-uri-args" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.set_uri_args(QUERY_STRING)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point</p>
<p><strong>description:</strong> This function can be used to override the server request’s query string.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">set_uri_args</span><span class="p">(</span><span class="s1">&#39;n=6&amp;p=7&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-get-uri-params">
<h3>ts.server_request.get_uri_params<a class="headerlink" href="#ts-server-request-get-uri-params" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.get_uri_params()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description:</strong> This function can be used to retrieve the server request’s parameter string.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">query</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">get_uri_params</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st;a=1</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">a=1</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-set-uri-params">
<h3>ts.server_request.set_uri_params<a class="headerlink" href="#ts-server-request-set-uri-params" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.set_uri_params(PARAMETER_STRING)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point</p>
<p><strong>description:</strong> This function can be used to override the server request’s parameter string.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">set_uri_params</span><span class="p">(</span><span class="s1">&#39;n=6&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-header-header">
<h3>ts.server_request.header.HEADER<a class="headerlink" href="#ts-server-request-header-header" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.header.HEADER = VALUE</em></p>
<p><strong>syntax:</strong> <em>ts.server_request.header[HEADER] = VALUE</em></p>
<p><strong>syntax:</strong> <em>VALUE = ts.server_request.header.HEADER</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description:</strong> Set, add to, clear or get the current server request’s HEADER.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">ua</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ua</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/st</span> <span class="pre">HTTP/1.1\r\nHost:</span> <span class="pre">b.tb.cn\r\nUser-Agent:</span> <span class="pre">Mozilla/5.0\r\n...</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">Mozilla/5.0</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-get-headers">
<h3>ts.server_request.get_headers<a class="headerlink" href="#ts-server-request-get-headers" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.get_headers()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description:</strong> Returns a Lua table holding all the headers for the current server request.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">hdrs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">cached_response</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">hdrs</span><span class="p">)</span> <span class="n">do</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">k</span><span class="o">..</span><span class="s1">&#39;: &#39;</span><span class="o">..</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">cn</span>
<span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="p">:</span> <span class="n">curl</span><span class="o">/</span><span class="mf">7.19</span><span class="o">.</span><span class="mi">7</span>
<span class="n">Accept</span><span class="p">:</span> <span class="o">*/*</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-server-addr-set-addr">
<h3>ts.server_request.server_addr.set_addr<a class="headerlink" href="#ts-server-request-server-addr-set-addr" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.server_addr.set_addr()</em></p>
<p><strong>context:</strong> no later than function &#64; TS_LUA_HOOK_OS_DNS hook point</p>
<p><strong>description</strong>: This function can be used to set socket address of the origin server.</p>
<p>The ts.server_request.server_addr.set_addr function requires three inputs, ip is a string, port and family is number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">server_addr</span><span class="o">.</span><span class="n">set_addr</span><span class="p">(</span><span class="s2">&quot;192.168.231.17&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">TS_LUA_AF_INET</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="socket-address-family">
<h3>Socket address family<a class="headerlink" href="#socket-address-family" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> global</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_AF_INET</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">TS_LUA_AF_INET6</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-server-addr-get-addr">
<h3>ts.server_request.server_addr.get_addr<a class="headerlink" href="#ts-server-request-server-addr-get-addr" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.server_addr.get_addr()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description</strong>: This function can be used to get socket address of the origin server.</p>
<p>The ts.server_request.server_addr.get_addr function returns three values, ip is a string, port and family is number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_send_request</span><span class="p">()</span>
    <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">server_addr</span><span class="o">.</span><span class="n">get_addr</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>               <span class="o">--</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">231.17</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>             <span class="o">--</span> <span class="mi">80</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">family</span><span class="p">)</span>           <span class="o">--</span> <span class="mi">2</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-server-addr-get-nexthop-addr">
<h3>ts.server_request.server_addr.get_nexthop_addr<a class="headerlink" href="#ts-server-request-server-addr-get-nexthop-addr" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.server_addr.get_nexthop_addr()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description</strong>: This function can be used to get socket address of the next hop to the origin server.</p>
<p>The ts.server_request.server_addr.get_nexthop_addr function returns three values, ip is a string, port and family is number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_send_request</span><span class="p">()</span>
    <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">family</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">server_addr</span><span class="o">.</span><span class="n">get_nexthop_addr</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>               <span class="o">--</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">231.17</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>             <span class="o">--</span> <span class="mi">80</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">family</span><span class="p">)</span>           <span class="o">--</span> <span class="mi">2</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-server-addr-get-nexthop-name">
<h3>ts.server_request.server_addr.get_nexthop_name<a class="headerlink" href="#ts-server-request-server-addr-get-nexthop-name" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.server_addr.get_nexthop_name()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description</strong>: This function can be used to get the host name of the next hop to the origin server.</p>
<p>The ts.server_request.server_addr.get_nexthop_name function returns the name as a string.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_send_request</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">server_addr</span><span class="o">.</span><span class="n">get_nexthop_name</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>             <span class="o">--</span> <span class="n">test</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference external" href="#ts-lua-plugin">TOP</a></p>
</div>
<div class="section" id="ts-sha256">
<h3>ts.sha256<a class="headerlink" href="#ts-sha256" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.sha256(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the hexadecimal representation of the SHA-256 digest of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference external" href="#ts-lua-plugin">TOP</a></p>
</div>
<div class="section" id="ts-sha256-bin">
<h3>ts.sha256_bin<a class="headerlink" href="#ts-sha256-bin" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.sha256_bin(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the binary form of the SHA-256 digest of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="nb">bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">sha256_bin</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference external" href="#ts-lua-plugin">TOP</a></p>
</div>
<div class="section" id="ts-hmac-md5">
<h3>ts.hmac_md5<a class="headerlink" href="#ts-hmac-md5" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.hmac_md5(key, str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the hexadecimal representation of the HMAC of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>The message digest function used is MD5.</p>
<p>The key value used is contained in the <code class="docutils literal notranslate"><span class="pre">key</span></code> argument. This should be a hexadecimal representation of the key value.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;012345&quot;</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">hmac_md5</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference external" href="#ts-lua-plugin">TOP</a></p>
</div>
<div class="section" id="ts-hmac-sha1">
<h3>ts.hmac_sha1<a class="headerlink" href="#ts-hmac-sha1" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.hmac_sha1(key, str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the hexadecimal representation of the HMAC of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>The message digest function used is SHA-1.</p>
<p>The key value used is contained in the <code class="docutils literal notranslate"><span class="pre">key</span></code> argument. This should be a hexadecimal representation of the key value.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;012345&quot;</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">hmac_sha1</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference external" href="#ts-lua-plugin">TOP</a></p>
</div>
<div class="section" id="ts-hmac-sha256">
<h3>ts.hmac_sha256<a class="headerlink" href="#ts-hmac-sha256" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.hmac_sha256(key, str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the hexadecimal representation of the HMAC of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>The message digest function used is SHA-256.</p>
<p>The key value used is contained in the <code class="docutils literal notranslate"><span class="pre">key</span></code> argument. This should be a hexadecimal representation of the key value.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;012345&quot;</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">hmac_sha256</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference external" href="#ts-lua-plugin">TOP</a></p>
</div>
<div class="section" id="ts-server-request-server-addr-get-ip">
<h3>ts.server_request.server_addr.get_ip<a class="headerlink" href="#ts-server-request-server-addr-get-ip" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.server_addr.get_ip()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description</strong>: This function can be used to get ip address of the origin server.</p>
<p>The ts.server_request.server_addr.get_ip function returns ip as a string.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_send_request</span><span class="p">()</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">server_addr</span><span class="o">.</span><span class="n">get_ip</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>               <span class="o">--</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">231.17</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-server-addr-get-port">
<h3>ts.server_request.server_addr.get_port<a class="headerlink" href="#ts-server-request-server-addr-get-port" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.server_addr.get_port()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description</strong>: This function can be used to get port of the origin server.</p>
<p>The ts.server_request.server_addr.get_port function returns port as number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_send_request</span><span class="p">()</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">server_addr</span><span class="o">.</span><span class="n">get_port</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>             <span class="o">--</span> <span class="mi">80</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-server-addr-get-outgoing-port">
<h3>ts.server_request.server_addr.get_outgoing_port<a class="headerlink" href="#ts-server-request-server-addr-get-outgoing-port" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.server_addr.get_outgoing_port()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description</strong>: This function can be used to get outgoing port to the origin server.</p>
<p>The ts.server_request.server_addr.get_outgoing_port function returns outgoing port as number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_send_request</span><span class="p">()</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">server_addr</span><span class="o">.</span><span class="n">get_outgoing_port</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>             <span class="o">--</span> <span class="mi">50880</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-server-addr-set-outgoing-addr">
<h3>ts.server_request.server_addr.set_outgoing_addr<a class="headerlink" href="#ts-server-request-server-addr-set-outgoing-addr" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.server_addr.set_outgoing_addr()</em></p>
<p><strong>context:</strong> earlier than or inside function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point</p>
<p><strong>description</strong>: This function can be used to set outgoing socket address for the request to origin.</p>
<p>The ts.server_request.server_addr.set_outgoing_addr function requires three inputs, ip is a string, port and family is number.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_send_request</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">server_addr</span><span class="o">.</span><span class="n">set_outgoing_addr</span><span class="p">(</span><span class="s2">&quot;192.168.231.17&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="n">TS_LUA_AF_INET</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-get-url-host">
<h3>ts.server_request.get_url_host<a class="headerlink" href="#ts-server-request-get-url-host" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>host = ts.server_request.get_url_host()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point</p>
<p><strong>description:</strong> Return the <code class="docutils literal notranslate"><span class="pre">host</span></code> field of the request url.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">url_host</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">get_url_host</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">url_host</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">http://abc.com/p2/a.txt</span> <span class="pre">HTTP/1.1</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">abc.com</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-set-url-host">
<h3>ts.server_request.set_url_host<a class="headerlink" href="#ts-server-request-set-url-host" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.set_url_host(str)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point</p>
<p><strong>description:</strong> Set <code class="docutils literal notranslate"><span class="pre">host</span></code> field of the request url with <code class="docutils literal notranslate"><span class="pre">str</span></code>. This function is used to change the host name in the GET request to next tier</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">set_url_host</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">set_url_scheme</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>The GET request like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>+++++++++ Proxy&#39;s Request +++++++++
– State Machine Id: 5593
GET http://origin.com/dir1/a.txt HTTP/1.1
User-Agent: curl/7.29.0
Host: abc.com
Accept: /
Client-ip: 135.xx.xx.xx
X-Forwarded-For: 135.xx.xx.xx
</pre></div>
</div>
<p>Will be changed to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>+++++++++ Proxy&#39;s Request +++++++++
– State Machine Id: 5593
GET /dir1/a.txt HTTP/1.1
User-Agent: curl/7.29.0
Host: abc.com
Accept: /
Client-ip: 135.xx.xx.xx
X-Forwarded-For: 135.xx.xx.xx
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-get-url-scheme">
<h3>ts.server_request.get_url_scheme<a class="headerlink" href="#ts-server-request-get-url-scheme" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>scheme = ts.server_request.get_url_scheme()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point</p>
<p><strong>description:</strong> Return the <code class="docutils literal notranslate"><span class="pre">scheme</span></code> field of the request url.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">url_scheme</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">get_url_scheme</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">url_host</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/liuyurou.txt</span> <span class="pre">HTTP/1.1\r\nHost:</span> <span class="pre">192.168.231.129:8080\r\n...</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">http</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-set-url-scheme">
<h3>ts.server_request.set_url_scheme<a class="headerlink" href="#ts-server-request-set-url-scheme" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.set_url_scheme(str)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point</p>
<p><strong>description:</strong> Set <code class="docutils literal notranslate"><span class="pre">scheme</span></code> field of the request url with <code class="docutils literal notranslate"><span class="pre">str</span></code>. This function is used to change the scheme of the server request.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-get-method">
<h3>ts.server_request.get_method<a class="headerlink" href="#ts-server-request-get-method" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.get_method()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description:</strong> This function can be used to retrieve the current server request’s method name. String like “GET” or “POST” is returned.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">method</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">get_method</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then <code class="docutils literal notranslate"><span class="pre">HEAD</span> <span class="pre">/</span></code> will yield the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">HEAD</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-set-method">
<h3>ts.server_request.set_method<a class="headerlink" href="#ts-server-request-set-method" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.set_method()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later</p>
<p><strong>description:</strong> This function can be used to override the current server request’s method with METHOD_NAME.</p>
<dl class="docutils">
<dt>::</dt>
<dd>ts.server_request.set_method(‘HEAD’)</dd>
</dl>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-get-version">
<h3>ts.server_request_get_version<a class="headerlink" href="#ts-server-request-get-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ver = ts.server_request.get_version()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_REQUEST_HDR hook point or later.</p>
<p><strong>description:</strong> Return the http version string of the server request.</p>
<p>Current possible values are 1.0, 1.1, and 0.9.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">version</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">get_version</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_REQUEST_HDR</span><span class="p">,</span> <span class="n">send_request</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-request-set-version">
<h3>ts.server_request.set_version<a class="headerlink" href="#ts-server-request-set-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_request.set_version(VERSION_STR)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point</p>
<p><strong>description:</strong> Set the http version of the server request with the VERSION_STR</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">server_request</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-response-get-status">
<h3>ts.server_response.get_status<a class="headerlink" href="#ts-server-response-get-status" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>status = ts.server_response.get_status()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point or later</p>
<p><strong>description:</strong> This function can be used to retrieve the status code of the origin server’s response. A Lua number
will be returned.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">read_response</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">code</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_response</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>         <span class="o">--</span> <span class="mi">200</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_READ_RESPONSE_HDR</span><span class="p">,</span> <span class="n">read_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a>’</p>
</div>
<div class="section" id="ts-server-response-set-status">
<h3>ts.server_response.set_status<a class="headerlink" href="#ts-server-response-set-status" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_response.set_status(NUMBER)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point</p>
<p><strong>description:</strong> This function can be used to set the status code of the origin server’s response.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">read_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">server_response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_READ_RESPONSE_HDR</span><span class="p">,</span> <span class="n">read_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a>’</p>
</div>
<div class="section" id="ts-server-response-get-version">
<h3>ts.server_response.get_version<a class="headerlink" href="#ts-server-response-get-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ver = ts.server_response.get_version()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point or later.</p>
<p><strong>description:</strong> Return the http version string of the server response.</p>
<p>Current possible values are 1.0, 1.1, and 0.9.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-response-is-cacheable">
<h3>ts.server_response.is_cacheable<a class="headerlink" href="#ts-server-response-is-cacheable" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>can_cache = ts.server_response.is_cacheable()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point or later.</p>
<p><strong>description:</strong> Return 1 if the server response can be cached, 0 otherwise.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-response-get-maxage">
<h3>ts.server_response.get_maxage<a class="headerlink" href="#ts-server-response-get-maxage" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>maxage = ts.server_response.get_maxage()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point or later.</p>
<p><strong>description:</strong> Return the maximum age of the server response in seconds if specified by Cache-Control, -1 otherwise.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">debug_long_maxage</span><span class="p">()</span>
    <span class="n">maxage</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_response</span><span class="o">.</span><span class="n">get_maxage</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_response</span><span class="o">.</span><span class="n">is_cacheable</span><span class="p">()</span> <span class="ow">and</span> <span class="n">maxage</span> <span class="o">&gt;</span> <span class="mi">86400</span> <span class="n">then</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cacheable response with maxage=&#39;</span> <span class="o">..</span> <span class="n">maxage</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_READ_RESPONSE_HDR</span><span class="p">,</span> <span class="n">debug_long_maxage</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-response-set-version">
<h3>ts.server_response.set_version<a class="headerlink" href="#ts-server-response-set-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_response.set_version(VERSION_STR)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point</p>
<p><strong>description:</strong> Set the http version of the server response with the VERSION_STR</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">server_response</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-server-response-header-header">
<h3>ts.server_response.header.HEADER<a class="headerlink" href="#ts-server-response-header-header" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_response.header.HEADER = VALUE</em></p>
<p><strong>syntax:</strong> <em>ts.server_response.header[HEADER] = VALUE</em></p>
<p><strong>syntax:</strong> <em>VALUE = ts.server_response.header.HEADER</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point or later.</p>
<p><strong>description:</strong> Set, add to, clear or get the current server response’s HEADER.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">read_response</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_response</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">server_response</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;max-age=14400&#39;</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_READ_RESPONSE_HDR</span><span class="p">,</span> <span class="n">read_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">text/html</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a>’</p>
</div>
<div class="section" id="ts-server-response-get-headers">
<h3>ts.server_response.get_headers<a class="headerlink" href="#ts-server-response-get-headers" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.server_response.get_headers()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_READ_RESPONSE_HDR hook point or later</p>
<p><strong>description:</strong> Returns a Lua table holding all the headers for the current server response.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">read_response</span><span class="p">()</span>
    <span class="n">hdrs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">server_response</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">hdrs</span><span class="p">)</span> <span class="n">do</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">k</span><span class="o">..</span><span class="s1">&#39;: &#39;</span><span class="o">..</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_READ_RESPONSE_HDR</span><span class="p">,</span> <span class="n">read_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Server</span><span class="p">:</span> <span class="n">nginx</span><span class="o">/</span><span class="mf">1.5</span><span class="o">.</span><span class="mi">9</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">18</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">25</span> <span class="n">GMT</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">555</span>
<span class="n">Last</span><span class="o">-</span><span class="n">Modified</span><span class="p">:</span> <span class="n">Mon</span><span class="p">,</span> <span class="mi">19</span> <span class="n">Aug</span> <span class="mi">2013</span> <span class="mi">14</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">55</span> <span class="n">GMT</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">ETag</span><span class="p">:</span> <span class="s2">&quot;52122af3-22b&quot;</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="nb">max</span><span class="o">-</span><span class="n">age</span><span class="o">=</span><span class="mi">14400</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Ranges</span><span class="p">:</span> <span class="nb">bytes</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-response-get-status">
<h3>ts.client_response.get_status<a class="headerlink" href="#ts-client-response-get-status" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>status = ts.client_response.get_status()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_RESPONSE_HDR hook point</p>
<p><strong>description:</strong> This function can be used to retrieve the status code of the response to the client. A Lua number will
be returned.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">code</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>         <span class="o">--</span> <span class="mi">200</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-response-set-status">
<h3>ts.client_response.set_status<a class="headerlink" href="#ts-client-response-set-status" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_response.set_status(NUMBER)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_RESPONSE_HDR hook point</p>
<p><strong>description:</strong> This function can be used to set the status code of the response to the client.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-response-get-version">
<h3>ts.client_response.get_version<a class="headerlink" href="#ts-client-response-get-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ver = ts.client_response.get_version()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_RESPONSE_HDR hook point.</p>
<p><strong>description:</strong> Return the http version string of the response to the client.</p>
<p>Current possible values are 1.0, 1.1, and 0.9.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-response-set-version">
<h3>ts.client_response.set_version<a class="headerlink" href="#ts-client-response-set-version" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_response.set_version(VERSION_STR)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_RESPONSE_HDR hook point</p>
<p><strong>description:</strong> Set the http version of the response to the client with the VERSION_STR</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-response-header-header">
<h3>ts.client_response.header.HEADER<a class="headerlink" href="#ts-client-response-header-header" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_response.header.HEADER = VALUE</em></p>
<p><strong>syntax:</strong> <em>ts.client_response.header[HEADER] = VALUE</em></p>
<p><strong>syntax:</strong> <em>VALUE = ts.client_response.header.HEADER</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_RESPONSE_HDR hook point.</p>
<p><strong>description:</strong> Set, add to, clear or get the current client response’s HEADER.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">ct</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;max-age=3600&#39;</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the output:</p>
<p><code class="docutils literal notranslate"><span class="pre">text/html</span></code></p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-response-get-headers">
<h3>ts.client_response.get_headers<a class="headerlink" href="#ts-client-response-get-headers" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_response.get_headers()</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_RESPONSE_HDR hook point.</p>
<p><strong>description:</strong> Returns a Lua table holding all the headers for the current client response.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">hdrs</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">get_headers</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">hdrs</span><span class="p">)</span> <span class="n">do</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">k</span><span class="o">..</span><span class="s1">&#39;: &#39;</span><span class="o">..</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Server</span><span class="p">:</span> <span class="n">ATS</span><span class="o">/</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">18</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">25</span> <span class="n">GMT</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
<span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">chunked</span>
<span class="n">Last</span><span class="o">-</span><span class="n">Modified</span><span class="p">:</span> <span class="n">Mon</span><span class="p">,</span> <span class="mi">19</span> <span class="n">Aug</span> <span class="mi">2013</span> <span class="mi">14</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">55</span> <span class="n">GMT</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="nb">max</span><span class="o">-</span><span class="n">age</span><span class="o">=</span><span class="mi">14400</span>
<span class="n">Age</span><span class="p">:</span> <span class="mi">2641</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Ranges</span><span class="p">:</span> <span class="nb">bytes</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-client-response-set-error-resp">
<h3>ts.client_response.set_error_resp<a class="headerlink" href="#ts-client-response-set-error-resp" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.client_response.set_error_resp(CODE, BODY)</em></p>
<p><strong>context:</strong> function &#64; TS_LUA_HOOK_SEND_RESPONSE_HDR hook point.</p>
<p><strong>description:</strong> This function can be used to set the error response to the client.</p>
<p>With this function we can jump to send error response to the client if exception exists, meanwhile we should return <cite>-1</cite>
from the function where exception raises.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_response</span><span class="o">.</span><span class="n">set_error_resp</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;bad luck :(</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the response like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">404</span> <span class="n">Not</span> <span class="n">Found</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">18</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">11</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">00</span> <span class="n">GMT</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">ATS</span><span class="o">/</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">12</span>

<span class="n">bad</span> <span class="n">luck</span> <span class="p">:(</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="number-constants">
<h3>Number constants<a class="headerlink" href="#number-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> global</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_INT64_MAX</span> <span class="p">(</span><span class="mi">9223372036854775808</span><span class="p">)</span>
<span class="n">TS_LUA_INT64_MIN</span> <span class="p">(</span><span class="o">-</span><span class="mi">9223372036854775808</span><span class="n">L</span><span class="p">)</span>
</pre></div>
</div>
<p>These constants are usually used in transform handler.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-resp-cache-transformed">
<h3>ts.http.resp_cache_transformed<a class="headerlink" href="#ts-http-resp-cache-transformed" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.resp_cache_transformed(BOOL)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: This function can be used to tell trafficserver whether to cache the transformed data.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">upper_transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">eos</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_RESPONSE_TRANSFORM</span><span class="p">,</span> <span class="n">upper_transform</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">resp_cache_transformed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>This function is usually called after we hook TS_LUA_RESPONSE_TRANSFORM.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-resp-cache-untransformed">
<h3>ts.http.resp_cache_untransformed<a class="headerlink" href="#ts-http-resp-cache-untransformed" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.resp_cache_untransformed(BOOL)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description</strong>: This function can be used to tell trafficserver whether to cache the untransformed data.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">upper_transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">eos</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_RESPONSE_TRANSFORM</span><span class="p">,</span> <span class="n">upper_transform</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">resp_cache_untransformed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>This function is usually called after we hook TS_LUA_RESPONSE_TRANSFORM.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-resp-transform-get-upstream-bytes">
<h3>ts.http.resp_transform.get_upstream_bytes<a class="headerlink" href="#ts-http-resp-transform-get-upstream-bytes" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.resp_transform.get_upstream_bytes()</em></p>
<p><strong>context:</strong> transform handler</p>
<p><strong>description</strong>: This function can be used to retrieve the total bytes to be received from the upstream. If we got
chunked response body from origin server, TS_LUA_INT64_MAX will be returned.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">APPEND_DATA</span> <span class="o">=</span> <span class="s1">&#39;TAIL</span><span class="se">\n</span><span class="s1">&#39;</span>

<span class="n">function</span> <span class="n">append_transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">eos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;len_set&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">nil</span> <span class="n">then</span>
        <span class="n">local</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">resp_transform</span><span class="o">.</span><span class="n">get_upstream_bytes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sz</span> <span class="o">~=</span> <span class="n">TS_LUA_INT64_MAX</span> <span class="n">then</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">resp_transform</span><span class="o">.</span><span class="n">set_downstream_bytes</span><span class="p">(</span><span class="n">sz</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">APPEND_DATA</span><span class="p">))</span>
        <span class="n">end</span>

        <span class="n">ts</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;len_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">true</span>
    <span class="n">end</span>

    <span class="k">if</span> <span class="n">eos</span> <span class="o">==</span> <span class="mi">1</span> <span class="n">then</span>
        <span class="k">return</span> <span class="n">data</span> <span class="o">..</span> <span class="n">APPEND_DATA</span><span class="p">,</span> <span class="n">eos</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">eos</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_RESPONSE_TRANSFORM</span><span class="p">,</span> <span class="n">append_transform</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">resp_cache_transformed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">resp_cache_untransformed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>The above example also shows the use of eos passed as a parameter to transform function. It indicates the end of the
data stream to the transform function.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-resp-transform-get-upstream-watermark-bytes">
<h3>ts.http.resp_transform.get_upstream_watermark_bytes<a class="headerlink" href="#ts-http-resp-transform-get-upstream-watermark-bytes" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.resp_transform.get_upstream_watermark_bytes()</em></p>
<p><strong>context:</strong> transform handler</p>
<p><strong>description</strong>: This function can be used to retrieve the current watermark bytes for the upstream transform buffer.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-resp-transform-set-upstream-watermark-bytes">
<h3>ts.http.resp_transform.set_upstream_watermark_bytes<a class="headerlink" href="#ts-http-resp-transform-set-upstream-watermark-bytes" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.resp_transform.set_upstream_watermark_bytes(NUMBER)</em></p>
<p><strong>context:</strong> transform handler</p>
<p><strong>description</strong>: This function can be used to set the watermark bytes of the upstream transform buffer.</p>
<p>Setting the watermark bytes above 32kb may improve the performance of the transform handler.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-resp-transform-set-downstream-bytes">
<h3>ts.http.resp_transform.set_downstream_bytes<a class="headerlink" href="#ts-http-resp-transform-set-downstream-bytes" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.resp_transform.set_downstream_bytes(NUMBER)</em></p>
<p><strong>context:</strong> transform handler</p>
<p><strong>description</strong>: This function can be used to set the total bytes to be sent to the downstream.</p>
<p>Sometimes we want to set Content-Length header in client_response, and this function should be called before any real
data is returned from the transform handler.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-skip-remapping-set">
<h3>ts.http.skip_remapping_set<a class="headerlink" href="#ts-http-skip-remapping-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.skip_remapping_set(BOOL)</em></p>
<p><strong>context:</strong> do_global_read_request</p>
<p><strong>description</strong>: This function can be used to tell trafficserver to skip doing remapping</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">skip_remapping_set</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;www.yahoo.com&#39;</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>This function is usually called in do_global_read_request function</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-client-protocol-stack">
<h3>ts.http.get_client_protocol_stack<a class="headerlink" href="#ts-http-get-client-protocol-stack" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_client_protocol_stack()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to get client protocol stack information</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">stack</span> <span class="o">=</span> <span class="p">{</span><span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_client_protocol_stack</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="n">do</span>
      <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-server-protocol-stack">
<h3>ts.http.get_server_protocol_stack<a class="headerlink" href="#ts-http-get-server-protocol-stack" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_server_protocol_stack()</em></p>
<p><strong>context:</strong> do_global_read_response or later</p>
<p><strong>description:</strong> This function can be used to get server protocol stack information</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_response</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">stack</span> <span class="o">=</span> <span class="p">{</span><span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_server_protocol_stack</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="n">do</span>
      <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">end</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-server-push">
<h3>ts.http.server_push<a class="headerlink" href="#ts-http-server-push" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.server_push()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can do http/2 server push for the input url</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">server_push</span><span class="p">(</span><span class="s2">&quot;https://test.com/test.js&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-is-websocket">
<h3>ts.http.is_websocket<a class="headerlink" href="#ts-http-is-websocket" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.is_websocket()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to tell if the transaction is websocket</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">is_websocket</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-plugin-tag">
<h3>ts.http.get_plugin_tag<a class="headerlink" href="#ts-http-get-plugin-tag" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_plugin_tag()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to get plugin tag of a transaction</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_plugin_tag</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-id">
<h3>ts.http.id<a class="headerlink" href="#ts-http-id" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.id()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to tell id of a transaction</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">id</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-ssn-id">
<h3>ts.http.ssn_id<a class="headerlink" href="#ts-http-ssn-id" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.ssn_id()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to tell id of a client session</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">ssn_id</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-is-internal-request">
<h3>ts.http.is_internal_request<a class="headerlink" href="#ts-http-is-internal-request" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.is_internal_request()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to tell if a request is internal or not</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">internal</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">is_internal_request</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">internal</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-is-aborted">
<h3>ts.http.is_aborted<a class="headerlink" href="#ts-http-is-aborted" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.is_aborted()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to tell if a request is aborted or not</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">aborted</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">is_aborted</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">aborted</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-transaction-count">
<h3>ts.http.transaction_count<a class="headerlink" href="#ts-http-transaction-count" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.transaction_count()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function returns the number of transaction in this client connection</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">transaction_count</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-server-transaction-count">
<h3>ts.http.server_transaction_count<a class="headerlink" href="#ts-http-server-transaction-count" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.server_transaction_count()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function returns the number of transaction in this server connection</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-redirect-url-set">
<h3>ts.http.redirect_url_set<a class="headerlink" href="#ts-http-redirect-url-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.redirect_url_set()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function sets the redirect url and instructs the transaction to follow the redirection as response</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">redirect_url_set</span><span class="p">(</span><span class="s1">&#39;http://foo.com&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-server-state">
<h3>ts.http.get_server_state<a class="headerlink" href="#ts-http-get-server-state" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_server_state()</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function returns the current server state</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_os_response</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_server_state</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">TS_LUA_SRVSTATE_CONNECTION_ALIVE</span> <span class="n">then</span>
      <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Alive&#39;</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="server-state-constants">
<h3>Server state constants<a class="headerlink" href="#server-state-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> global</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_SRVSTATE_STATE_UNDEFINED</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_ACTIVE_TIMEOUT</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_BAD_INCOMING_RESPONSE</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_CONNECTION_ALIVE</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_CONNECTION_CLOSED</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_CONNECTION_ERROR</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_INACTIVE_TIMEOUT</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_OPEN_RAW_ERROR</span> <span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_PARSE_ERROR</span> <span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_TRANSACTION_COMPLETE</span> <span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="n">TS_LUA_SRVSTATE_PARENT_RETRY</span> <span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-remap-from-url">
<h3>ts.http.get_remap_from_url<a class="headerlink" href="#ts-http-get-remap-from-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_remap_from_url()</em></p>
<p><strong>context:</strong> do_global_post_remap</p>
<p><strong>description:</strong> This function can be used to get the <em>from</em> URL in the matching line in <a class="reference internal" href="../files/remap.config.en.html#std:configfile-remap.config"><code class="xref std std-file docutils literal notranslate"><span class="pre">remap.config</span></code></a>.</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_post_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">from_url</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_remap_from_url</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">from_url</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-remap-to-url">
<h3>ts.http.get_remap_to_url<a class="headerlink" href="#ts-http-get-remap-to-url" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_remap_to_url()</em></p>
<p><strong>context:</strong> do_global_post_remap</p>
<p><strong>description:</strong> This function can be used to get the <em>to</em> URL in the matching line in <a class="reference internal" href="../files/remap.config.en.html#std:configfile-remap.config"><code class="xref std std-file docutils literal notranslate"><span class="pre">remap.config</span></code></a>.</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_post_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">to_url</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_remap_to_url</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">to_url</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-client-fd">
<h3>ts.http.get_client_fd<a class="headerlink" href="#ts-http-get-client-fd" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_client_fd()</em></p>
<p><strong>context:</strong> after do_global_read_request</p>
<p><strong>description:</strong> This function can be used to get the client FD for the transaction.</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_client_fd</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-get-server-fd">
<h3>ts.http.get_server_fd<a class="headerlink" href="#ts-http-get-server-fd" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.get_server_fd()</em></p>
<p><strong>context:</strong> after do_global_send_request</p>
<p><strong>description:</strong> This function can be used to get the server (origin) FD for the transaction.</p>
<p>Here is an example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_global_send_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_server_fd</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-add-package-path">
<h3>ts.add_package_path<a class="headerlink" href="#ts-add-package-path" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.add_package_path(lua-style-path-str)</em></p>
<p><strong>context:</strong> init stage of the lua script</p>
<p><strong>description:</strong> Adds the Lua module search path used by scripts.</p>
<p>The path string is in standard Lua path form.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">add_package_path</span><span class="p">(</span><span class="s1">&#39;/home/a/test/lua/pac/?.lua&#39;</span><span class="p">)</span>
<span class="n">local</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&quot;nt&quot;</span><span class="p">)</span>
<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">nt</span><span class="o">.</span><span class="n">t9</span><span class="p">(</span><span class="mi">7979</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-add-package-cpath">
<h3>ts.add_package_cpath<a class="headerlink" href="#ts-add-package-cpath" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.add_package_cpath(lua-style-cpath-str)</em></p>
<p><strong>context:</strong> init stage of the lua script</p>
<p><strong>description:</strong> Adds the Lua C-module search path used by scripts.</p>
<p>The cpath string is in standard Lua cpath form.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ts</span><span class="o">.</span><span class="n">add_package_cpath</span><span class="p">(</span><span class="s1">&#39;/home/a/test/c/module/?.so&#39;</span><span class="p">)</span>
<span class="n">local</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s2">&quot;ma&quot;</span><span class="p">)</span>
<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">ft</span><span class="p">())</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-md5">
<h3>ts.md5<a class="headerlink" href="#ts-md5" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.md5(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the hexadecimal representation of the MD5 digest of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>              <span class="o">--</span> <span class="o">/</span><span class="n">foo</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>      <span class="o">--</span> <span class="mi">1</span><span class="n">effb2475fcfba4f9e8b8a1dbc8f3caf</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-md5-bin">
<h3>ts.md5_bin<a class="headerlink" href="#ts-md5-bin" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.md5_bin(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the binary form of the MD5 digest of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="nb">bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">md5_bin</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-sha1">
<h3>ts.sha1<a class="headerlink" href="#ts-sha1" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.sha1(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the hexadecimal representation of the SHA-1 digest of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>              <span class="o">--</span> <span class="o">/</span><span class="n">foo</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>     <span class="o">--</span> <span class="mi">6</span><span class="n">dbd548cc03e44b8b44b6e68e56255ce4273ae49</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-sha1-bin">
<h3>ts.sha1_bin<a class="headerlink" href="#ts-sha1-bin" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>digest = ts.sha1_bin(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the binary form of the SHA-1 digest of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="nb">bin</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">sha1_bin</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-base64-encode">
<h3>ts.base64_encode<a class="headerlink" href="#ts-base64-encode" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>value = ts.base64_encode(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the base64 encoding of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">base64_encode</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-base64-decode">
<h3>ts.base64_decode<a class="headerlink" href="#ts-base64-decode" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>value = ts.base64_decode(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the base64 decoding of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">get_uri</span><span class="p">()</span>
    <span class="n">encoded_value</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">base64_encode</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">decoded_value</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">base64_decode</span><span class="p">(</span><span class="n">encoded_value</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-escape-uri">
<h3>ts.escape_uri<a class="headerlink" href="#ts-escape-uri" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>value = ts.escape_uri(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the uri-escaped value of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;/some value/&#39;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">escape_uri</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-unescape-uri">
<h3>ts.unescape_uri<a class="headerlink" href="#ts-unescape-uri" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>value = ts.unescape_uri(str)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> Returns the uri-unescaped value of the <code class="docutils literal notranslate"><span class="pre">str</span></code> argument.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;/some value/&#39;</span>
    <span class="n">escaped_value</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">escape_uri</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="n">unescaped_value</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">unescape_uri</span><span class="p">(</span><span class="n">escaped_value</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-fetch">
<h3>ts.fetch<a class="headerlink" href="#ts-fetch" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>res = ts.fetch(url, table?)</em></p>
<p><strong>context:</strong> hook point functions added after do_remap</p>
<p><strong>description:</strong> Issues a synchronous but still non-block http request with the <code class="docutils literal notranslate"><span class="pre">url</span></code> and the optional <code class="docutils literal notranslate"><span class="pre">table</span></code>.</p>
<p>Returns a Lua table with several slots (res.status, res.header, res.body, and res.truncated).</p>
<p><code class="docutils literal notranslate"><span class="pre">res.status</span></code> holds the response status code.</p>
<p><code class="docutils literal notranslate"><span class="pre">res.header</span></code> holds the response header table.</p>
<p><code class="docutils literal notranslate"><span class="pre">res.body</span></code> holds the response body which may be truncated, you need to check res.truncated to see if the data is
truncated.</p>
<p>Here is a basic example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">post_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">url</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">/foo.txt&#39;</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">])</span>
    <span class="n">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="n">then</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">inner</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">is_internal_request</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">inner</span> <span class="o">~=</span> <span class="mi">0</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>
    <span class="n">local</span> <span class="n">host</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_POST_REMAP</span><span class="p">,</span> <span class="n">post_remap</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We can set the optional table with several members:</p>
<p><code class="docutils literal notranslate"><span class="pre">header</span></code> holds the request header table.</p>
<p><code class="docutils literal notranslate"><span class="pre">method</span></code> holds the request method. The default method is ‘GET’.</p>
<p><code class="docutils literal notranslate"><span class="pre">cliaddr</span></code> holds the request client address in ip:port form. The default cliaddr is ‘127.0.0.1:33333’</p>
<p>Issuing a post request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;http://xx.com/foo&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;hello world&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-fetch-multi">
<h3>ts.fetch_multi<a class="headerlink" href="#ts-fetch-multi" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>vec = ts.fetch_multi({{url, table?}, {url, table?}, …})</em></p>
<p><strong>context:</strong> hook point functions added after do_remap</p>
<p>Just like <cite>ts.fetch</cite>, but supports multiple http requests running in parallel.</p>
<p>This function will fetch all the urls specified by the input table and return a table which contain all the results in
the same order.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fetch_multi</span><span class="p">({</span>
                <span class="p">{</span><span class="s1">&#39;http://xx.com/slayer&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;http://xx.com/am&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">cliaddr</span> <span class="o">=</span> <span class="s1">&#39;192.168.1.19:35423&#39;</span><span class="p">}},</span>
                <span class="p">{</span><span class="s1">&#39;http://xx.com/naga&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;hello world&#39;</span><span class="p">}},</span>
            <span class="p">})</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">#(vec) do</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-intercept">
<h3>ts.http.intercept<a class="headerlink" href="#ts-http-intercept" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.intercept(FUNCTION, param1?, param2?, …)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> Intercepts the client request and processes it in FUNCTION with optional params.</p>
<p>We should construct the response for the client request, and the request will not be processed by other modules, like
hostdb, cache, origin server…</p>
<p>Intercept FUNCTION will be executed in a new lua_thread, so we can delivery optional params from old lua_thread to new
lua_thread if needed.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">require</span> <span class="s1">&#39;os&#39;</span>

<span class="n">function</span> <span class="n">send_data</span><span class="p">(</span><span class="n">dstr</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">nt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">..</span><span class="s1">&#39; Zheng.</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">local</span> <span class="n">resp</span> <span class="o">=</span>  <span class="s1">&#39;HTTP/1.0 200 OK</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Server: ATS/3.2.0</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Content-Length: &#39;</span> <span class="o">..</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">nt</span><span class="p">))</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Last-Modified: &#39;</span> <span class="o">..</span> <span class="n">os</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Connection: keep-alive</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Cache-Control: max-age=7200</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Accept-Ranges: bytes</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="n">nt</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dstr</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">intercept</span><span class="p">(</span><span class="n">send_data</span><span class="p">,</span> <span class="s1">&#39;hello world&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>Then we will get the response like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">ATS</span><span class="o">/</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">18</span>
<span class="n">Last</span><span class="o">-</span><span class="n">Modified</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">18</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">08</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">12</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="nb">max</span><span class="o">-</span><span class="n">age</span><span class="o">=</span><span class="mi">7200</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Ranges</span><span class="p">:</span> <span class="nb">bytes</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">18</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">12</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">12</span> <span class="n">GMT</span>
<span class="n">Age</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>

<span class="mi">1395145392</span> <span class="n">Zheng</span><span class="o">.</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-server-intercept">
<h3>ts.http.server_intercept<a class="headerlink" href="#ts-http-server-intercept" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.server_intercept(FUNCTION, param1?, param2?, …)</em></p>
<p><strong>context:</strong> do_remap or do_global_*</p>
<p><strong>description:</strong> Intercepts the server request and acts as the origin server.</p>
<p>Just like ts.http.intercept, but this function will intercept the server request, and we can acts as the origin server
in <cite>FUNCTION</cite>.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">require</span> <span class="s1">&#39;os&#39;</span>

<span class="n">function</span> <span class="n">process_combo</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">url1</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">/css/1.css&#39;</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">url2</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">/css/2.css&#39;</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
    <span class="n">local</span> <span class="n">url3</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">/css/3.css&#39;</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>

    <span class="n">local</span> <span class="n">hdr</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">host</span><span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;blur blur&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">local</span> <span class="n">ct</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">,</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>
    <span class="p">}</span>

    <span class="n">local</span> <span class="n">arr</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">fetch_multi</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="p">{</span><span class="n">url1</span><span class="p">,</span> <span class="n">ct</span><span class="p">},</span>
                <span class="p">{</span><span class="n">url2</span><span class="p">,</span> <span class="n">ct</span><span class="p">},</span>
                <span class="p">{</span><span class="n">url3</span><span class="p">,</span> <span class="n">ct</span><span class="p">},</span>
            <span class="p">})</span>

    <span class="n">local</span> <span class="n">ctype</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span>
    <span class="n">local</span> <span class="n">body</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">..</span> <span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">..</span> <span class="n">arr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>

    <span class="n">local</span> <span class="n">resp</span> <span class="o">=</span>  <span class="s1">&#39;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Server: ATS/5.2.0</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Last-Modified: &#39;</span> <span class="o">..</span> <span class="n">os</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Cache-Control: max-age=7200</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Accept-Ranges: bytes</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Content-Type: &#39;</span> <span class="o">..</span> <span class="n">ctype</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Content-Length: &#39;</span> <span class="o">..</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">body</span><span class="p">))</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="n">body</span>

    <span class="n">ts</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">inner</span> <span class="o">=</span>  <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">is_internal_request</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">inner</span> <span class="o">~=</span> <span class="mi">0</span> <span class="n">then</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">end</span>

    <span class="n">local</span> <span class="n">h</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">client_request</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">server_intercept</span><span class="p">(</span><span class="n">process_combo</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-say">
<h3>ts.say<a class="headerlink" href="#ts-say" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.say(data)</em></p>
<p><strong>context:</strong> <em>intercept or server_intercept</em></p>
<p><strong>description:</strong> Write response to ATS within intercept or server_intercept.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-flush">
<h3>ts.flush<a class="headerlink" href="#ts-flush" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.flush()</em></p>
<p><strong>context:</strong> <em>intercept or server_intercept</em></p>
<p><strong>description:</strong> Flushes the output to ATS within intercept or server_intercept.</p>
<p>In synchronous mode, the function will not return until all output data has been written into the system send buffer.
Note that using the Lua coroutine mechanism means that this function does not block the ATS event loop even in the
synchronous mode.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">require</span> <span class="s1">&#39;os&#39;</span>

<span class="n">function</span> <span class="n">send_data</span><span class="p">()</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;wo ai yu ye hua</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">local</span> <span class="n">resp</span> <span class="o">=</span>  <span class="s1">&#39;HTTP/1.0 200 OK</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Server: ATS/3.2.0</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Content-Length: &#39;</span> <span class="o">..</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">string</span><span class="o">.</span><span class="n">len</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Last-Modified: &#39;</span> <span class="o">..</span> <span class="n">os</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Connection: keep-alive</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Cache-Control: max-age=7200</span><span class="se">\r\n</span><span class="s1">&#39;</span> <span class="o">..</span>
                  <span class="s1">&#39;Accept-Ranges: bytes</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span> <span class="n">do</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">end</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">intercept</span><span class="p">(</span><span class="n">send_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p>We will get the response like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="n">Server</span><span class="p">:</span> <span class="n">ATS</span><span class="o">/</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">80</span>
<span class="n">Last</span><span class="o">-</span><span class="n">Modified</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">18</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">08</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">29</span> <span class="n">GMT</span>
<span class="n">Cache</span><span class="o">-</span><span class="n">Control</span><span class="p">:</span> <span class="nb">max</span><span class="o">-</span><span class="n">age</span><span class="o">=</span><span class="mi">7200</span>
<span class="n">Accept</span><span class="o">-</span><span class="n">Ranges</span><span class="p">:</span> <span class="nb">bytes</span>
<span class="n">Date</span><span class="p">:</span> <span class="n">Tue</span><span class="p">,</span> <span class="mi">18</span> <span class="n">Mar</span> <span class="mi">2014</span> <span class="mi">12</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mi">29</span> <span class="n">GMT</span>
<span class="n">Age</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>

<span class="n">wo</span> <span class="n">ai</span> <span class="n">yu</span> <span class="n">ye</span> <span class="n">hua</span>
<span class="n">wo</span> <span class="n">ai</span> <span class="n">yu</span> <span class="n">ye</span> <span class="n">hua</span>
<span class="n">wo</span> <span class="n">ai</span> <span class="n">yu</span> <span class="n">ye</span> <span class="n">hua</span>
<span class="n">wo</span> <span class="n">ai</span> <span class="n">yu</span> <span class="n">ye</span> <span class="n">hua</span>
<span class="n">wo</span> <span class="n">ai</span> <span class="n">yu</span> <span class="n">ye</span> <span class="n">hua</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-sleep">
<h3>ts.sleep<a class="headerlink" href="#ts-sleep" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.sleep(sec)</em></p>
<p><strong>context:</strong> <em>hook point functions added after do_remap</em></p>
<p><strong>description:</strong> Sleeps for the specified seconds without blocking.</p>
<p>Behind the scene, this method makes use of the ATS event model.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">read_response</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_READ_RESPONSE_HDR</span><span class="p">,</span> <span class="n">read_response</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-host-lookup">
<h3>ts.host_lookup<a class="headerlink" href="#ts-host-lookup" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.host_lookup(hostname)</em></p>
<p><strong>context:</strong> <em>hook point functions added after do_remap</em></p>
<p><strong>description:</strong> Look for ip address of the host name without blocking. Nil if address cannot be found.</p>
<p>Behind the scene, this method makes use of the ATS event model.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">send_response</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">host_lookup</span><span class="p">(</span><span class="s2">&quot;www.xyz.com&quot;</span><span class="p">)</span> <span class="o">--</span> <span class="n">ip</span> <span class="n">address</span> <span class="n">of</span> <span class="n">www</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">com</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_SEND_RESPONSE_HDR</span><span class="p">,</span> <span class="n">send_response</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-schedule">
<h3>ts.schedule<a class="headerlink" href="#ts-schedule" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.schedule(THREAD_TYPE, sec, FUNCTION, param1?, param2?, …)</em></p>
<p><strong>context:</strong> <em>hook point functions added after do_remap</em></p>
<p><strong>description:</strong> Schedule function to be run after specified seconds without blocking.</p>
<p>Behind the scene, this method makes use of the ATS event model.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">schedule</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;test schedule starts&#39;</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">cache_lookup</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cache-lookup&#39;</span><span class="p">)</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">TS_LUA_THREAD_POOL_NET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">schedule</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">hook</span><span class="p">(</span><span class="n">TS_LUA_HOOK_CACHE_LOOKUP_COMPLETE</span><span class="p">,</span> <span class="n">cache_lookup</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-config-int-get">
<h3>ts.http.config_int_get<a class="headerlink" href="#ts-http-config-int-get" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.http.config_int_get(CONFIG)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Configuration option which has a int value can be retrieved with this function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">config_int_get</span><span class="p">(</span><span class="n">TS_LUA_CONFIG_HTTP_CACHE_HTTP</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-config-int-set">
<h3>ts.http.config_int_set<a class="headerlink" href="#ts-http-config-int-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.config_int_set(CONFIG, NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to overwrite the configuration options.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">config_int_set</span><span class="p">(</span><span class="n">TS_LUA_CONFIG_HTTP_CACHE_HTTP</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    <span class="o">--</span> <span class="n">bypass</span> <span class="n">the</span> <span class="n">cache</span> <span class="n">processor</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-config-float-get">
<h3>ts.http.config_float_get<a class="headerlink" href="#ts-http-config-float-get" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.http.config_float_get(CONFIG)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Configuration option which has a float value can be retrieved with this function.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-config-float-set">
<h3>ts.http.config_float_set<a class="headerlink" href="#ts-http-config-float-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.config_float_set(CONFIG, NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to overwrite the configuration options.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-config-string-get">
<h3>ts.http.config_string_get<a class="headerlink" href="#ts-http-config-string-get" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.http.config_string_get(CONFIG)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> Configuration option which has a string value can be retrieved with this function.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-config-string-set">
<h3>ts.http.config_string_set<a class="headerlink" href="#ts-http-config-string-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.config_string_set(CONFIG, NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<p><strong>description:</strong> This function can be used to overwrite the configuration options.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="http-config-constants">
<h3>Http config constants<a class="headerlink" href="#http-config-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_CONFIG_URL_REMAP_PRISTINE_HOST_HDR</span>
<span class="n">TS_LUA_CONFIG_HTTP_CHUNKING_ENABLED</span>
<span class="n">TS_LUA_CONFIG_HTTP_NEGATIVE_CACHING_ENABLED</span>
<span class="n">TS_LUA_CONFIG_HTTP_NEGATIVE_CACHING_LIFETIME</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_WHEN_TO_REVALIDATE</span>
<span class="n">TS_LUA_CONFIG_HTTP_KEEP_ALIVE_ENABLED_IN</span>
<span class="n">TS_LUA_CONFIG_HTTP_KEEP_ALIVE_ENABLED_OUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_KEEP_ALIVE_POST_OUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_SERVER_SESSION_SHARING_MATCH</span>
<span class="n">TS_LUA_CONFIG_NET_SOCK_RECV_BUFFER_SIZE_OUT</span>
<span class="n">TS_LUA_CONFIG_NET_SOCK_SEND_BUFFER_SIZE_OUT</span>
<span class="n">TS_LUA_CONFIG_NET_SOCK_OPTION_FLAG_OUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_FORWARD_PROXY_AUTH_TO_PARENT</span>
<span class="n">TS_LUA_CONFIG_HTTP_ANONYMIZE_REMOVE_FROM</span>
<span class="n">TS_LUA_CONFIG_HTTP_ANONYMIZE_REMOVE_REFERER</span>
<span class="n">TS_LUA_CONFIG_HTTP_ANONYMIZE_REMOVE_USER_AGENT</span>
<span class="n">TS_LUA_CONFIG_HTTP_ANONYMIZE_REMOVE_COOKIE</span>
<span class="n">TS_LUA_CONFIG_HTTP_ANONYMIZE_REMOVE_CLIENT_IP</span>
<span class="n">TS_LUA_CONFIG_HTTP_ANONYMIZE_INSERT_CLIENT_IP</span>
<span class="n">TS_LUA_CONFIG_HTTP_RESPONSE_SERVER_ENABLED</span>
<span class="n">TS_LUA_CONFIG_HTTP_INSERT_SQUID_X_FORWARDED_FOR</span>
<span class="n">TS_LUA_CONFIG_HTTP_INSERT_FORWARDED</span>
<span class="n">TS_LUA_CONFIG_HTTP_SEND_HTTP11_REQUESTS</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_HTTP</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IGNORE_CLIENT_NO_CACHE</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IGNORE_CLIENT_CC_MAX_AGE</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IMS_ON_CLIENT_NO_CACHE</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IGNORE_SERVER_NO_CACHE</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_CACHE_RESPONSES_TO_COOKIES</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IGNORE_AUTHENTICATION</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_CACHE_URLS_THAT_LOOK_DYNAMIC</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_REQUIRED_HEADERS</span>
<span class="n">TS_LUA_CONFIG_HTTP_INSERT_REQUEST_VIA_STR</span>
<span class="n">TS_LUA_CONFIG_HTTP_INSERT_RESPONSE_VIA_STR</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_HEURISTIC_MIN_LIFETIME</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_HEURISTIC_MAX_LIFETIME</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_GUARANTEED_MIN_LIFETIME</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_GUARANTEED_MAX_LIFETIME</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_MAX_STALE_AGE</span>
<span class="n">TS_LUA_CONFIG_HTTP_KEEP_ALIVE_NO_ACTIVITY_TIMEOUT_IN</span>
<span class="n">TS_LUA_CONFIG_HTTP_KEEP_ALIVE_NO_ACTIVITY_TIMEOUT_OUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_TRANSACTION_NO_ACTIVITY_TIMEOUT_IN</span>
<span class="n">TS_LUA_CONFIG_HTTP_TRANSACTION_NO_ACTIVITY_TIMEOUT_OUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_TRANSACTION_ACTIVE_TIMEOUT_OUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_PER_SERVER_CONNECTION_MAX</span>
<span class="n">TS_LUA_CONFIG_HTTP_PER_SERVER_CONNECTION_MATCH</span>
<span class="n">TS_LUA_CONFIG_HTTP_CONNECT_ATTEMPTS_MAX_RETRIES</span>
<span class="n">TS_LUA_CONFIG_HTTP_CONNECT_ATTEMPTS_MAX_RETRIES_DEAD_SERVER</span>
<span class="n">TS_LUA_CONFIG_HTTP_CONNECT_ATTEMPTS_RR_RETRIES</span>
<span class="n">TS_LUA_CONFIG_HTTP_CONNECT_ATTEMPTS_TIMEOUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_POST_CONNECT_ATTEMPTS_TIMEOUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_DOWN_SERVER_CACHE_TIME</span>
<span class="n">TS_LUA_CONFIG_HTTP_DOWN_SERVER_ABORT_THRESHOLD</span>
<span class="n">TS_LUA_CONFIG_HTTP_DOC_IN_CACHE_SKIP_DNS</span>
<span class="n">TS_LUA_CONFIG_HTTP_BACKGROUND_FILL_ACTIVE_TIMEOUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_RESPONSE_SERVER_STR</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_HEURISTIC_LM_FACTOR</span>
<span class="n">TS_LUA_CONFIG_HTTP_BACKGROUND_FILL_COMPLETED_THRESHOLD</span>
<span class="n">TS_LUA_CONFIG_NET_SOCK_PACKET_MARK_OUT</span>
<span class="n">TS_LUA_CONFIG_NET_SOCK_PACKET_TOS_OUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_INSERT_AGE_IN_RESPONSE</span>
<span class="n">TS_LUA_CONFIG_HTTP_CHUNKING_SIZE</span>
<span class="n">TS_LUA_CONFIG_HTTP_FLOW_CONTROL_ENABLED</span>
<span class="n">TS_LUA_CONFIG_HTTP_FLOW_CONTROL_LOW_WATER_MARK</span>
<span class="n">TS_LUA_CONFIG_HTTP_FLOW_CONTROL_HIGH_WATER_MARK</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_RANGE_LOOKUP</span>
<span class="n">TS_LUA_CONFIG_HTTP_NORMALIZE_AE</span>
<span class="n">TS_LUA_CONFIG_HTTP_DEFAULT_BUFFER_SIZE</span>
<span class="n">TS_LUA_CONFIG_HTTP_DEFAULT_BUFFER_WATER_MARK</span>
<span class="n">TS_LUA_CONFIG_HTTP_REQUEST_HEADER_MAX_SIZE</span>
<span class="n">TS_LUA_CONFIG_HTTP_RESPONSE_HEADER_MAX_SIZE</span>
<span class="n">TS_LUA_CONFIG_HTTP_NEGATIVE_REVALIDATING_ENABLED</span>
<span class="n">TS_LUA_CONFIG_HTTP_NEGATIVE_REVALIDATING_LIFETIME</span>
<span class="n">TS_LUA_CONFIG_SSL_HSTS_MAX_AGE</span>
<span class="n">TS_LUA_CONFIG_SSL_HSTS_INCLUDE_SUBDOMAINS</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_OPEN_READ_RETRY_TIME</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_MAX_OPEN_READ_RETRIES</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_RANGE_WRITE</span>
<span class="n">TS_LUA_CONFIG_HTTP_POST_CHECK_CONTENT_LENGTH_ENABLED</span>
<span class="n">TS_LUA_CONFIG_HTTP_GLOBAL_USER_AGENT_HEADER</span>
<span class="n">TS_LUA_CONFIG_HTTP_AUTH_SERVER_SESSION_PRIVATE</span>
<span class="n">TS_LUA_CONFIG_HTTP_SLOW_LOG_THRESHOLD</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_GENERATION</span>
<span class="n">TS_LUA_CONFIG_BODY_FACTORY_TEMPLATE_BASE</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_OPEN_WRITE_FAIL_ACTION</span>
<span class="n">TS_LUA_CONFIG_HTTP_NUMBER_OF_REDIRECTIONS</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_MAX_OPEN_WRITE_RETRIES</span>
<span class="n">TS_LUA_CONFIG_HTTP_REDIRECT_USE_ORIG_CACHE_KEY</span>
<span class="n">TS_LUA_CONFIG_HTTP_ATTACH_SERVER_SESSION_TO_CLIENT</span>
<span class="n">TS_LUA_CONFIG_WEBSOCKET_NO_ACTIVITY_TIMEOUT</span>
<span class="n">TS_LUA_CONFIG_WEBSOCKET_ACTIVE_TIMEOUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_UNCACHEABLE_REQUESTS_BYPASS_PARENT</span>
<span class="n">TS_LUA_CONFIG_HTTP_PARENT_PROXY_TOTAL_CONNECT_ATTEMPTS</span>
<span class="n">TS_LUA_CONFIG_HTTP_TRANSACTION_ACTIVE_TIMEOUT_IN</span>
<span class="n">TS_LUA_CONFIG_SRV_ENABLED</span>
<span class="n">TS_LUA_CONFIG_HTTP_FORWARD_CONNECT_METHOD</span>
<span class="n">TS_LUA_CONFIG_SSL_CERT_FILENAME</span>
<span class="n">TS_LUA_CONFIG_SSL_CERT_FILEPATH</span>
<span class="n">TS_LUA_CONFIG_PARENT_FAILURES_UPDATE_HOSTDB</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IGNORE_ACCEPT_MISMATCH</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IGNORE_ACCEPT_LANGUAGE_MISMATCH</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IGNORE_ACCEPT_ENCODING_MISMATCH</span>
<span class="n">TS_LUA_CONFIG_HTTP_CACHE_IGNORE_ACCEPT_CHARSET_MISMATCH</span>
<span class="n">TS_LUA_CONFIG_HTTP_PARENT_PROXY_FAIL_THRESHOLD</span>
<span class="n">TS_LUA_CONFIG_HTTP_PARENT_PROXY_RETRY_TIME</span>
<span class="n">TS_LUA_CONFIG_HTTP_PER_PARENT_CONNECT_ATTEMPTS</span>
<span class="n">TS_LUA_CONFIG_HTTP_PARENT_CONNECT_ATTEMPT_TIMEOUT</span>
<span class="n">TS_LUA_CONFIG_HTTP_ALLOW_MULTI_RANGE</span>
<span class="n">TS_LUA_CONFIG_HTTP_REQUEST_BUFFER_ENABLED</span>
<span class="n">TS_LUA_CONFIG_HTTP_ALLOW_HALF_OPEN</span>
<span class="n">TS_LUA_CONFIG_SSL_CLIENT_VERIFY_SERVER</span>
<span class="n">TS_LUA_CONFIG_SSL_CLIENT_VERIFY_SERVER_POLICY</span>
<span class="n">TS_LUA_CONFIG_SSL_CLIENT_VERIFY_SERVER_PROPERTIES</span>
<span class="n">TS_LUA_CONFIG_SSL_CLIENT_SNI_POLICY</span>
<span class="n">TS_LUA_CONFIG_SSL_CLIENT_PRIVATE_KEY_FILENAME</span>
<span class="n">TS_LUA_CONFIG_SSL_CLIENT_CA_CERT_FILENAME</span>
<span class="n">TS_LUA_CONFIG_LAST_ENTRY</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-timeout-set">
<h3>ts.http.timeout_set<a class="headerlink" href="#ts-http-timeout-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.timeout_set(CONFIG, NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to overwrite the timeout settings.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">timeout_set</span><span class="p">(</span><span class="n">TS_LUA_TIMEOUT_DNS</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>    <span class="o">--</span> <span class="mi">30</span> <span class="n">ms</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="timeout-constants">
<h3>Timeout constants<a class="headerlink" href="#timeout-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_TIMEOUT_ACTIVE</span>
<span class="n">TS_LUA_TIMEOUT_DNS</span>
<span class="n">TS_LUA_TIMEOUT_CONNECT</span>
<span class="n">TS_LUA_TIMEOUT_NO_ACTIVITY</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-client-packet-mark-set">
<h3>ts.http.client_packet_mark_set<a class="headerlink" href="#ts-http-client-packet-mark-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.client_packet_mark_set(NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to set packet mark for client connection.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">client_packet_mark_set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-server-packet-mark-set">
<h3>ts.http.server_packet_mark_set<a class="headerlink" href="#ts-http-server-packet-mark-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.server_packet_mark_set(NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to set packet mark for server connection.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-client-packet-tos-set">
<h3>ts.http.client_packet_tos_set<a class="headerlink" href="#ts-http-client-packet-tos-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.client_packet_tos_set(NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to set packet tos for client connection.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-server-packet-tos-set">
<h3>ts.http.server_packet_tos_set<a class="headerlink" href="#ts-http-server-packet-tos-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.server_packet_tos_set(NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to set packet tos for server connection.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-client-packet-dscp-set">
<h3>ts.http.client_packet_dscp_set<a class="headerlink" href="#ts-http-client-packet-dscp-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.client_packet_dscp_set(NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to set packet dscp for client connection.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-server-packet-dscp-set">
<h3>ts.http.server_packet_dscp_set<a class="headerlink" href="#ts-http-server-packet-dscp-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.server_packet_dscp_set(NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to set packet dscp for server connection.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-enable-redirect">
<h3>ts.http.enable_redirect<a class="headerlink" href="#ts-http-enable-redirect" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.enable_redirect(NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to make transaction follow redirect</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">enable_redirect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-set-debug">
<h3>ts.http.set_debug<a class="headerlink" href="#ts-http-set-debug" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.set_debug(NUMBER)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to enable debug log for the transaction</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-cntl-get">
<h3>ts.http.cntl_get<a class="headerlink" href="#ts-http-cntl-get" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.http.cntl_get(CNTL_TYPE)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to retrieve the value of control channel.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">cntl_get</span><span class="p">(</span><span class="n">TS_LUA_HTTP_CNTL_GET_LOGGING_MODE</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-cntl-set">
<h3>ts.http.cntl_set<a class="headerlink" href="#ts-http-cntl-set" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.http.cntl_set(CNTL_TYPE, BOOL)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to set the value of control channel.</p>
<p>Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">do_remap</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">cntl_set</span><span class="p">(</span><span class="n">TS_LUA_HTTP_CNTL_SET_LOGGING_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>      <span class="o">--</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">log</span> <span class="n">the</span> <span class="n">request</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="http-control-channel-constants">
<h3>Http control channel constants<a class="headerlink" href="#http-control-channel-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_HTTP_CNTL_GET_LOGGING_MODE</span>
<span class="n">TS_LUA_HTTP_CNTL_SET_LOGGING_MODE</span>
<span class="n">TS_LUA_HTTP_CNTL_GET_INTERCEPT_RETRY_MODE</span>
<span class="n">TS_LUA_HTTP_CNTL_SET_INTERCEPT_RETRY_MODE</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-milestone-get">
<h3>ts.http.milestone_get<a class="headerlink" href="#ts-http-milestone-get" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.http.milestone_get(MILESTONE_TYPE)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to retrieve the various milestone times. They are how long the
transaction took to traverse portions of the HTTP state machine. Each milestone value is a fractional number
of seconds since the beginning of the transaction.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">milestone_get</span><span class="p">(</span><span class="n">TS_LUA_MILESTONE_SM_START</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="milestone-constants">
<h3>Milestone constants<a class="headerlink" href="#milestone-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_MILESTONE_UA_BEGIN</span>
<span class="n">TS_LUA_MILESTONE_UA_FIRST_READ</span>
<span class="n">TS_LUA_MILESTONE_UA_READ_HEADER_DONE</span>
<span class="n">TS_LUA_MILESTONE_UA_BEGIN_WRITE</span>
<span class="n">TS_LUA_MILESTONE_UA_CLOSE</span>
<span class="n">TS_LUA_MILESTONE_SERVER_FIRST_CONNECT</span>
<span class="n">TS_LUA_MILESTONE_SERVER_CONNECT</span>
<span class="n">TS_LUA_MILESTONE_SERVER_CONNECT_END</span>
<span class="n">TS_LUA_MILESTONE_SERVER_BEGIN_WRITE</span>
<span class="n">TS_LUA_MILESTONE_SERVER_FIRST_READ</span>
<span class="n">TS_LUA_MILESTONE_SERVER_READ_HEADER_DONE</span>
<span class="n">TS_LUA_MILESTONE_SERVER_CLOSE</span>
<span class="n">TS_LUA_MILESTONE_CACHE_OPEN_READ_BEGIN</span>
<span class="n">TS_LUA_MILESTONE_CACHE_OPEN_READ_END</span>
<span class="n">TS_LUA_MILESTONE_CACHE_OPEN_WRITE_BEGIN</span>
<span class="n">TS_LUA_MILESTONE_CACHE_OPEN_WRITE_END</span>
<span class="n">TS_LUA_MILESTONE_DNS_LOOKUP_BEGIN</span>
<span class="n">TS_LUA_MILESTONE_DNS_LOOKUP_END</span>
<span class="n">TS_LUA_MILESTONE_SM_START</span>
<span class="n">TS_LUA_MILESTONE_SM_FINISH</span>
<span class="n">TS_LUA_MILESTONE_PLUGIN_ACTIVE</span>
<span class="n">TS_LUA_MILESTONE_PLUGIN_TOTAL</span>
<span class="n">TS_LUA_MILESTONE_TLS_HANDSHAKE_START</span>
<span class="n">TS_LUA_MILESTONE_TLS_HANDSHAKE_END</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-http-txn-info-get">
<h3>ts.http.txn_info_get<a class="headerlink" href="#ts-http-txn-info-get" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.http.txn_info_get(TXN_INFO_TYPE)</em></p>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<p><strong>description:</strong> This function can be used to retrieve the various cache related info about a transaction.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">txn_info_get</span><span class="p">(</span><span class="n">TS_LUA_TXN_INFO_CACHE_HIT_RAM</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="txn-info-constants">
<h3>Txn Info constants<a class="headerlink" href="#txn-info-constants" title="Permalink to this headline">¶</a></h3>
<p><strong>context:</strong> do_global_cache_lookup_complete</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TS_LUA_TXN_INFO_CACHE_HIT_RAM</span>
<span class="n">TS_LUA_TXN_INFO_CACHE_COMPRESSED_IN_RAM</span>
<span class="n">TS_LUA_TXN_INFO_CACHE_HIT_RWW</span>
<span class="n">TS_LUA_TXN_INFO_CACHE_OPEN_READ_TRIES</span>
<span class="n">TS_LUA_TXN_INFO_CACHE_OPEN_WRITE_TRIES</span>
<span class="n">TS_LUA_TXN_INFo_CACHE_VOLUME</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-mgmt-get-counter">
<h3>ts.mgmt.get_counter<a class="headerlink" href="#ts-mgmt-get-counter" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.mgmt.get_counter(RECORD_NAME)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to retrieve the record value which has a counter type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">mgmt</span><span class="o">.</span><span class="n">get_counter</span><span class="p">(</span><span class="s1">&#39;proxy.process.http.incoming_requests&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-mgmt-get-int">
<h3>ts.mgmt.get_int<a class="headerlink" href="#ts-mgmt-get-int" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.mgmt.get_int(RECORD_NAME)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to retrieve the record value which has a int type.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-mgmt-get-float">
<h3>ts.mgmt.get_float<a class="headerlink" href="#ts-mgmt-get-float" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.mgmt.get_float(RECORD_NAME)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to retrieve the record value which has a float type.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-mgmt-get-string">
<h3>ts.mgmt.get_string<a class="headerlink" href="#ts-mgmt-get-string" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.mgmt.get_string(RECORD_NAME)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function can be used to retrieve the record value which has a string type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">mgmt</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="s1">&#39;proxy.config.product_name&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-mgmt-add-config-file">
<h3>ts.mgmt.add_config_file<a class="headerlink" href="#ts-mgmt-add-config-file" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>ts.mgmt.add_config_file(parent, filename)</em></p>
<p><strong>context:</strong> do_remap/do_os_response or do_global_* or later.</p>
<p><strong>description:</strong> This function invokes <code class="docutils literal notranslate"><span class="pre">TSMgmtConfigFileAdd</span></code> API.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">remap</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">mgmt</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="s1">&#39;proxy.config.url_remap.filename&#39;</span><span class="p">)</span>
<span class="n">ts</span><span class="o">.</span><span class="n">mgmt</span><span class="o">.</span><span class="n">add_config_file</span><span class="p">(</span><span class="n">remap</span><span class="p">,</span> <span class="s1">&#39;/etc/my.config&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-stat-create">
<h3>ts.stat_create<a class="headerlink" href="#ts-stat-create" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.stat_create(STAT_NAME, RECORDDATA_TYPE, PERSISTENT, SYNC)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> This function can be used to create a statistics record given the name, data type, persistent
requirement, and sync requirement. A statistics record table will be created with 4 functions to increment,
decrement, get and set the value.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stat</span><span class="p">:</span><span class="n">increment</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="n">stat</span><span class="p">:</span><span class="n">decrement</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">stat</span><span class="p">:</span><span class="n">get_value</span><span class="p">()</span>
<span class="n">stat</span><span class="p">:</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is an example.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">test_stat</span><span class="p">;</span>

<span class="n">function</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">test_stat</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">stat_create</span><span class="p">(</span><span class="s2">&quot;test_stat&quot;</span><span class="p">,</span>
      <span class="n">TS_LUA_RECORDDATATYPE_INT</span><span class="p">,</span>
      <span class="n">TS_LUA_STAT_PERSISTENT</span><span class="p">,</span>
      <span class="n">TS_LUA_STAT_SYNC_COUNT</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">do_global_read_request</span><span class="p">()</span>
    <span class="n">local</span> <span class="n">value</span> <span class="o">=</span> <span class="n">test_stat</span><span class="p">:</span><span class="n">get_value</span><span class="p">()</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">test_stat</span><span class="p">:</span><span class="n">increment</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="ts-stat-find">
<h3>ts.stat_find<a class="headerlink" href="#ts-stat-find" title="Permalink to this headline">¶</a></h3>
<p><strong>syntax:</strong> <em>val = ts.stat_find(STAT_NAME)</em></p>
<p><strong>context:</strong> global</p>
<p><strong>description:</strong> This function can be used to find a statistics record given the name. A statistics record table will
be returned with 4 functions to increment, decrement, get and set the value. That is similar to ts.stat_create()</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
</div>
<div class="section" id="todo">
<h2>Todo<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>ts.cache_xxx</li>
<li>protocol</li>
</ul>
<p>Currently when we use this as a global plugin, each global hook is using a separate lua state for the same
transaction. This can be wasteful. Also the state cannot be reused for the same transaction across the global hooks. The
alternative will be to use a TXN_START hook to create a lua state first and then add each global hook in the lua script
as transaction hook instead. But this will have problem down the road when we need to have multiple plugins to work
together in some proper orderings. In the future, we should consider different approach, such as creating and
maintaining the lua state in the ATS core.</p>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="notes-on-unit-testing-lua-scripts-for-ats-lua-plugin">
<h2>Notes on Unit Testing Lua scripts for ATS Lua Plugin<a class="headerlink" href="#notes-on-unit-testing-lua-scripts-for-ats-lua-plugin" title="Permalink to this headline">¶</a></h2>
<p>Follow the steps below to use busted framework to run some unit tests on sample scripts and modules</p>
<ul class="simple">
<li>Build and install lua 5.1.5 using the source code from here - <a class="reference external" href="http://www.lua.org/ftp/lua-5.1.tar.gz">http://www.lua.org/ftp/lua-5.1.tar.gz</a></li>
<li>Build and install luarocks 2.2.2 from here - <a class="reference external" href="https://github.com/keplerproject/luarocks/wiki/Download">https://github.com/keplerproject/luarocks/wiki/Download</a></li>
<li>Run “sudo luarocks install busted”</li>
<li>Run “sudo luarocks install luacov”</li>
<li>“cd trafficserver/plugins/lua/ci”</li>
<li>Run “busted -c module_test.lua; luacov”. It will produce “luacov.report.out” containing the code coverage for “module.lua”</li>
<li>Run “busted -c script_test.lua; luacov”. It will produce “luacov.report.out” containing the code coverage for “script.lua”</li>
</ul>
<p>Reference for further information</p>
<ul class="simple">
<li>Busted - <a class="reference external" href="http://olivinelabs.com/busted/">http://olivinelabs.com/busted/</a></li>
<li>Specifications for asserts/mocks/stubs/etc inside busted framework:
<a class="reference external" href="https://github.com/Olivine-Labs/luassert/tree/master/spec">https://github.com/Olivine-Labs/luassert/tree/master/spec</a></li>
<li>luacov - <a class="reference external" href="https://luarocks.org/modules/hisham/luacov">https://luarocks.org/modules/hisham/luacov</a></li>
</ul>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
<div class="section" id="more-docs">
<h2>More docs<a class="headerlink" href="#more-docs" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/portl4t/ts-lua">https://github.com/portl4t/ts-lua</a></li>
</ul>
<p><a class="reference internal" href="#admin-plugins-ts-lua"><span class="std std-ref">TOP</span></a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="regex_remap.en.html" class="btn btn-neutral float-right" title="Regex Remap Plugin" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="healthchecks.en.html" class="btn btn-neutral float-left" title="Health Checks Plugin" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, dev@trafficserver.apache.org

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>
 


</body>
</html>