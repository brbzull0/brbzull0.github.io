

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Certifier Plugin &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Cert Reporting Tool Plugin" href="cert_reporting_tool.en.html" />
    <link rel="prev" title="Access Control Plugin" href="access_control.en.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="certifier-plugin">
<span id="admin-plugins-certifier"></span><h1>Certifier Plugin<a class="headerlink" href="#certifier-plugin" title="Permalink to this headline">¶</a></h1>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">certifier</span></code> performs two basic tasks:</p>
<ol class="arabic simple">
<li>Load SSL certificates from file storage on demand. The total number of loaded certificates kept in memory can be configured.</li>
<li>Generates SSL certificates on demand. Generated certificates will be written to file storage for later retrieval.</li>
</ol>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>Certificates management is done by <cite>SslLRUList</cite> (a Least-Recently-Used (LRU) list with a lookup map). The structure holding all info related to a given SNI is <cite>SslData</cite>. On lookup/insertion, the lookup map will be accessed and the corresponding <cite>SslData</cite> pointer will be moved to the head in the list. If on lookup/insertion the internal count exceeds the given limit on number of files, the tail node will be removed from both the list and the map.</p>
<p>When the plugin sees an incoming HTTPS request, it does:</p>
<ol class="arabic simple">
<li>Look up the SNI in <cite>SslLRUList</cite> and set up the context if a valid context exists. Otherwise, it will schedule a thread to retrieve such context from disk (or generate). If such a thread is already scheduled, it will put this SSL connection onto the queue.</li>
<li>The retriever thread will first try to load the cert from disk. If no such certs exist and dynamic generation is enabled, the thread will generate a Certificate Signing Request (CSR) with provided SNI and sign it with root CA passed in from config options. The signed certificate is then written to the disk and all queued up SSL connections are set up with correct context and enabled.</li>
</ol>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>Cert and key:</dt>
<dd>For example, <code class="docutils literal notranslate"><span class="pre">openssl</span> <span class="pre">req</span> <span class="pre">-newkey</span> <span class="pre">rsa:2048</span> <span class="pre">-nodes</span> <span class="pre">-keyout</span> <span class="pre">ca.key</span> <span class="pre">-x509</span> <span class="pre">-days</span> <span class="pre">365</span> <span class="pre">-out</span> <span class="pre">ca.cert</span></code>. Note that the cert/key should be generated without a challenge password.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Serial number:</dt>
<dd>A text file containing a valid integer with a trailing new line.</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="plugin-configuration">
<h2>Plugin Configuration<a class="headerlink" href="#plugin-configuration" title="Permalink to this headline">¶</a></h2>
<ul>
<li><dl class="first docutils">
<dt>Specify certificate generation related files. If any of the following parameters is missing, the dynamic generation will be disabled.</dt>
<dd><dl class="first option">
<dt id="cmdoption-certifier-so-sign-cert">
<code class="descname">--sign-cert</code><code class="descclassname"> &lt;path_to_certificate&gt;</code><a class="headerlink" href="#cmdoption-certifier-so-sign-cert" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>(<cite>optional</cite>, default:empty/unused) - specifies the path to the root CA certificate. In most cases, this would be a self-signed certificate that is configured to be trusted by all potential clients. Path should be the path and file name of the cert. If it is relative, it is relative to the Traffic Server configuration directory.</p>
<dl class="option">
<dt id="cmdoption-certifier-so-sign-key">
<code class="descname">--sign-key</code><code class="descclassname"> &lt;path_to_key&gt;</code><a class="headerlink" href="#cmdoption-certifier-so-sign-key" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>(<cite>optional</cite>, default:empty/unused) - specifies the path to the root CA private key. In most cases, this would be generated alongside the self-signed root CA certificate.</p>
<dl class="option">
<dt id="cmdoption-certifier-so-sign-serial">
<code class="descname">--sign-serial</code><code class="descclassname"> &lt;path_to_serial&gt;</code><a class="headerlink" href="#cmdoption-certifier-so-sign-serial" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p class="last">(<cite>optional</cite>, default:empty/unused) - specifies the path to the serial number file. This will be used to assign serial numbers to certificates and keep all generated ones in sync. Serial file should be a number with a trailing newline.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Specify the certificates management related settings.</dt>
<dd><dl class="first option">
<dt id="cmdoption-certifier-so-store">
<code class="descname">--store</code><code class="descclassname"> &lt;path_to_certs_dir&gt;</code><a class="headerlink" href="#cmdoption-certifier-so-store" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>(<cite>required</cite>, default:empty) - specifies the directory to use as the root of file system certificates storage.</p>
<dl class="option">
<dt id="cmdoption-certifier-so-max">
<code class="descname">--max</code><code class="descclassname"> &lt;N&gt;</code><a class="headerlink" href="#cmdoption-certifier-so-max" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p class="last">(<cite>required</cite>, default:empty) - specifies the upper limit on number of files kept in memory.</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="example-usage">
<h2>Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h2>
<p>To use this plugin, enable it in a <a class="reference internal" href="../files/plugin.config.en.html#std:configfile-plugin.config"><code class="xref std std-file docutils literal notranslate"><span class="pre">plugin.config</span></code></a> rule, specifying certificates storage path, max number of certificates in memory, and signing cert+key+serial. For example:</p>
<blockquote>
<div>certifier.so –store=/home/zeyuan/certifier/certs –max=1000 –sign-cert=/home/zeyuan/certifier/root-ca.crt –sign-key=/home/zeyuan/certifier/root-ca.key –sign-serial=/home/zeyuan/certifier/ca-serial.txt</div></blockquote>
<p>One use case would be routing incoming CONNECT request to another port on traffic server. With the certifier generating a trusted certificate, other plugins can act with a similar behavior to Man-In-The-Middle (logging interesting data for example).</p>
<div class="figure align-center">
<p class="plantuml">
<object data="../../_images/plantuml-9113ea2d495b0b7ac3b44475d8f690a306e7f32d.svg" type="image/svg+xml" style="width:492px;height:542px;">
<img src="../../_images/plantuml-9113ea2d495b0b7ac3b44475d8f690a306e7f32d.png" alt="actor User
participant Traffic_Server
participant Origin_Server
User -&gt; Traffic_Server: CONNECT request
Traffic_Server -&gt; Traffic_Server: Route CONNECT\nback to self
User -&gt; Traffic_Server: Client Hello
Traffic_Server -&gt; User: Server Hello with fake certs from certifier
User -&gt; Traffic_Server: ClientKeyExchange ChangeCipherSpec
Traffic_Server -&gt; User: ChangeCipherSpec
User &lt;-&gt; Traffic_Server: Tunnel established
User -&gt; Traffic_Server: User request via tunnel
Traffic_Server -&gt; Origin_Server: Request
Origin_Server -&gt; Traffic_Server: Response
Traffic_Server -&gt; User: TS response via tunnel"/>

</object></p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.en.html">Installing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration/index.en.html">Proxy Cache Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interaction/index.en.html">Interacting with Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.en.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.en.html">Cache Storage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.en.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring/index.en.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuring-traffic-server.en.html">Configuring Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layer-4-routing.en.html">Layer 4 Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.en.html">Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files/index.en.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.en.html#audience">Audience</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-guide/index.en.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.en.html">Administrator’s Guide</a><ul>
  <li><a href="index.en.html">Plugins</a><ul>
      <li>Previous: <a href="access_control.en.html" title="previous chapter">Access Control Plugin</a></li>
      <li>Next: <a href="cert_reporting_tool.en.html" title="next chapter">Cert Reporting Tool Plugin</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/plugins/certifier.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>