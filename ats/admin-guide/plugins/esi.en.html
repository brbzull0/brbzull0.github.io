


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ESI Plugin &mdash; Apache Traffic Server 10.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Escalate Plugin" href="escalate.en.html" />
    <link rel="prev" title="Cookie Based Routing Inside TrafficServer Using cookie_remap" href="cookie_remap.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Apache Traffic Server
          

          
            
            <img src="../../_static/trans_logo_tm_380x69.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                10.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.en.html">Installing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration/index.en.html">Proxy Cache Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interaction/index.en.html">Interacting with Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.en.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.en.html">Cache Storage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Plugins</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.en.html#overview">Overview</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.en.html#stable-plugins">Stable plugins</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="s3_auth.en.html">AWS S3 Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="authproxy.en.html">AuthProxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="background_fetch.en.html">Background Fetch</a></li>
<li class="toctree-l4"><a class="reference internal" href="cachekey.en.html">Cache Key Manipulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="cache_promote.en.html">Cache Promotion Policies</a></li>
<li class="toctree-l4"><a class="reference internal" href="cache_range_requests.en.html">Cache Range Requests</a></li>
<li class="toctree-l4"><a class="reference internal" href="combo_handler.en.html">Combo Handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="conf_remap.en.html">Configuration Remap</a></li>
<li class="toctree-l4"><a class="reference internal" href="cookie_remap.en.html">Cookie Remap</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">ESI</a></li>
<li class="toctree-l4"><a class="reference internal" href="escalate.en.html">Escalate</a></li>
<li class="toctree-l4"><a class="reference internal" href="compress.en.html">Compress</a></li>
<li class="toctree-l4"><a class="reference internal" href="generator.en.html">Generator</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_rewrite.en.html">Header Rewrite</a></li>
<li class="toctree-l4"><a class="reference internal" href="healthchecks.en.html">Health Checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="lua.en.html">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="regex_remap.en.html">Regex Remap</a></li>
<li class="toctree-l4"><a class="reference internal" href="regex_revalidate.en.html">Regex Revalidate</a></li>
<li class="toctree-l4"><a class="reference internal" href="remap_purge.en.html">Remap Purge</a></li>
<li class="toctree-l4"><a class="reference internal" href="stats_over_http.en.html">Stats over HTTP</a></li>
<li class="toctree-l4"><a class="reference internal" href="tcpinfo.en.html">TCPInfo</a></li>
<li class="toctree-l4"><a class="reference internal" href="xdebug.en.html">XDebug</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.en.html#experimental-plugins">Experimental plugins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.en.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring/index.en.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuring-traffic-server.en.html">Configuring Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layer-4-routing.en.html">Layer 4 Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.en.html">Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files/index.en.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.en.html#audience">Audience</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-guide/index.en.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apache Traffic Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.en.html">Administrator’s Guide</a> &raquo;</li>
        
          <li><a href="index.en.html">Plugins</a> &raquo;</li>
        
      <li>ESI Plugin</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/admin-guide/plugins/esi.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="esi-plugin">
<span id="admin-plugins-esi"></span><h1>ESI Plugin<a class="headerlink" href="#esi-plugin" title="Permalink to this headline">¶</a></h1>
<p>This plugin implements the ESI specification.</p>
<div class="section" id="specification">
<h2>Specification<a class="headerlink" href="#specification" title="Permalink to this headline">¶</a></h2>
<p>Supported ESI tags:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>esi:include
esi:remove
esi:comment
esi:vars
esi:choose
esi:when
esi:otherwise
esi:try
esi:attempt
esi:except
&lt;!--esi ... --&gt;
</pre></div>
</div>
<p>extended ESI tags: <em>esi:special-include</em></p>
<p>Supported variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$(HTTP_HOST)
$(HTTP_REFERER)
$(HTTP_ACCEPT_LANGUAGE{name})
$(HTTP_COOKIE{name}) or $(HTTP_COOKIE{name;subkey})
$(QUERY_STRING{name})
$(HTTP_HEADER{hdr_name})
</pre></div>
</div>
<p>Note: the name is the key name such as “username”, “id” etc. For cookie support sub-name or sub-key, the format is:
name;subkey, such as “l;u”, “l;t” etc. e.g. such cookie string: l=u=test&amp;t=1350952328, the value of
$(HTTP_COOKIE{“l;u”}) is test and the value of $(HTTP_COOKIE{“l;t”}) is 1350952328</p>
</div>
<div class="section" id="compile-and-installation">
<h2>Compile and Installation<a class="headerlink" href="#compile-and-installation" title="Permalink to this headline">¶</a></h2>
<p>This plugin is only built if the configure option</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">experimental</span><span class="o">-</span><span class="n">plugins</span>
</pre></div>
</div>
<p>is given at build time. Note that this plugin is built and installed in combination with the combo handler module, since
they share common code.</p>
</div>
<div class="section" id="enabling-esi">
<h2>Enabling ESI<a class="headerlink" href="#enabling-esi" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>First we need to set up /usr/local/etc/trafficserver/plugin.config and make sure the following line is present.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">esi</span><span class="o">.</span><span class="n">so</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>There are four options you can add to the above.</li>
</ol>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">--private-response</span></code> will add private cache control and expires header to the processed ESI document.</li>
<li><code class="docutils literal notranslate"><span class="pre">--packed-node-support</span></code> will enable the support for using packed node, which will improve the performance of parsing
cached ESI document.</li>
<li><code class="docutils literal notranslate"><span class="pre">--disable-gzip-output</span></code> will disable gzipped output, which will NOT gzip the output anyway.</li>
<li><code class="docutils literal notranslate"><span class="pre">--first-byte-flush</span></code> will enable the first byte flush feature, which will flush content to users as soon as the entire
ESI document is received and parsed without all ESI includes fetched (the flushing will stop at the ESI include markup
till that include is fetched).</li>
</ul>
<ol class="arabic simple" start="3">
<li>HTTP_COOKIE variable supported is turned off by default. You can turn it on with ‘-f’ or ‘-handler option’</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">esi</span><span class="o">.</span><span class="n">so</span> <span class="o">-</span><span class="n">f</span> <span class="n">handler</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>And inside handler.conf you can provide the list of cookie name that is allowed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">allowlistCookie</span> <span class="n">A</span>
<span class="n">allowlistCookie</span> <span class="n">LOGIN</span>
</pre></div>
</div>
<p>We can also allow all cookie for HTTP_COOKIE variable by using a wildcard character. e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">allowlistCookie</span> <span class="o">*</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>We need a mapping for origin server response that contains the ESI markup. Assume that the ATS server is abc.com. And your origin server is xyz.com and the response containing ESI markup is <a class="reference external" href="http://xyz.com/esi.php">http://xyz.com/esi.php</a>. We will need
the following line in /usr/local/etc/trafficserver/remap.config</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">abc</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">esi</span><span class="o">.</span><span class="n">php</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">xyz</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">esi</span><span class="o">.</span><span class="n">php</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li>Your response should contain ESI markup and a response header of ‘X-Esi: 1’. e.g. using PHP,</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?php   header(&#39;X-Esi: 1&#39;); ?&gt;
&lt;html&gt;
&lt;body&gt;
Hello, &lt;esi:include src=&quot;http://abc.com/date.php&quot;/&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li>You will need a mapping for the src of the ESI include in remap.config if it is not already present.</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">abc</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">date</span><span class="o">.</span><span class="n">php</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">xyz</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">date</span><span class="o">.</span><span class="n">php</span>
</pre></div>
</div>
<p>Or if both your ESI response and the ESI include comes from the same origin server, you can have the following line in
remap.config instead to replace separate map rules for date.php and esi.php</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">map</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">abc</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">xyz</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li>Here is a sample PHP for date.php</li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?php
header (&quot;Cache-control: no-cache&quot;);
echo date(&#39;l jS \of F Y h:i:s A&#39;);
?&gt;
</pre></div>
</div>
</div>
<div class="section" id="useful-note">
<h2>Useful Note<a class="headerlink" href="#useful-note" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>You can provide proper cache control header and the ESI response and ESI include response can be cached separately.
It is extremely useful for rendering page with multiple modules. The page layout can be a ESI response with multiple
ESI includes, each for a different module. The page layout ESI response can be cached and each individual ESI
included can also be cached with a different duration.</li>
<li>You should run the plugin without using “packed node support” because it is not fully tested.</li>
</ol>
</div>
<div class="section" id="differences-from-spec-http-www-w3-org-tr-esi-lang">
<h2>Differences from Spec - <a class="reference external" href="http://www.w3.org/TR/esi-lang">http://www.w3.org/TR/esi-lang</a><a class="headerlink" href="#differences-from-spec-http-www-w3-org-tr-esi-lang" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>&lt;esi:include&gt; does not support “alt” and “onerror” attributes</li>
<li>&lt;esi:inline&gt; is not supported</li>
<li>You cannot have &lt;esi:try&gt; inside another &lt;esi:try&gt;</li>
<li>HTTP_USER_AGENT variable is not supported</li>
<li>HTTP_COOKIE supports fetching for sub-key</li>
<li>HTTP_HEADER supports accessing request headers as variables except “Cookie”</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="escalate.en.html" class="btn btn-neutral float-right" title="Escalate Plugin" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cookie_remap.en.html" class="btn btn-neutral float-left" title="Cookie Based Routing Inside TrafficServer Using cookie_remap" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, dev@trafficserver.apache.org

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>
 


</body>
</html>