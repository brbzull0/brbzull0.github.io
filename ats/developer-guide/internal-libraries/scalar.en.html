


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TS.Scalar &mdash; Apache Traffic Server 10.0.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="BufferWriter" href="buffer-writer.en.html" />
    <link rel="prev" title="MemSpan" href="MemSpan.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Apache Traffic Server
          

          
            
            <img src="../../_static/trans_logo_tm_380x69.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                10.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Internal libraries</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="TextView.en.html">TextView</a></li>
<li class="toctree-l3"><a class="reference internal" href="MemSpan.en.html">MemSpan</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">TS.Scalar</a></li>
<li class="toctree-l3"><a class="reference internal" href="#definition">Definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#assignment">Assignment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arithmetic">Arithmetic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#advanced-features">Advanced Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#examples">Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#design-notes">Design Notes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="buffer-writer.en.html">BufferWriter</a></li>
<li class="toctree-l3"><a class="reference internal" href="intrusive-list.en.html">IntrusiveDList</a></li>
<li class="toctree-l3"><a class="reference internal" href="intrusive-list.en.html#definition">Definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="intrusive-list.en.html#usage">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="intrusive-list.en.html#design-notes">Design Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="intrusive-hash-map.en.html">IntrusiveHashMap</a></li>
<li class="toctree-l3"><a class="reference internal" href="intrusive-hash-map.en.html#usage">Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="intrusive-hash-map.en.html#details">Details</a></li>
<li class="toctree-l3"><a class="reference internal" href="intrusive-hash-map.en.html#design-notes">Design Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="MemArena.en.html">MemArena</a></li>
<li class="toctree-l3"><a class="reference internal" href="AcidPtr.en.html">AcidPtr &amp; AcidCommitPtr</a></li>
<li class="toctree-l3"><a class="reference internal" href="Extendible.en.html">Extendible</a></li>
<li class="toctree-l3"><a class="reference internal" href="ArgParser.en.html">ArgParser</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/index.en.html">Plugin Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apache Traffic Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.en.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="index.en.html">Internal libraries</a> &raquo;</li>
        
      <li>TS.Scalar</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/developer-guide/internal-libraries/scalar.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ts-scalar">
<h1>TS.Scalar<a class="headerlink" href="#ts-scalar" title="Permalink to this headline">¶</a></h1>
<p>TS.Scalar is a header only library that provides scaled and typed numerical values. Using TS.Scalar
starts with defining types which have a <em>scale factor</em> and optionally a <em>tag</em>. Values in an instance
of TS.Scalar are always multiples of the scale factor.</p>
<p>The tag is used to create categories of related types, the same underlying “metric” at different scales. To enforce this TS.Scalar does not allow assignment between instances with different tags. If this is not important the tag can be omitted and a default generic one will be used, thereby allowing arbitrary assignments.</p>
<p>TS.Scalar is designed to be fast and efficient. When converting between similar types with different
scales it will do the minimum amount of work while minimizing the risk of integer overflow. Instances
have the same memory footprint as the underlying integer storage type. It is intended to replace
lengthy and error prone hand optimizations used to handle related values of different scales.</p>
</div>
<div class="section" id="definition">
<h1>Definition<a class="headerlink" href="#definition" title="Permalink to this headline">¶</a></h1>
<p>TS.Scalar consists primarily of the template class <code class="code docutils literal notranslate"><span class="pre">Scalar</span></code>. Instances of <a class="reference internal" href="#_CPPv4I_8intmax_t00E6Scalar" title="Scalar"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Scalar</span></code></a> hold
a <em>count</em> and represent a <em>value</em> which is the <em>count</em> multiplied by <em>SCALE</em>. Note this
quantizes the values that can be represented by an instance.</p>
<dl class="cpp class">
<dt id="_CPPv4I_8intmax_t00E6Scalar">
<span id="_CPPv3I_8intmax_t00E6Scalar"></span><span id="_CPPv2I_8intmax_t00E6Scalar"></span>template&lt;<a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv48intmax_t" title="intmax_t">intmax_t</a> <code class="sig-name descname">SCALE</code>, typename <code class="sig-name descname">C</code>, typename <code class="sig-name descname">TAG</code>&gt;<br /><em class="property">class </em><code class="sig-name descname">Scalar</code><a class="headerlink" href="#_CPPv4I_8intmax_t00E6Scalar" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>A quantized integral with a distinct type.</p>
<dl class="field-list simple">
<dt class="field-odd">Template Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>SCALE</strong> – Scaling factor.</p></li>
<li><p><strong>C</strong> – Base storage type.</p></li>
<li><p><strong>TAG</strong> – Distinguishing type tag.</p></li>
</ul>
</dd>
</dl>
<dl class="cpp type">
<dt id="_CPPv4N6Scalar7COUNTERE">
<span id="_CPPv3N6Scalar7COUNTERE"></span><span id="_CPPv2N6Scalar7COUNTERE"></span><span id="Scalar::COUNTER"></span><em class="property">type </em><code class="sig-name descname">COUNTER</code><a class="headerlink" href="#_CPPv4N6Scalar7COUNTERE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Imported template parameter <em>C</em>.</p>
</dd></dl>

<p>The scaling factor <em>SCALE</em> must be an positive integer. Values for an instance will always
be an integral multiple of <em>SCALE</em>. The value of an instance will always be a
multiple of <em>SCALE</em>.</p>
<p><em>C</em> must be an integral type. An instance of this type is used to hold the internal
count.It can be omitted and will default to <code class="code docutils literal notranslate"><span class="pre">int</span></code>. The size of an instance is the same size
as <em>C</em> and an instance of that type can be replaced with a <a class="reference internal" href="#_CPPv4I_8intmax_t00E6Scalar" title="Scalar"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Scalar</span></code></a> of that size
without changing the memory layout.</p>
<p><em>TAG</em> must be a type. It can be omitted and will default to <code class="code docutils literal notranslate"><span class="pre">tag::generic</span></code>. <em>TAG</em>
is a mechanism for preventing accidental cross assignments. Assignment of any sort from a
<a class="reference internal" href="#_CPPv4I_8intmax_t00E6Scalar" title="Scalar"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Scalar</span></code></a> instance to another instance with a different <em>TAG</em> is a compile time error.
If this isn’t useful <em>TAG</em> can be omitted and will default to <code class="code docutils literal notranslate"><span class="pre">tag::generic</span></code> which
will enable all instances to interoperate.</p>
<p>The type used for <em>TAG</em> can be defined in name only.:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">YoureIt</span><span class="p">;</span> <span class="c1">// no other information about YoureIt is required.</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">YoureIt</span><span class="o">&gt;</span> <span class="n">HectoTouch</span><span class="p">;</span> <span class="c1">// how many hundreds of touches.</span>
</pre></div>
</div>
<dl class="cpp function">
<dt id="_CPPv4NK6Scalar5countEv">
<span id="_CPPv3NK6Scalar5countEv"></span><span id="_CPPv2NK6Scalar5countEv"></span><span id="Scalar::countC"></span><a class="reference internal" href="#_CPPv4N6Scalar7COUNTERE" title="Scalar::COUNTER">COUNTER</a> <code class="sig-name descname">count</code><span class="sig-paren">(</span><span class="sig-paren">)</span> <em class="property">const</em><a class="headerlink" href="#_CPPv4NK6Scalar5countEv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return the internal count.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv4N6Scalar6assignE7COUNTER">
<span id="_CPPv3N6Scalar6assignE7COUNTER"></span><span id="_CPPv2N6Scalar6assignE7COUNTER"></span><span id="Scalar::assign__COUNTER"></span><a class="reference internal" href="#_CPPv4I_8intmax_t00E6Scalar" title="Scalar">Scalar</a> &amp;<code class="sig-name descname">assign</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4N6Scalar7COUNTERE" title="Scalar::COUNTER">COUNTER</a> <em>c</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N6Scalar6assignE7COUNTER" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Set the count to <em>c</em>.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<p>In normal use a scalar evaluates to its value rather than its count. The goal is to provide an
instance that appears to store unscaled values in a quantized way. The count is accessible if
needed.</p>
<div class="section" id="assignment">
<h2>Assignment<a class="headerlink" href="#assignment" title="Permalink to this headline">¶</a></h2>
<p>Assigning values to, from, and between <a class="reference internal" href="#_CPPv4I_8intmax_t00E6Scalar" title="Scalar"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Scalar</span></code></a> instances is usually straightforward with a few simple rules.</p>
<ul class="simple">
<li><p>The <a class="reference internal" href="#_CPPv4N6Scalar6assignE7COUNTER" title="Scalar::assign"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Scalar::assign()</span></code></a> is used to directly assign a count.</p></li>
<li><p>The increment and decrement operators, and the <code class="code docutils literal notranslate"><span class="pre">inc</span></code> and <code class="code docutils literal notranslate"><span class="pre">dec</span></code> methods, operate on the count.</p></li>
<li><p>All other contexts use the value.</p></li>
<li><p>The assignment operator will scale if this can be done without loss, otherwise it is a compile error.</p></li>
<li><p>Untyped integer values are treated as having a <em>SCALE</em> of 1.</p></li>
</ul>
<p>If the assignment of one scalar to another is not lossless (e.g. the left hand side of the assignment has a large scale than the right hand side) one of the two following free functions must be used to indicate how to handle the loss.</p>
<dl class="cpp function">
<dt id="_CPPv48round_up6Scalar">
<span id="_CPPv38round_up6Scalar"></span><span id="_CPPv28round_up6Scalar"></span><span id="round_up__Scalar"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv416unspecified_type" title="unspecified_type">unspecified_type</a> <code class="sig-name descname">round_up</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4I_8intmax_t00E6Scalar" title="Scalar">Scalar</a> <em>v</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv48round_up6Scalar" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return a wrapper that indicates <em>v</em> should be rounded up as needed.</p>
</dd></dl>

<dl class="cpp function">
<dt id="_CPPv410round_down6Scalar">
<span id="_CPPv310round_down6Scalar"></span><span id="_CPPv210round_down6Scalar"></span><span id="round_down__Scalar"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv416unspecified_type" title="unspecified_type">unspecified_type</a> <code class="sig-name descname">round_down</code><span class="sig-paren">(</span><a class="reference internal" href="#_CPPv4I_8intmax_t00E6Scalar" title="Scalar">Scalar</a> <em>vs</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv410round_down6Scalar" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Return a wrapper that indicates <em>v</em> should be rounded down as needed.</p>
</dd></dl>

<p>To illustrate, suppose there were the definitions</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">&gt;</span> <span class="n">deka</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span> <span class="n">hecto</span><span class="p">;</span>
</pre></div>
</div>
<p>An assignment of a <code class="code docutils literal notranslate"><span class="pre">hecto</span></code> to a <code class="code docutils literal notranslate"><span class="pre">deka</span></code> is implicit as the scaling is lossless.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">hecto</span> <span class="nf">a</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>
<span class="n">deka</span> <span class="n">b</span><span class="p">;</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="c1">// compiles.</span>
</pre></div>
</div>
<p>The opposite is not implicit because the value of a <code class="code docutils literal notranslate"><span class="pre">deka</span></code> can be one not representable by a <code class="code docutils literal notranslate"><span class="pre">hecto</span></code>. In such a case it would have to be rounded, either up or down.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">143</span><span class="p">);</span> <span class="c1">// b gets the value 1430</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span> <span class="c1">// compile error</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="c1">// a has count 15 and value 1500</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">round_up</span></code> and <code class="code docutils literal notranslate"><span class="pre">round_down</span></code> can also be used with basic integers.</p>
<dl class="cpp function">
<dt id="_CPPv410round_down8intmax_t">
<span id="_CPPv310round_down8intmax_t"></span><span id="_CPPv210round_down8intmax_t"></span><span id="round_down__intmax_t"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv416unspecified_type" title="unspecified_type">unspecified_type</a> <code class="sig-name descname">round_down</code><span class="sig-paren">(</span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv48intmax_t" title="intmax_t">intmax_t</a><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv410round_down8intmax_t" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<dl class="cpp function">
<dt id="_CPPv48round_up8intmax_t">
<span id="_CPPv38round_up8intmax_t"></span><span id="_CPPv28round_up8intmax_t"></span><span id="round_up__intmax_t"></span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv416unspecified_type" title="unspecified_type">unspecified_type</a> <code class="sig-name descname">round_up</code><span class="sig-paren">(</span><a class="reference internal" href="../api/types/SystemTypes.en.html#_CPPv48intmax_t" title="intmax_t">intmax_t</a><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv48round_up8intmax_t" title="Permalink to this definition">¶</a><br /></dt>
<dd></dd></dl>

<p>Note this is very different from using <a class="reference internal" href="#_CPPv4N6Scalar6assignE7COUNTER" title="Scalar::assign"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">Scalar::assign()</span></code></a>. The latter sets the <em>count</em> of
the scalar instance. <code class="code docutils literal notranslate"><span class="pre">round_up</span></code> and <code class="code docutils literal notranslate"><span class="pre">round_down</span></code> set the <em>value</em> of the scalar, dividing
the provided value by the scale to set the count to make the value match the assignment as closely
as possible.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">round_down</span><span class="p">(</span><span class="mi">2480</span><span class="p">);</span> <span class="c1">// a has count 24, value 2400.</span>
</pre></div>
</div>
</div>
<div class="section" id="arithmetic">
<h2>Arithmetic<a class="headerlink" href="#arithmetic" title="Permalink to this headline">¶</a></h2>
<p>Arithmetic with scalars is based on the idea that a scalar represents its value. This value retains the
scalar type for conversion checking but otherwise acts as the value. This makes using scalar
instances as integral arguments to other functions simple. For instance consider following the
definition.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">SerializedData</span> <span class="p">{</span> <span class="p">...};</span>
<span class="k">using</span> <span class="n">Sector</span> <span class="o">=</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">512</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>To allocate a buffer large enough for a <code class="code docutils literal notranslate"><span class="pre">SerializedData</span></code> that is also a multiple of a sector would be</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Sector</span> <span class="n">n</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">serialized_data</span><span class="p">));</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</pre></div>
</div>
<p>Or more directly</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">Sector</span><span class="p">(</span><span class="n">round_up</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">serialized_data</span><span class="p">))));</span>
</pre></div>
</div>
<p>TS.Scalar is designed to be easy to use but when using multiple scales simultaneously, especially in the same expression, the computed type can be surprising. The best approach is to be explicit - a TS.Scalar instance is very inexpensive to create (at most 1 integer copy) therefore subexpressions can easily be forced to a specific scale by constructing the appropriate scalar with <code class="code docutils literal notranslate"><span class="pre">round_up</span></code> or <code class="code docutils literal notranslate"><span class="pre">round_down</span></code> of the subexpression. Or, define a unit scale type and convert to that as the common type before converting the result to the desired scale.</p>
</div>
<div class="section" id="advanced-features">
<h2>Advanced Features<a class="headerlink" href="#advanced-features" title="Permalink to this headline">¶</a></h2>
<p>TS.Scalar has a few advanced features which are not usually needed and for which usable defaults are
provided. This is not always the case and therefore access to the machinery is provided.</p>
<div class="section" id="i-o">
<h3>I/O<a class="headerlink" href="#i-o" title="Permalink to this headline">¶</a></h3>
<p>When a scalar is printed it prints out as its value, not count. For a family of scalars it can be
desirable to have the type printed along with the value. This can be done by adding a member named
<code class="docutils literal notranslate"><span class="pre">label</span></code> to the <em>tag</em> type of the scalar. If the <code class="docutils literal notranslate"><span class="pre">label</span></code> member can be provided to
an I/O stream then it will be after the value of the scalar. Otherwise it is ignored. An example can
be found in the &lt;Bytes&gt;_ section of the example usage.</p>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>The expected common use of TS.Scalar is to create a family of scalars representing the same
underlying unit of measure, differing only in scale. The standard example of this is computer memory
sizes which have this property and are quite frequently used in Traffic Server.</p>
<div class="section" id="bytes">
<h3>Bytes<a class="headerlink" href="#bytes" title="Permalink to this headline">¶</a></h3>
<p>The initial use of <a class="reference internal" href="#_CPPv4I_8intmax_t00E6Scalar" title="Scalar"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">Scalar</span></code></a> will be in the cache component. This has already been tested in some experimental work which will in time be blended back in to the main codebase. The use will be to represent different amounts of data, in memory and on disk.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="n">tag</span> <span class="p">{</span> <span class="k">struct</span> <span class="n">bytes</span> <span class="p">{</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">label</span> <span class="o">=</span> <span class="s">&quot; bytes&quot;</span><span class="p">;</span> <span class="p">};</span> <span class="p">}</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">bytes</span><span class="o">&gt;</span> <span class="n">Bytes</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">512</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">bytes</span><span class="o">&gt;</span> <span class="n">CacheDiskBlocks</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">1024</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">byteds</span><span class="o">&gt;</span> <span class="n">KB</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">8</span> <span class="o">*</span> <span class="n">KB</span><span class="o">::</span><span class="n">SCALE</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">bytes</span><span class="o">&gt;</span> <span class="n">CacheStoreBlocks</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">KB</span><span class="o">::</span><span class="n">SCALE</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">bytes</span><span class="o">&gt;</span> <span class="n">MB</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">128</span> <span class="o">*</span> <span class="n">MB</span><span class="o">::</span><span class="n">SCALE</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">bytes</span><span class="o">&gt;</span> <span class="n">CacheStripeBlocks</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">MB</span><span class="o">::</span><span class="n">SCALE</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">bytes</span><span class="o">&gt;</span> <span class="n">GB</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">GB</span><span class="o">::</span><span class="n">SCALE</span><span class="p">,</span> <span class="kt">off_t</span><span class="p">,</span> <span class="n">tag</span><span class="o">::</span><span class="n">bytes</span><span class="o">&gt;</span> <span class="n">TB</span>
</pre></div>
</div>
<p>This collection of types represents the data size units of interest to the cache and therefore enables to code to be much clearer about the units and to avoid errors in converting from one to another.</p>
<p>A common task is to add sizes together and round up to a multiple of some fixed size. One example is the stripe header data, which is stored as a multiple of 8192 bytes, that is a number of <code class="code docutils literal notranslate"><span class="pre">CacheStripeBlocks</span></code>. That can be done with</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">header</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CacheStripMeta</span><span class="p">)</span> <span class="o">+</span> <span class="n">segment_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SegmentFreeListHead</span><span class="p">));</span>
</pre></div>
</div>
<p>vs. the original code with magic constants and the hope that the value is scaled as you think it is.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">header</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">(((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CacheStripeMeta</span><span class="p">)</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">segments</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SegmentFreeListHead</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">STORE_BLOCK_SHIFT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">STORE_BLOCK_SHIFT</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="esoteric-uses">
<h3>Esoteric Uses<a class="headerlink" href="#esoteric-uses" title="Permalink to this headline">¶</a></h3>
<p>Scalar type can be useful even with only temporaries. For instance, to round to the nearest 100.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">round_100</span><span class="p">(</span><span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Scalar</span><span class="o">&lt;</span><span class="mi">100</span><span class="o">&gt;</span><span class="p">(</span><span class="n">round_up</span><span class="p">(</span><span class="n">y</span><span class="p">));</span> <span class="p">}</span>
</pre></div>
</div>
<p>This could also be done in line just as well avoiding the boiler plate logic.</p>
</div>
</div>
<div class="section" id="design-notes">
<h2>Design Notes<a class="headerlink" href="#design-notes" title="Permalink to this headline">¶</a></h2>
<p>The semantics of arithmetic were the most vexing issue in building this library. The ultimate
problem is that addition to the count and to the value are both reasonable and common operations and
different users may well have different expectations of which is more “natural” when operating with
a scalar and a raw numeric value. In practice my conclusion was that even before feeling “natural”
the library should avoid surprise. Therefore the ambiguity of arithmetic with non-scalars was
avoided by not permitting those operations, even though it can mean a bit more work on the part of
the library user. The increment / decrement and compound assignment operators were judged sufficient
similar to pointer arithmetic to be unsurprising in this context. This was further influenced by the
fact that, in general, these operators are useless in the value context. E.g. if a scalar has a
scale greater than 1 (the common case) then increment and decrement of the value is always a null
operation. Once those operators are used on the count is least surprising that the compound
operators act in the same way. The next step, to arithmetic operators, is not so clear and so those
require explicit scale indicators, such as <code class="code docutils literal notranslate"><span class="pre">round_down</span></code> or explicit constructors. It was a
design goal to avoid, as much as possible, the requirement that the library user keep track of the
scale of specific variables. This has proved very useful in practice, but at the same time when
doing arithmetic is almost always the case that either the values are both scalars (making the
arithmetic unambiguous) or the scale of the literal is known (e.g., “add 6 kilobytes”).</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="buffer-writer.en.html" class="btn btn-neutral float-right" title="BufferWriter" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="MemSpan.en.html" class="btn btn-neutral float-left" title="MemSpan" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, dev@trafficserver.apache.org

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>
 


</body>
</html>