

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>TSContScheduleOnPool &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/override.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="TSContScheduleOnThread" href="TSContScheduleOnThread.en.html" />
    <link rel="prev" title="TSContScheduleEveryOnPool" href="TSContScheduleEveryOnPool.en.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="tscontscheduleonpool">
<h1>TSContScheduleOnPool<a class="headerlink" href="#tscontscheduleonpool" title="Permalink to this headline">¶</a></h1>
<div class="section" id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;ts/ts.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<dl class="function">
<dt id="c.TSContScheduleOnPool">
<a class="reference internal" href="TSTypes.en.html#c.TSAction" title="TSAction">TSAction</a> <code class="descname">TSContScheduleOnPool</code><span class="sig-paren">(</span><a class="reference internal" href="TSTypes.en.html#c.TSCont" title="TSCont">TSCont</a><em>&nbsp;contp</em>, <a class="reference internal" href="TSTypes.en.html#c.TSHRTime" title="TSHRTime">TSHRTime</a><em>&nbsp;timeout</em>, <a class="reference internal" href="../types/TSThreadPool.en.html#c.TSThreadPool" title="TSThreadPool">TSThreadPool</a><em>&nbsp;tp</em><span class="sig-paren">)</span><a class="headerlink" href="#c.TSContScheduleOnPool" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>Schedules <em>contp</em> to run <em>timeout</em> milliseconds in the future, on a random thread that
belongs to <em>tp</em>. The <em>timeout</em> is an approximation, meaning it will be at least
<em>timeout</em> milliseconds but possibly more. Resolutions finer than roughly 5 milliseconds will
not be effective. Note that <em>contp</em> is required to have a mutex, which is provided to
<a class="reference internal" href="TSContCreate.en.html#c.TSContCreate" title="TSContCreate"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSContCreate()</span></code></a>.</p>
<p>The continuation is scheduled for a particular thread selected from a group of similar threads,
as indicated by <em>tp</em>. If <em>contp</em> already has an thread affinity set, and the thread
type of thread affinity is the same as <em>tp</em>, then <em>contp</em> will be scheduled on the
thread specified by thread affinity.</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="76%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Pool</th>
<th class="head">Properties</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">TS_THREAD_POOL_NET</span></code></td>
<td>Transaction processing threads. Continuations on these threads must not block.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">TS_THREAD_POOL_TASK</span></code></td>
<td>Background threads. Continuations can perform blocking operations.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">TS_THREAD_POOL_DNS</span></code></td>
<td>DNS request processing. May not exist depending on configuration. Not recommended.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">TS_THREAD_POOL_UDP</span></code></td>
<td>UDP processing.</td>
</tr>
</tbody>
</table>
<p>In practice, any choice except <code class="docutils literal notranslate"><span class="pre">TS_THREAD_POOL_NET</span></code> or <code class="docutils literal notranslate"><span class="pre">TS_THREAD_POOL_TASK</span></code> is strongly not
recommended. The <code class="docutils literal notranslate"><span class="pre">TS_THREAD_POOL_NET</span></code> threads are the same threads on which callback hooks are
called and continuations that use them have the same restrictions. <code class="docutils literal notranslate"><span class="pre">TS_THREAD_POOL_TASK</span></code> threads
are threads that exist to perform long or blocking actions, although sufficiently long operation can
impact system performance by blocking other continuations on the threads.</p>
<p>The return value can be used to cancel the scheduled event via <a class="reference internal" href="TSActionCancel.en.html#c.TSActionCancel" title="TSActionCancel"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSActionCancel()</span></code></a>. This is
effective until the continuation <em>contp</em> is being dispatched. However, if it is scheduled on
another thread this can be problematic to be correctly timed. The return value can be checked with
<a class="reference internal" href="TSActionDone.en.html#c.TSActionDone" title="TSActionDone"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSActionDone()</span></code></a> to see if the continuation ran before the return, which is possible if
<em>timeout</em> is <cite>0</cite>.</p>
<p>If <em>contp</em> has no thread affinity set, the thread it is now scheduled on will be set
as its thread affinity thread.</p>
<p>Note that the TSContSchedule() family of API shall only be called from an ATS EThread.
Calling it from raw non-EThreads can result in unpredictable behavior.</p>
</div>
<div class="section" id="example-scenarios">
<h2>Example Scenarios<a class="headerlink" href="#example-scenarios" title="Permalink to this headline">¶</a></h2>
<div class="section" id="scenario-1-no-thread-affinity-info-different-types-of-threads">
<h3>Scenario 1 (no thread affinity info, different types of threads)<a class="headerlink" href="#scenario-1-no-thread-affinity-info-different-types-of-threads" title="Permalink to this headline">¶</a></h3>
<p>When thread affinity is not set, a plugin calls the API on thread “A” (which is an “ET_TASK” type), and
wants to schedule on an “ET_NET” type thread provided in “tp”, the system would see there is no thread
affinity information stored in “contp.”</p>
<p>In this situation, system sees there is no thread affinity information stored in “contp”. It then
checks whether the type of thread “A” is the same as provided in “tp”, and sees that “A” is “ET_TASK”,
but “tp” says “ET_NET”. So “contp” gets scheduled on the next available “ET_NET” thread provided by a
round robin list, which we will call thread “B”. Since “contp” doesn’t have thread affinity information,
thread “B” will be assigned as the affinity thread for it automatically.</p>
<p>The reason for doing this is most of the time people want to schedule the same things on the same type
of thread, so logically it is better to default the first thread that it is scheduled on as the affinity
thread.</p>
</div>
<div class="section" id="scenario-2-no-thread-affinity-info-same-types-of-threads">
<h3>Scenario 2 (no thread affinity info, same types of threads)<a class="headerlink" href="#scenario-2-no-thread-affinity-info-same-types-of-threads" title="Permalink to this headline">¶</a></h3>
<p>Slight variation of scenario 1, instead of scheduling on a “ET_NET” thread, the plugin wants to schedule
on a “ET_TASK” thread (i.e. “tp” contains “ET_TASK” now), all other conditions stays the same.</p>
<p>This time since the type of the desired thread for scheduling and thread “A” are the same, the system
schedules “contp” on thread “A”, and assigns thread “A” as the affinity thread for “contp”.</p>
<p>The reason behind this choice is that we are trying to keep things simple such that lock contention
problems happens less. And for the most part, there is no point of scheduling the same thing on several
different threads of the same type, because there is no parallelism between them (a thread will have to
wait for the previous thread to finish, either because locking or the nature of the job it’s handling is
serialized since its on the same continuation).</p>
</div>
<div class="section" id="scenario-3-has-thread-affinity-info-different-types-of-threads">
<h3>Scenario 3 (has thread affinity info, different types of threads)<a class="headerlink" href="#scenario-3-has-thread-affinity-info-different-types-of-threads" title="Permalink to this headline">¶</a></h3>
<p>Slight variation of scenario 1, thread affinity is set for continuation “contp” to thread “A”, all other
conditions stays the same.</p>
<p>In this situation, the system sees that the “tp” has “ET_NET”, but the type of thread “A” is “ET_TASK”.
So even though “contp” has an affinity thread, the system will not use that information since the type is
different, instead it schedules “contp” on the next available “ET_NET” thread provided by a round robin
list, which we will call thread “B”. The difference with scenario 1 is that since thread “A” is set to
be the affinity thread for “contp” already, the system will NOT overwrite that information with thread “B”.</p>
<p>Most of the time, a continuation will be scheduled on one type of threads, and rarely gets scheduled on
a different type. But when that happens, we want it to return to the thread it was previously on, so it
won’t have any lock contention problems. And that’s also why “thread_affinity” is not a hashmap of thread
types and thread pointers.</p>
</div>
<div class="section" id="scenario-4-has-thread-affinity-info-same-types-of-threads">
<h3>Scenario 4 (has thread affinity info, same types of threads)<a class="headerlink" href="#scenario-4-has-thread-affinity-info-same-types-of-threads" title="Permalink to this headline">¶</a></h3>
<p>Slight variation of scenario 3, the only difference is “tp” now says “ET_TASK”.</p>
<p>This is the easiest scenario since the type of thread “A” and “tp” are the same, so the system schedules
“contp” on thread “A”. And, as discussed, there is really no reason why one may want to schedule
the same continuation on two different threads of the same type.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In scenario 3 &amp; 4, it doesn’t matter which thread the plugin is calling the API from.</p>
</div>
</div>
</div>
<div class="section" id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="TSContScheduleEveryOnPool.en.html"><span class="doc">TSContScheduleEveryOnPool</span></a>
<a class="reference internal" href="TSContScheduleOnThread.en.html"><span class="doc">TSContScheduleOnThread</span></a></p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../plugins/index.en.html">Plugin Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.en.html">Developer’s Guide</a><ul>
  <li><a href="../index.en.html">API Reference</a><ul>
  <li><a href="index.en.html">API Functions</a><ul>
      <li>Previous: <a href="TSContScheduleEveryOnPool.en.html" title="previous chapter">TSContScheduleEveryOnPool</a></li>
      <li>Next: <a href="TSContScheduleOnThread.en.html" title="next chapter">TSContScheduleOnThread</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/developer-guide/api/functions/TSContScheduleOnPool.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>