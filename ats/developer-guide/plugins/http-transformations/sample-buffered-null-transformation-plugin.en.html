

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Sample Buffered Null Transform Plugin &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/override.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Remap Plugins" href="../remap-plugins.en.html" />
    <link rel="prev" title="Append Transform Plugin" href="append-transform-plugin.en.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="sample-buffered-null-transform-plugin">
<span id="developer-plugins-http-transformations-buffered-null"></span><h1>Sample Buffered Null Transform Plugin<a class="headerlink" href="#sample-buffered-null-transform-plugin" title="Permalink to this headline">¶</a></h1>
<p>The buffered null transform, <code class="docutils literal notranslate"><span class="pre">bnull_transform.c</span></code>, reads the response
content into a buffer and then writes the full buffer out to the client.
Many examples of transformations, such as compression, require you to
gather the full response content in order to perform the transformation.</p>
<p>The buffered null transform uses a state variable to keep track of when
it is (a) reading data into the buffer and (b) writing the data from the
buffer to the downstream vconnection.</p>
<p>The following is a step-by-step walk through the buffered null
transform:</p>
<ol class="arabic">
<li><p class="first">Gets a handle to HTTP transactions.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
   <span class="nf">TSPluginInit</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
      <span class="n">TSHttpHookAdd</span> <span class="p">(</span><span class="n">TS_HTTP_READ_RESPONSE_HDR_HOOK</span><span class="p">,</span>
         <span class="n">TSContCreate</span> <span class="p">(</span><span class="n">transform_plugin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">));</span> <span class="p">}</span>
</pre></div>
</div>
<p>With this <code class="docutils literal notranslate"><span class="pre">TSPluginInit</span></code> routine, the plugin is called back every
time Traffic Server reads a response header.</p>
</li>
<li><p class="first">Checks to see if the transaction response is transformable.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">transform_plugin</span> <span class="p">(</span><span class="n">TSCont</span> <span class="n">contp</span><span class="p">,</span> <span class="n">TSEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">edata</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">TSHttpTxn</span> <span class="n">txnp</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHttpTxn</span><span class="p">)</span> <span class="n">edata</span><span class="p">;</span>
   <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_READ_RESPONSE_HDR</span><span class="p">:</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">transformable</span> <span class="p">(</span><span class="n">txnp</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">transform_add</span> <span class="p">(</span><span class="n">txnp</span><span class="p">);</span>
         <span class="p">}</span>
</pre></div>
</div>
<p>The default behavior for transformations is to cache the transformed
content (if desired, you also can tell Traffic Server to cache
untransformed content). Therefore, only responses received directly
from an origin server need to be transformed. Objects served from
the cache are already transformed. To determine whether the response
is from the origin server, the routine transformable checks the
response header for the “200 OK” server response.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="n">TSMBuffer</span> <span class="n">bufp</span><span class="p">;</span>
   <span class="n">TSMLoc</span> <span class="n">hdr_loc</span><span class="p">;</span>
   <span class="n">TSHttpStatus</span> <span class="n">resp_status</span><span class="p">;</span>

   <span class="n">TSHttpTxnServerRespGet</span> <span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr_loc</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">TS_HTTP_STATUS_OK</span><span class="o">==</span>
      <span class="p">(</span><span class="n">resp_status</span><span class="o">=</span><span class="n">TSHttpHdrStatusGet</span><span class="p">(</span><span class="n">bufp</span><span class="p">,</span><span class="n">hdr_loc</span><span class="p">)))</span>
   <span class="p">{</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">If the response is transformable, then the plugin creates a
transformation vconnection that gets called back when the response
data is ready to be transformed (as it is streaming from the origin
server).</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">transform_add</span> <span class="p">(</span><span class="n">TSHttpTxn</span> <span class="n">txnp</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">TSVConn</span> <span class="n">connp</span><span class="p">;</span>
   <span class="n">connp</span> <span class="o">=</span> <span class="n">TSTransformCreate</span> <span class="p">(</span><span class="n">bnull_transform</span><span class="p">,</span> <span class="n">txnp</span><span class="p">);</span>
   <span class="n">TSHttpTxnHookAdd</span> <span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">TS_HTTP_RESPONSE_TRANSFORM_HOOK</span><span class="p">,</span> <span class="n">connp</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The previous code fragment shows that the handler function for the
transformation vconnection is <code class="docutils literal notranslate"><span class="pre">bnull_transform</span></code>.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">bnull_transform</span></code> function has to handle <code class="docutils literal notranslate"><span class="pre">ERROR</span></code>,
<code class="docutils literal notranslate"><span class="pre">WRITE_COMPLETE</span></code>, <code class="docutils literal notranslate"><span class="pre">WRITE_READY</span></code>, and <code class="docutils literal notranslate"><span class="pre">IMMEDIATE</span></code> events. If
the transform is just beginning, the event received is probably
<code class="docutils literal notranslate"><span class="pre">IMMEDIATE</span></code>. The <code class="docutils literal notranslate"><span class="pre">bnull_transform</span></code> function calls
<code class="docutils literal notranslate"><span class="pre">handle_transform</span></code> to handle <code class="docutils literal notranslate"><span class="pre">WRITE_READY</span></code> and <code class="docutils literal notranslate"><span class="pre">IMMEDIATE</span></code>.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">handle_transform</span></code> function examines the data parameter for
the continuation passed to it (the continuation passed to
<code class="docutils literal notranslate"><span class="pre">handle_transform</span></code> is the transformation vconnection). The data
structure keeps track of two states: copying the data into the
buffer (<code class="docutils literal notranslate"><span class="pre">STATE_BUFFER_DATA</span></code>) and writing the contents of the
buffer to the output vconnection (<code class="docutils literal notranslate"><span class="pre">STATE_OUTPUT_DATA</span></code>).</p>
</li>
<li><p class="first">Get a handle to the input VIO (see the <code class="docutils literal notranslate"><span class="pre">handle_buffering</span></code>
function). <code class="docutils literal notranslate"><span class="pre">input_vio</span> <span class="pre">=</span> <span class="pre">TSVConnWriteVIOGet</span> <span class="pre">(contp);</span></code> This is so
that the transformation can get information about the upstream
vconnection’s write operation to the input buffer.</p>
</li>
<li><p class="first">Copy data from the input buffer to the output buffer. See the
<code class="docutils literal notranslate"><span class="pre">handle_buffering</span></code> function for the following code fragment:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSIOBufferCopy</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">output_buffer</span><span class="p">,</span>
   <span class="n">TSVIOReaderGet</span> <span class="p">(</span><span class="n">write_vio</span><span class="p">),</span> <span class="n">towrite</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p class="first">Tell the input buffer that the transformation has read the data. See
the <code class="docutils literal notranslate"><span class="pre">handle_buffering</span></code> function for the following code fragment:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSIOBufferReaderConsume</span> <span class="p">(</span><span class="n">TSVIOReaderGet</span> <span class="p">(</span><span class="n">write_vio</span><span class="p">),</span> <span class="n">towrite</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p class="first">Modify the input VIO to tell it how much data has been read
(increase the value of <code class="docutils literal notranslate"><span class="pre">ndone</span></code>). See the <code class="docutils literal notranslate"><span class="pre">handle_buffering</span></code>
function for the following code fragment:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSVIONDoneSet</span> <span class="p">(</span><span class="n">write_vio</span><span class="p">,</span> <span class="n">TSVIONDoneGet</span> <span class="p">(</span><span class="n">write_vio</span><span class="p">)</span> <span class="o">+</span> <span class="n">towrite</span><span class="p">);</span> <span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">If there is more data left to read ( if ndone &lt; nbytes), then the
<code class="docutils literal notranslate"><span class="pre">handle_buffering</span></code> function wakes up the upstream vconnection by
sending it <code class="docutils literal notranslate"><span class="pre">WRITE_READY</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">TSVIONTodoGet</span> <span class="p">(</span><span class="n">write_vio</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">towrite</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">TSContCall</span> <span class="p">(</span><span class="n">TSVIOContGet</span> <span class="p">(</span><span class="n">write_vio</span><span class="p">),</span>
         <span class="n">TS_EVENT_VCONN_WRITE_READY</span><span class="p">,</span> <span class="n">write_vio</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>
</div>
<p>The process of passing data through the transformation is
illustrated in the following diagram. The transformation sends
<code class="docutils literal notranslate"><span class="pre">WRITE_READY</span></code> events when it needs more data; when data is
available, the upstream vconnection reenables the transformation
with an <code class="docutils literal notranslate"><span class="pre">IMMEDIATE</span></code> event.</p>
<p>The following diagram illustrates the read from an input
vconnection:</p>
<p><strong>Reading Data Into the Buffer (the ``STATE_BUFFER_DATA`` State)</strong>
{#ReadingDataIntoBuffer}</p>
<div class="figure" id="id1">
<img alt="Reading Data Into the Buffer the STATE\_BUFFER\_DATA State" src="../../../_images/vconn_buffer.jpg" />
<p class="caption"><span class="caption-text">Reading Data Into the Buffer the STATE_BUFFER_DATA State</span></p>
</div>
</li>
<li><p class="first">When the data is read into the output buffer, the
<code class="docutils literal notranslate"><span class="pre">handle_buffering</span></code> function sets the state of the transformation’s
data structure to <code class="docutils literal notranslate"><span class="pre">STATE_OUTPUT_DATA</span></code> and calls the upstream
vconnection back with the <code class="docutils literal notranslate"><span class="pre">WRITE_COMPLETE</span></code> event.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_OUTPUT_DATA</span><span class="p">;</span>
<span class="n">TSContCall</span> <span class="p">(</span><span class="n">TSVIOContGet</span> <span class="p">(</span><span class="n">write_vio</span><span class="p">),</span>
   <span class="n">TS_EVENT_VCONN_WRITE_COMPLETE</span><span class="p">,</span> <span class="n">write_vio</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p class="first">The upstream vconnection will probably shut down the write operation
when it receives the <code class="docutils literal notranslate"><span class="pre">WRITE_COMPLETE</span></code> event. The handler function
of the transformation, <code class="docutils literal notranslate"><span class="pre">bnull_transform</span></code>, receives an
<code class="docutils literal notranslate"><span class="pre">IMMEDIATE</span></code> event and calls the <code class="docutils literal notranslate"><span class="pre">handle_transform</span></code> function.
This time, the state is <code class="docutils literal notranslate"><span class="pre">STATE_OUTPUT_DATA</span></code>, so
<code class="docutils literal notranslate"><span class="pre">handle_transform</span></code> calls <code class="docutils literal notranslate"><span class="pre">handle_output</span></code>.</p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">handle_output</span></code> function gets a handle to the output
vconnection: <code class="docutils literal notranslate"><span class="pre">output_conn</span> <span class="pre">=</span> <span class="pre">TSTransformOutputVConnGet</span> <span class="pre">(contp);</span></code></p>
</li>
<li><p class="first">The <code class="docutils literal notranslate"><span class="pre">handle_output</span></code> function writes the buffer to the output
vconnection:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">-&gt;</span><span class="n">output_vio</span> <span class="o">=</span>
   <span class="n">TSVConnWrite</span> <span class="p">(</span><span class="n">output_conn</span><span class="p">,</span> <span class="n">contp</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">output_reader</span><span class="p">,</span>
   <span class="n">TSIOBufferReaderAvail</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">output_reader</span><span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
<p>The following diagram illustrates the write to the output
vconnection:</p>
<p><strong>Writing the Buffered Data to the Output Vconnection</strong>
{#WritingBufferedtDataIntoVConnection}</p>
<div class="figure" id="id2">
<img alt="Writing the Buffered Data to the Output Vconnection" src="../../../_images/vconn_buf_output.jpg" />
<p class="caption"><span class="caption-text">Writing the Buffered Data to the Output Vconnection</span></p>
</div>
</li>
</ol>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.en.html">Plugin Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.en.html">Developer’s Guide</a><ul>
  <li><a href="../index.en.html">Plugin Development</a><ul>
  <li><a href="index.en.html">HTTP Transformations</a><ul>
      <li>Previous: <a href="append-transform-plugin.en.html" title="previous chapter">Append Transform Plugin</a></li>
      <li>Next: <a href="../remap-plugins.en.html" title="next chapter">Remap Plugins</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/developer-guide/plugins/http-transformations/sample-buffered-null-transformation-plugin.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>