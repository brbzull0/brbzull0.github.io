


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>HTTP Transformations &mdash; Apache Traffic Server 10.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/override.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Sample Null Transform Plugin" href="sample-null-transformation-plugin.en.html" />
    <link rel="prev" title="URLs" href="../http-headers/urls.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Apache Traffic Server
          

          
            
            <img src="../../../_static/trans_logo_tm_380x69.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                10.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.en.html">Plugin Development</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../introduction.en.html">Plugin Development Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="../building-plugins.en.html">Building Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../configuration.en.html">Plugin Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../plugin-management/index.en.html">Plugin Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../actions/index.en.html">Actions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hooks-and-transactions/index.en.html">Hooks and Transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../continuations/index.en.html">Continuations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mutexes.en.html">Mutexes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../io/index.en.html">IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http-headers/index.en.html">HTTP Headers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">HTTP Transformations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="sample-null-transformation-plugin.en.html">Sample Null Transform Plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="append-transform-plugin.en.html">Append Transform Plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="sample-buffered-null-transformation-plugin.en.html">Sample Buffered Null Transform Plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-content-transform-plugins">Writing Content Transform Plugins</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../remap-plugins.en.html">Remap Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../new-protocol-plugins.en.html">New Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../plugin-interfaces.en.html">Plugin Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../adding-statistics.en.html">Adding Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../example-plugins/index.en.html">Example Plugins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendices/index.en.html">Appendices</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Apache Traffic Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.en.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="../index.en.html">Plugin Development</a> &raquo;</li>
        
      <li>HTTP Transformations</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/developer-guide/plugins/http-transformations/index.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="http-transformations">
<span id="developer-plugins-http-transformations"></span><h1>HTTP Transformations<a class="headerlink" href="#http-transformations" title="Permalink to this headline">¶</a></h1>
<p>Transform plugins examine or transform HTTP message body content. For
example, transform plugins can:</p>
<ul class="simple">
<li><p>Append text to HTML documents</p></li>
<li><p>Compress images</p></li>
<li><p>Do virus checking (on client <code class="docutils literal notranslate"><span class="pre">POST</span></code> data or server response data)</p></li>
<li><p>Do content-based filtering (filter out HTML documents that contain
certain terms or expressions)</p></li>
</ul>
<p>This chapter explains how to write transform plugins. The following
examples are discussed in detail:</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="sample-null-transformation-plugin.en.html">Sample Null Transform Plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="append-transform-plugin.en.html">Append Transform Plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample-buffered-null-transformation-plugin.en.html">Sample Buffered Null Transform Plugin</a></li>
</ul>
</div>
<div class="section" id="writing-content-transform-plugins">
<span id="writingcontenttransformplugin"></span><h2>Writing Content Transform Plugins<a class="headerlink" href="#writing-content-transform-plugins" title="Permalink to this headline">¶</a></h2>
<p>Content transformation plugins transform HTTP response content (such as
images or HTML documents) and HTTP request content (such as client
<code class="docutils literal notranslate"><span class="pre">POST</span></code> data). Because the data stream to be transformed is of variable
length, these plugins must use a mechanism that passes data from buffer
to buffer <em>and</em> checks to see if the end of the data stream is reached.
This mechanism is provided by virtual connections (<code class="docutils literal notranslate"><span class="pre">VConnection</span></code>s)
and virtual IO descriptors (<code class="docutils literal notranslate"><span class="pre">VIO</span></code>s).</p>
<p>A <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> is an abstraction for a data pipe that allows its
users to perform asynchronous reads and writes without knowing the
underlying implementation. A transformation is a specific type of
<code class="docutils literal notranslate"><span class="pre">VConnection</span></code>. A <strong>transformation</strong> connects an input data source and
an output data sink; this feature enables it to view and modify all the
data passing through it.</p>
<p>Transformations can be chained together, one after the other, so that
multiple transformations can be performed on the same content. The
<code class="docutils literal notranslate"><span class="pre">VConnection</span></code> type, <code class="docutils literal notranslate"><span class="pre">TSVConn</span></code>, is actually a subclass of <code class="docutils literal notranslate"><span class="pre">TSCont</span></code>,
which means that <code class="docutils literal notranslate"><span class="pre">VConnection</span></code>s (and transformations) are
continuations. <code class="docutils literal notranslate"><span class="pre">VConnection</span></code>s and transformations can thus exchange
events, informing one another that data is available for reading or
writing, or that the end of a data stream is reached.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">VIO</span></code> is a description of an IO operation that is in progress.
Every <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> has an associated <em>input VIO</em> and an associated
<em>output VIO</em>. When <code class="docutils literal notranslate"><span class="pre">VConnection</span></code>s are transferring data to one
another, one <code class="docutils literal notranslate"><span class="pre">VConnection</span></code>’s input <code class="docutils literal notranslate"><span class="pre">VIO</span></code> is another
<code class="docutils literal notranslate"><span class="pre">VConnection</span></code>’s output <code class="docutils literal notranslate"><span class="pre">VIO</span></code>. A <code class="docutils literal notranslate"><span class="pre">VConnection</span></code>’s input <code class="docutils literal notranslate"><span class="pre">VIO</span></code> is
also called its <strong>write ``VIO``</strong> because the input <code class="docutils literal notranslate"><span class="pre">VIO</span></code> refers to a
write operation performed on the <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> itself. Similarly, the
output <code class="docutils literal notranslate"><span class="pre">VIO</span></code> is also called the <strong>read ``VIO``</strong>. For transformations,
which are designed to pass data in one direction, you can picture the
relationship between the transformation <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> and its
<code class="docutils literal notranslate"><span class="pre">VIO</span></code>s as follows:</p>
<div class="figure align-center" id="id2">
<span id="transformationanditsvios"></span><img alt="A Transformation and its VIOs" src="../../../_images/vconnection.jpg" />
<p class="caption"><span class="caption-text"><strong>A Transformation and its VIOs</strong></span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>Because the Traffic Server API places transformations directly in the
response or request data stream, the transformation <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> is
responsible only for reading the data from the input buffer,
transforming it, and then writing it to the output buffer. The upstream
<code class="docutils literal notranslate"><span class="pre">VConnection</span></code> writes the incoming data to the transformation’s input
buffer. In the figure above, <a class="reference internal" href="#transformationanditsvios"><span class="std std-ref">A Transformation and its VIOs</span></a>, the input <code class="docutils literal notranslate"><span class="pre">VIO</span></code> describes the
progress of the upstream <code class="docutils literal notranslate"><span class="pre">VConnection</span></code>’s write operation on the
transformation, while the output <code class="docutils literal notranslate"><span class="pre">VIO</span></code> describes the progress of the
transformation’s write operation on the output (downstream)
<code class="docutils literal notranslate"><span class="pre">VConnection</span></code>. The <strong>nbytes</strong> value in the <code class="docutils literal notranslate"><span class="pre">VIO</span></code> is the total number
of bytes to be written. The <strong>ndone</strong> value is the current progress, or
the number of bytes that have been written at a specific point in time.</p>
<p>When writing a transformation plugin, you must understand implementation
as well as the use of <code class="docutils literal notranslate"><span class="pre">VConnection</span></code>s. The <em>implementer’s side</em>
refers to how to implement a <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> that others can use. At
minimum, a transform plugin creates a transformation that sits in the
data stream and must be able to handle the events that the upstream and
downstream <code class="docutils literal notranslate"><span class="pre">VConnection</span></code>s send to it. The <em>user’s side</em> refers to
how to use a <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> to read or write data. At the very least,
transformations output (write) data.</p>
<div class="section" id="transformations">
<span id="id1"></span><h3>Transformations<a class="headerlink" href="#transformations" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="vios">
<h3>VIOs<a class="headerlink" href="#vios" title="Permalink to this headline">¶</a></h3>
<p>A <code class="docutils literal notranslate"><span class="pre">VIO</span></code> or virtual IO is a description of an in progress IO
operation. The <code class="docutils literal notranslate"><span class="pre">VIO</span></code> data structure is used by <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> users
to determine how much progress has been made on a particular IO
operation, and to re-enable an IO operation when it stalls due to buffer
space. <code class="docutils literal notranslate"><span class="pre">VConnection</span></code> implementers use <code class="docutils literal notranslate"><span class="pre">VIO</span></code>s to determine the
buffer for an IO operation, how much work to do on the IO operation, and
which continuation to call back when progress on the IO operation is
made.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">TSVIO</span></code> data structure itself is opaque, but it might have been
defined as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
   <span class="n">TSCont</span> <span class="n">continuation</span><span class="p">;</span>
   <span class="n">TSVConn</span> <span class="n">vconnection</span><span class="p">;</span>
   <span class="n">TSIOBufferReader</span> <span class="n">reader</span><span class="p">;</span>
   <span class="n">TSMutex</span> <span class="n">mutex</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">nbytes</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">ndone</span><span class="p">;</span>
<span class="p">}</span> <span class="o">*</span><span class="n">TSVIO</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="io-buffers">
<h3>IO Buffers<a class="headerlink" href="#io-buffers" title="Permalink to this headline">¶</a></h3>
<p>The <strong>IO buffer</strong> data structure is the building block of the
<code class="docutils literal notranslate"><span class="pre">VConnection</span></code> abstraction. An IO buffer is composed of a list of
buffer blocks which, in turn, point to buffer data. Both the <em>buffer
block</em> (<code class="docutils literal notranslate"><span class="pre">TSIOBufferBlock</span></code>) and <em>buffer data</em> (<code class="docutils literal notranslate"><span class="pre">TSIOBufferData</span></code>) data
structures are reference counted so they can reside in multiple buffers
at the same time. This makes it extremely efficient to copy data from
one IO buffer to another using <code class="docutils literal notranslate"><span class="pre">TSIOBufferCopy</span></code>, since Traffic Server
only needs to copy pointers and adjust reference counts appropriately
(instead of actually copying any data).</p>
<p>The IO buffer abstraction provides for a single writer and multiple
readers. In order for the readers to have no knowledge of each other,
they manipulate IO buffers through the<code class="docutils literal notranslate"><span class="pre">TSIOBufferReader</span></code> data
structure. Since only a single writer is allowed, there is no
corresponding <code class="docutils literal notranslate"><span class="pre">TSIOBufferWriter</span></code> data structure. The writer simply
modifies the IO buffer directly.</p>
<div class="section" id="transaction-data-sink">
<h4>Transaction Data Sink<a class="headerlink" href="#transaction-data-sink" title="Permalink to this headline">¶</a></h4>
<p>The hook <cite>TS_HTTP_RESPONSE_CLIENT_HOOK</cite> is a hook that supports a special type of transformation, one with only input and no output.
Although the transformation doesn’t provide data back to Traffic Server it can do anything else with the data, such as writing it
to another output device or process. It must, however, consume all the data for the transaction. There are two primary use cases.</p>
<ol class="arabic simple">
<li><p>Tap in to the transaction to provide the data for external processing.</p></li>
<li><p>Maintain the transaction.</p></li>
</ol>
<p>For the latter it is important to note that if all consumers of a transaction (primarily the user agent) shut down the transaction is also
terminated, including the connection to the origin server. A data sink transform, unlike a standard transform, is considered to be a consumer
and will keep the transaction and the origin server connection up. This is useful when the transaction is in some way expensive and should
run to completion even if the user agent disconnects. Examples would be a standard transform that is expensive to initiate, or expensive
origin server connections that should be <a class="reference internal" href="../../../admin-guide/files/records.config.en.html#proxy-config-http-server-session-sharing-match" title="records.config"><code class="xref ts ts-cv docutils literal notranslate"><span class="pre">shared</span></code></a>.</p>
<p>There is an <a class="reference external" href="https://github.com/apache/trafficserver/blob/master/example/plugins/c-api/txn_data_sink/txn_data_sink.c">example plugin</a> that demonstrates
this used as a pure data sink to keep the transaction up regardless of whether the user agent disconnects.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="sample-null-transformation-plugin.en.html" class="btn btn-neutral float-right" title="Sample Null Transform Plugin" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../http-headers/urls.en.html" class="btn btn-neutral float-left" title="URLs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, dev@trafficserver.apache.org.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>
 


</body>
</html>