

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Denylist Plugin &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/override.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Setting a Global Hook" href="setting-a-global-hook.en.html" />
    <link rel="prev" title="Setting a Transaction Hook" href="../basic-authorization/setting-a-transaction-hook.en.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="denylist-plugin">
<span id="developer-plugins-examples-denylist"></span><h1>Denylist Plugin<a class="headerlink" href="#denylist-plugin" title="Permalink to this headline">¶</a></h1>
<p>The sample denylisting plugin included in the Traffic Server SDK is
<code class="docutils literal notranslate"><span class="pre">denylist_1.c</span></code>. This plugin checks every incoming HTTP client request
against a list of listed web sites. If the client requests a
listed site, then the plugin returns an <code class="docutils literal notranslate"><span class="pre">Access</span> <span class="pre">forbidden</span></code>
message to the client.</p>
<p>The flow of HTTP processing with the denylist plugin is illustrated in
the figure titled <a class="reference internal" href="../../introduction.en.html#denylistplugin"><span class="std std-ref">Denylist Plugin</span></a>.
This example also contains a simple configuration management interface.
It can read a list of sites from a file (<code class="docutils literal notranslate"><span class="pre">denylist.txt</span></code>)
that can be updated by a Traffic Server administrator. When the
configuration file is updated, Traffic Server sends an event to the
plugin that wakes it up to do some work.</p>
<div class="section" id="creating-the-parent-continuation">
<h2>Creating the Parent Continuation<a class="headerlink" href="#creating-the-parent-continuation" title="Permalink to this headline">¶</a></h2>
<p>You create the static parent continuation in the mandatory
<code class="docutils literal notranslate"><span class="pre">TSPluginInit</span></code> function. This parent continuation effectively <strong>is</strong>
the plugin: the plugin executes only when this continuation receives an
event from Traffic Server. Traffic Server passes the event as an
argument to the continuation’s handler function. When you create
continuations, you must create and specify their handler functions.</p>
<p>You can specify an optional mutex lock when you create continuations.
The mutex lock protects data shared by asynchronous processes. Because
Traffic Server has a multi-threaded design, race conditions can occur if
several threads try to access the same continuation’s data.</p>
<p>Here is how the static parent continuation is created in
<code class="docutils literal notranslate"><span class="pre">denylist_1.c</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">TSPluginInit</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="c1">// ...</span>
   <span class="n">TSCont</span> <span class="n">contp</span><span class="p">;</span>

   <span class="n">contp</span> <span class="o">=</span> <span class="n">TSContCreate</span> <span class="p">(</span><span class="n">denylist_plugin</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The handler function for the plugin is <code class="docutils literal notranslate"><span class="pre">denylist_plugin</span></code>, and the
mutex is null. The continuation handler function’s job is to handle the
events that are sent to it; accordingly, the <code class="docutils literal notranslate"><span class="pre">denylist_plugin</span></code>
routine consists of a switch statement that covers each of the events
that might be sent to it:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span>
<span class="nf">denylist_plugin</span> <span class="p">(</span><span class="n">TSCont</span> <span class="n">contp</span><span class="p">,</span> <span class="n">TSEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">edata</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">TSHttpTxn</span> <span class="n">txnp</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHttpTxn</span><span class="p">)</span> <span class="n">edata</span><span class="p">;</span>
   <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_OS_DNS</span><span class="p">:</span>
         <span class="n">handle_dns</span> <span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">contp</span><span class="p">);</span>
         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_SEND_RESPONSE_HDR</span><span class="p">:</span>
         <span class="n">handle_response</span> <span class="p">(</span><span class="n">txnp</span><span class="p">);</span>
         <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
         <span class="n">TSDebug</span> <span class="p">(</span><span class="s">&quot;denylist_plugin&quot;</span><span class="p">,</span> <span class="s">&quot;This event was unexpected: %d&quot;</span><span class="p">,</span> <span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When you write handler functions, you have to anticipate any events that
might be sent to the handler by hooks or by other functions. In the
Denylist plugin, <code class="docutils literal notranslate"><span class="pre">TS_EVENT_OS_DNS</span></code> is sent because of the global hook
established in <code class="docutils literal notranslate"><span class="pre">TSPluginInit</span></code>, <code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_SEND_RESPONSE_HDR</span></code> is
sent because the plugin contains a transaction hook
(see <a class="reference internal" href="setting-up-a-transaction-hook.en.html#developer-plugins-examples-denylist-txn-hook"><span class="std std-ref">Setting Up a Transaction Hook</span></a>).
It is good practice to have a default case in your switch statements.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="setting-a-global-hook.en.html">Setting a Global Hook</a></li>
<li class="toctree-l1"><a class="reference internal" href="accessing-the-transaction-being-processed.en.html">Accessing the Transaction Being Processed</a></li>
<li class="toctree-l1"><a class="reference internal" href="setting-up-a-transaction-hook.en.html">Setting Up a Transaction Hook</a></li>
<li class="toctree-l1"><a class="reference internal" href="working-with-http-header-functions.en.html">Working with HTTP Header Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="source-code.en.html">Sample Source Code</a><ul>
<li class="toctree-l2"><a class="reference internal" href="source-code.en.html#denylist-1-c">denylist_1.c</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.en.html">Plugin Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.en.html">Developer’s Guide</a><ul>
  <li><a href="../../index.en.html">Plugin Development</a><ul>
  <li><a href="../index.en.html">Example Plugins</a><ul>
      <li>Previous: <a href="../basic-authorization/setting-a-transaction-hook.en.html" title="previous chapter">Setting a Transaction Hook</a></li>
      <li>Next: <a href="setting-a-global-hook.en.html" title="next chapter">Setting a Global Hook</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../../_sources/developer-guide/plugins/example-plugins/denylist/index.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>