


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Mutexes &mdash; Apache Traffic Server 10.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/override.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="IO" href="io/index.en.html" />
    <link rel="prev" title="Writing Handler Functions" href="continuations/writing-handler-functions.en.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Apache Traffic Server
          

          
            
            <img src="../../_static/trans_logo_tm_380x69.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                10.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Plugin Development</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="introduction.en.html">Plugin Development Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="building-plugins.en.html">Building Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.en.html">Plugin Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin-management/index.en.html">Plugin Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="actions/index.en.html">Actions</a></li>
<li class="toctree-l3"><a class="reference internal" href="hooks-and-transactions/index.en.html">Hooks and Transactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="continuations/index.en.html">Continuations</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Mutexes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#locking-global-data">Locking Global Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#protecting-a-continuation-s-data">Protecting a Continuation’s Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-associate-a-continuation-with-every-http-transaction">How to Associate a Continuation With Every HTTP Transaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-add-the-new-continuation">How to Add the New Continuation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-store-data-specific-to-each-http-transaction">How to Store Data Specific to Each HTTP Transaction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-locks">Using Locks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#special-case-continuations-created-for-http-transactions">Special Case: Continuations Created for HTTP Transactions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="io/index.en.html">IO</a></li>
<li class="toctree-l3"><a class="reference internal" href="http-headers/index.en.html">HTTP Headers</a></li>
<li class="toctree-l3"><a class="reference internal" href="http-transformations/index.en.html">HTTP Transformations</a></li>
<li class="toctree-l3"><a class="reference internal" href="remap-plugins.en.html">Remap Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="new-protocol-plugins.en.html">New Protocol Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin-interfaces.en.html">Plugin Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="adding-statistics.en.html">Adding Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="example-plugins/index.en.html">Example Plugins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../testing/index.en.html">Testing Traffic Server</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apache Traffic Server</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.en.html">Developer’s Guide</a> &raquo;</li>
        
          <li><a href="index.en.html">Plugin Development</a> &raquo;</li>
        
      <li>Mutexes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/developer-guide/plugins/mutexes.en.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mutexes">
<span id="developer-plugins-mutexes"></span><h1>Mutexes<a class="headerlink" href="#mutexes" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>A <em>mutex</em> is the basic synchronization method used within Traffic
Server to protect data from simultaneous access by multiple threads. A
mutex acts as a lock that protects data in one program thread from being
accessed by another thread.</p>
<p>The Traffic Server API provides two functions that attempt to access and
lock the data: <a class="reference internal" href="../api/functions/TSMutexLockTry.en.html#c.TSMutexLockTry" title="TSMutexLockTry"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexLockTry()</span></code></a> and <a class="reference internal" href="../api/functions/TSMutexLock.en.html#c.TSMutexLock" title="TSMutexLock"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexLock()</span></code></a>.
<code class="docutils literal notranslate"><span class="pre">TSMutexLock</span></code> is a blocking call - if you use it, you can slow
Traffic Server performance because transaction processing pauses until
the mutex is unlocked. It should be used only on threads created by the
plugin <code class="docutils literal notranslate"><span class="pre">TSContThreadCreate</span></code>. Never use it on a continuation handler
called back by the Cache, Net, or Event Processor. Even if the critical
section is very small, do not use it. If you need to update a flag, then
set a variable and/or use atomic operations. If <a class="reference internal" href="../api/functions/TSMutexLock.en.html#c.TSMutexLock" title="TSMutexLock"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexLock()</span></code></a> is used
in any case other than the one recommended above, then the result will
be a serious performance impact.</p>
<p><code class="docutils literal notranslate"><span class="pre">TSMutexLockTry</span></code>, on the other hand, attempts to lock the mutex
only if it is unlocked (i.e., not being used by another thread). It
should be used in all cases other than the above mentioned
<code class="docutils literal notranslate"><span class="pre">TSMutexLock</span></code> case. If the <code class="docutils literal notranslate"><span class="pre">TSMutexLockTry</span></code> attempt fails, then you
can schedule a future attempt (which must be at least 10 milliseconds
later).</p>
<p>In general, you should use <code class="docutils literal notranslate"><span class="pre">TSMutexLockTry</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">TSMutexLock</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TSMutexLockTry</span></code> is required if you are tying to lock Traffic
Server internal or system resources (such as the network, cache,
event processor, HTTP state machines, and IO buffers).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TSMutexLockTry</span></code> is required if you are making any blocking calls
(such as network, cache, or file IO calls).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TSMutexLock</span></code> might not be necessary if you are not making
blocking calls and if you are only accessing local resources.</p></li>
</ul>
<p>The Traffic Server API uses the <code class="docutils literal notranslate"><span class="pre">TSMutex</span></code> type for a mutex. There are
two typical uses of mutex. One use is for locking global data or data
shared by various continuations. The other typical usage is for locking
data associated with a continuation (i.e., data that might be accessed
by other continuations).</p>
<div class="section" id="locking-global-data">
<h2>Locking Global Data<a class="headerlink" href="#locking-global-data" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="example-plugins/denylist/source-code.en.html#denylist-1-c"><span class="std std-ref">denylist_1.c</span></a> sample plugin implements a mutex that locks global
data. The denylist plugin reads sites to be denied from a
configuration file; file read operations are protected by a mutex
created in <a class="reference internal" href="../api/functions/TSPluginInit.en.html#c.TSPluginInit" title="TSPluginInit"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSPluginInit()</span></code></a>. The <a class="reference internal" href="example-plugins/denylist/source-code.en.html#denylist-1-c"><span class="std std-ref">denylist_1.c</span></a> code uses
<a class="reference internal" href="../api/functions/TSMutexLockTry.en.html#c.TSMutexLockTry" title="TSMutexLockTry"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexLockTry()</span></code></a> instead of <a class="reference internal" href="../api/functions/TSMutexLock.en.html#c.TSMutexLock" title="TSMutexLock"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexLock()</span></code></a>. For more detailed
information, see the <a class="reference internal" href="example-plugins/denylist/source-code.en.html#denylist-1-c"><span class="std std-ref">denylist_1.c</span></a> code;
start by looking at the <a class="reference internal" href="../api/functions/TSPluginInit.en.html#c.TSPluginInit" title="TSPluginInit"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSPluginInit()</span></code></a> function.</p>
<p>General guidelines for locking shared data are as follows:</p>
<ol class="arabic simple">
<li><p>Create a mutex for the shared data with
<a class="reference internal" href="../api/functions/TSMutexCreate.en.html#c.TSMutexCreate" title="TSMutexCreate"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexCreate()</span></code></a>.</p></li>
<li><p>Whenever you need to read or modify this data, first lock it by
calling
<a class="reference internal" href="../api/functions/TSMutexLockTry.en.html#c.TSMutexLockTry" title="TSMutexLockTry"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexLockTry()</span></code></a>;
then read or modify the data.</p></li>
<li><p>When you are done with the data, unlock it with
<a class="reference internal" href="../api/functions/TSMutexUnlock.en.html#c.TSMutexUnlock" title="TSMutexUnlock"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexUnlock()</span></code></a>.
If you are unlocking data accessed during the processing of an HTTP
transaction, then you must unlock it before calling
<a class="reference internal" href="../api/functions/TSHttpTxnReenable.en.html#c.TSHttpTxnReenable" title="TSHttpTxnReenable"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSHttpTxnReenable()</span></code></a>.</p></li>
</ol>
</div>
<div class="section" id="protecting-a-continuation-s-data">
<h2>Protecting a Continuation’s Data<a class="headerlink" href="#protecting-a-continuation-s-data" title="Permalink to this headline">¶</a></h2>
<p>You must create a mutex to protect a continuation’s data if it might be
accessed by other continuations or processes. Here’s how:</p>
<ol class="arabic">
<li><div class="line-block">
<div class="line">Create a mutex for the continuation using <code class="docutils literal notranslate"><span class="pre">TSMutexCreate</span></code>.</div>
<div class="line">For example:</div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSMutex</span> <span class="n">mutexp</span><span class="p">;</span>
<span class="n">mutexp</span> <span class="o">=</span> <span class="n">TSMutexCreate</span> <span class="p">();</span>
</pre></div>
</div>
</li>
<li><div class="line-block">
<div class="line">When you create the continuation, specify this mutex as the
continuation’s mutex.</div>
<div class="line">For example:</div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSCont</span> <span class="n">contp</span><span class="p">;</span>
<span class="n">contp</span> <span class="o">=</span> <span class="n">TSContCreate</span> <span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">mutexp</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
<p>If any other functions want to access <code class="docutils literal notranslate"><span class="pre">contp</span></code>’s data, then it is up to
them to get <code class="docutils literal notranslate"><span class="pre">contp</span></code>’s mutex (using, for example, <code class="docutils literal notranslate"><span class="pre">TSContMutexGet</span></code>)
to lock it. For usage, see the sample Protocol plugin.</p>
</div>
<div class="section" id="how-to-associate-a-continuation-with-every-http-transaction">
<h2>How to Associate a Continuation With Every HTTP Transaction<a class="headerlink" href="#how-to-associate-a-continuation-with-every-http-transaction" title="Permalink to this headline">¶</a></h2>
<p>There could be several reasons why you’d want to create a continuation
for each HTTP transaction that calls back your plugin.</p>
<p>Some potential scenarios are listed below.</p>
<ul class="simple">
<li><p>You want to register hooks locally with the new continuation instead
of registering them globally to the continuation plugin.</p></li>
<li><p>You want to store data specific to each HTTP transaction that you
might need to reuse across various hooks.</p></li>
<li><p>You’re using APIs (like <code class="docutils literal notranslate"><span class="pre">TSHostLookup</span></code>) that will call back the
continuation with a certain event.</p></li>
</ul>
</div>
<div class="section" id="how-to-add-the-new-continuation">
<h2>How to Add the New Continuation<a class="headerlink" href="#how-to-add-the-new-continuation" title="Permalink to this headline">¶</a></h2>
<p>A typical way of adding the new continuation is by registering the
plugin continuation to be called back by HTTP transactions globally when
they reach <code class="docutils literal notranslate"><span class="pre">TS_HTTP_TXN_START_HOOK</span></code>. Refer to the example below, which
uses a transaction-specific continuation called <code class="docutils literal notranslate"><span class="pre">txn_contp</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">TSPluginInit</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="cm">/* Plugin continuation */</span>
    <span class="n">TSCont</span> <span class="n">contp</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">contp</span> <span class="o">=</span> <span class="n">TSContCreate</span> <span class="p">(</span><span class="n">plugin_cont_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">==</span> <span class="n">TS_ERROR_PTR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSContCreate&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">TSHttpHookAdd</span> <span class="p">(</span><span class="n">TS_HTTP_TXN_START_HOOK</span><span class="p">,</span> <span class="n">contp</span><span class="p">)</span> <span class="o">==</span> <span class="n">TS_ERROR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSHttpHookAdd&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the plugin continuation handler, create the new continuation
<code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> and then register it to be called back at
<code class="docutils literal notranslate"><span class="pre">TS_HTTP_TXN_CLOSE_HOOK</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">plugin_cont_handler</span><span class="p">(</span><span class="n">TSCont</span> <span class="n">contp</span><span class="p">,</span> <span class="n">TSEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">edata</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TSHttpTxn</span> <span class="n">txnp</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHttpTxn</span><span class="p">)</span><span class="n">edata</span><span class="p">;</span>
    <span class="n">TSCont</span> <span class="n">txn_contp</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_TXN_START</span><span class="p">:</span>
            <span class="cm">/* Create the HTTP txn continuation */</span>
            <span class="n">txn_contp</span> <span class="o">=</span> <span class="n">TSContCreate</span><span class="p">(</span><span class="n">txn_cont_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

            <span class="cm">/* Register txn_contp to be called back when txnp reaches TS_HTTP_TXN_CLOSE_HOOK */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">TSHttpTxnHookAdd</span> <span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">TS_HTTP_TXN_CLOSE_HOOK</span><span class="p">,</span> <span class="n">txn_contp</span><span class="p">)</span> <span class="o">==</span> <span class="n">TS_ERROR</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSHttpTxnHookAdd&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="n">TSAssert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;Unexpected Event&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">TSHttpTxnReenable</span><span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">TS_EVENT_HTTP_CONTINUE</span><span class="p">)</span> <span class="o">==</span> <span class="n">TS_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSHttpTxnReenable&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Remember that the <code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> handler must destroy itself when the
HTTP transaction is closed. If you forget to do this, then your plugin
will have a memory leak.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">txn_cont_handler</span><span class="p">(</span><span class="n">TSCont</span> <span class="n">txn_contp</span><span class="p">,</span> <span class="n">TSEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">edata</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TSHttpTxn</span> <span class="n">txnp</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_TXN_CLOSE</span><span class="p">:</span>
            <span class="n">txnp</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHttpTxn</span><span class="p">)</span> <span class="n">edata</span><span class="p">;</span>
            <span class="n">TSContDestroy</span><span class="p">(</span><span class="n">txn_contp</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="n">TSAssert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;Unexpected Event&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">TSHttpTxnReenable</span><span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">TS_EVENT_HTTP_CONTINUE</span><span class="p">)</span> <span class="o">==</span> <span class="n">TS_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSHttpTxnReenable&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-store-data-specific-to-each-http-transaction">
<h2>How to Store Data Specific to Each HTTP Transaction<a class="headerlink" href="#how-to-store-data-specific-to-each-http-transaction" title="Permalink to this headline">¶</a></h2>
<p>For the example above, store the data in the <code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> data
structure - this means that you’ll create your own data structure. Now
suppose you want to store the state of the HTTP transaction:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">ContData</span><span class="p">;</span>
</pre></div>
</div>
<p>You need to allocate the memory and initialize this structure for each
HTTP <code class="docutils literal notranslate"><span class="pre">txnp</span></code>. You can do that in the plugin continuation handler when
it is called back with <code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_TXN_START</span></code></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">plugin_cont_handler</span><span class="p">(</span><span class="n">TSCont</span> <span class="n">contp</span><span class="p">,</span> <span class="n">TSEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">edata</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TSHttpTxn</span> <span class="n">txnp</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHttpTxn</span><span class="p">)</span><span class="n">edata</span><span class="p">;</span>
    <span class="n">TSCont</span> <span class="n">txn_contp</span><span class="p">;</span>
    <span class="n">ContData</span> <span class="o">*</span><span class="n">contData</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_TXN_START</span><span class="p">:</span>
            <span class="cm">/* Create the HTTP txn continuation */</span>
            <span class="n">txn_contp</span> <span class="o">=</span> <span class="n">TSContCreate</span><span class="p">(</span><span class="n">txn_cont_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

            <span class="cm">/* Allocate and initialize the txn_contp data */</span>
            <span class="n">contData</span> <span class="o">=</span> <span class="p">(</span><span class="n">ContData</span><span class="o">*</span><span class="p">)</span> <span class="n">TSmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ContData</span><span class="p">));</span>
            <span class="n">contData</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">TSContDataSet</span><span class="p">(</span><span class="n">txn_contp</span><span class="p">,</span> <span class="n">contData</span><span class="p">)</span> <span class="o">==</span> <span class="n">TS_ERROR</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSContDataSet&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="cm">/* Register txn_contp to be called back when txnp reaches TS_HTTP_TXN_CLOSE_HOOK */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">TSHttpTxnHookAdd</span> <span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">TS_HTTP_TXN_CLOSE_HOOK</span><span class="p">,</span> <span class="n">txn_contp</span><span class="p">)</span> <span class="o">==</span> <span class="n">TS_ERROR</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSHttpTxnHookAdd&quot;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="n">TSAssert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;Unexpected Event&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">TSHttpTxnReenable</span><span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">TS_EVENT_HTTP_CONTINUE</span><span class="p">)</span> <span class="o">==</span> <span class="n">TS_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSHttpTxnReenable&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For accessing this data from anywhere, use TSContDataGet:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TSCont</span> <span class="n">txn_contp</span><span class="p">;</span>
<span class="n">ContData</span> <span class="o">*</span><span class="n">contData</span><span class="p">;</span>

<span class="n">contData</span> <span class="o">=</span> <span class="n">TSContDataGet</span><span class="p">(</span><span class="n">txn_contp</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">contData</span> <span class="o">==</span> <span class="n">TS_ERROR_PTR</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSContDataGet&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">contData</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>Remember to free this memory before destroying the continuation:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">txn_cont_handler</span><span class="p">(</span><span class="n">TSCont</span> <span class="n">txn_contp</span><span class="p">,</span> <span class="n">TSEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">edata</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">TSHttpTxn</span> <span class="n">txnp</span><span class="p">;</span>
    <span class="n">ContData</span> <span class="o">*</span><span class="n">contData</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_TXN_CLOSE</span><span class="p">:</span>
            <span class="n">txnp</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHttpTxn</span><span class="p">)</span> <span class="n">edata</span><span class="p">;</span>
            <span class="n">contData</span> <span class="o">=</span> <span class="n">TSContDataGet</span><span class="p">(</span><span class="n">txn_contp</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">contData</span> <span class="o">==</span> <span class="n">TS_ERROR_PTR</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSContDataGet&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">TSfree</span><span class="p">(</span><span class="n">contData</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">TSContDestroy</span><span class="p">(</span><span class="n">txn_contp</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">default</span><span class="o">:</span>
            <span class="n">TSAssert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;Unexpected Event&quot;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">TSHttpTxnReenable</span><span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">TS_EVENT_HTTP_CONTINUE</span><span class="p">)</span> <span class="o">==</span> <span class="n">TS_ERROR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;TSHttpTxnReenable&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="using-locks">
<h2>Using Locks<a class="headerlink" href="#using-locks" title="Permalink to this headline">¶</a></h2>
<p>You do not need to use locks when a continuation has registered itself
to be called back by HTTP hooks and it only uses the HTTP APIs. In the
example above, the continuation <code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> has registered itself to
be called back at HTTP hooks and it only uses the HTTP APIs. In this
case only, it’s safe to access data shared between <code class="docutils literal notranslate"><span class="pre">txnp</span></code> and
<code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> without grabbing a lock. In the example above,
<code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> is created with a <code class="docutils literal notranslate"><span class="pre">NULL</span></code> mutex. This works because the
HTTP transaction <code class="docutils literal notranslate"><span class="pre">txnp</span></code> is the only one that will call back
<code class="docutils literal notranslate"><span class="pre">txn_contp</span></code>, and you are guaranteed that <code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> will be called
back only one hook at a time. After processing is finished,
<code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> will re-enable <code class="docutils literal notranslate"><span class="pre">txnp</span></code>.</p>
<p>In all other cases, you should create a mutex with the continuation. In
general, a lock is needed when you’re using iocore APIs or any other API
where <code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> is scheduled to be called back by a processor (such
as the cache processor, the DNS processor, etc.). This ensures that
<code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> is called back sequentially and not simultaneously. In
other words, you need to ensure that <code class="docutils literal notranslate"><span class="pre">txn_contp</span></code> will not be called
back by both <code class="docutils literal notranslate"><span class="pre">txnp</span></code> and the cache processor at the same time, since
this will result in a situation wherein you’re executing two pieces of
code in conflict.</p>
</div>
<div class="section" id="special-case-continuations-created-for-http-transactions">
<h2>Special Case: Continuations Created for HTTP Transactions<a class="headerlink" href="#special-case-continuations-created-for-http-transactions" title="Permalink to this headline">¶</a></h2>
<p>If your plugin creates a new continuation for each HTTP transaction,
then you probably don’t need to create a new mutex for it because each
HTTP transaction (<code class="docutils literal notranslate"><span class="pre">TSHttpTxn</span></code> object) already has its own mutex.</p>
<p>In the example below, it’s not necessary to specify a mutex for the
continuation created in <code class="docutils literal notranslate"><span class="pre">txn_handler</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span> <span class="k">static</span> <span class="kt">void</span>
 <span class="nf">txn_handler</span> <span class="p">(</span><span class="n">TSHttpTxn</span> <span class="n">txnp</span><span class="p">,</span> <span class="n">TSCont</span> <span class="n">contp</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">TSCont</span> <span class="n">newCont</span><span class="p">;</span>
     <span class="p">....</span>
         <span class="n">newCont</span> <span class="o">=</span> <span class="n">TSContCreate</span> <span class="p">(</span><span class="n">newCont_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
     <span class="c1">// It&#39;s not necessary to create a new mutex for newCont.</span>

     <span class="p">...</span>

         <span class="n">TSHttpTxnReenable</span> <span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">TS_EVENT_HTTP_CONTINUE</span><span class="p">);</span>
 <span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">test_plugin</span> <span class="p">(</span><span class="n">TSCont</span> <span class="n">contp</span><span class="p">,</span> <span class="n">TSEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">edata</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">TSHttpTxn</span> <span class="n">txnp</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHttpTxn</span><span class="p">)</span> <span class="n">edata</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_READ_REQUEST_HDR</span><span class="p">:</span>
            <span class="n">txn_handler</span> <span class="p">(</span><span class="n">txnp</span><span class="p">,</span> <span class="n">contp</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The mutex functions are listed below:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api/functions/TSMutexCreate.en.html#c.TSMutexCreate" title="TSMutexCreate"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexCreate()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/functions/TSMutexLock.en.html#c.TSMutexLock" title="TSMutexLock"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexLock()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/functions/TSMutexLockTry.en.html#c.TSMutexLockTry" title="TSMutexLockTry"><code class="xref c c-func docutils literal notranslate"><span class="pre">TSMutexLockTry()</span></code></a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="io/index.en.html" class="btn btn-neutral float-right" title="IO" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="continuations/writing-handler-functions.en.html" class="btn btn-neutral float-left" title="Writing Handler Functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, dev@trafficserver.apache.org.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>
 


</body>
</html>