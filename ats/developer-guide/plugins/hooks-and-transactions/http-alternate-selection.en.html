

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>HTTP Alternate Selection &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/override.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="TLS User Agent Hooks" href="ssl-hooks.en.html" />
    <link rel="prev" title="Initiate HTTP Connection" href="initiate-http-connection.en.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="http-alternate-selection">
<span id="developer-plugins-hooks-alternate-selection"></span><h1>HTTP Alternate Selection<a class="headerlink" href="#http-alternate-selection" title="Permalink to this headline">¶</a></h1>
<p>The HTTP alternate selection functions provide a mechanism for hooking
into Traffic Server’s alternate selection mechanism and augmenting it
with additional information. <strong>HTTP alternate selection</strong> refers to the
process of choosing between several alternate versions of a document for
a specific URL. Alternates arise because the HTTP 1.1 specification
allows different documents to be sent back for the same URL (depending
on the clients request). For example, a server might send back a GIF
image to a client that only accepts GIF images, and might send back a
JPEG image to a client that only accepts JPEG images.</p>
<p>The alternate selection mechanism is invoked when Traffic Server looks
up a URL in its cache. For each URL, Traffic Server stores a vector of
alternates. For each alternate in this vector, Traffic Server computes a
quality value between 0 and 1 that represents how “good” the alternate
is. A quality value of 0 means that the alternate is unacceptable; a
value of 1 means that the alternate is a perfect match.</p>
<p>If a plugin hooks onto the <code class="docutils literal notranslate"><span class="pre">TS_HTTP_SELECT_ALT_HOOK</span></code>, then it will be
called back when Traffic Server performs alternate selection. You cannot
register locally to the hook <code class="docutils literal notranslate"><span class="pre">TS_HTTP_SELECT_ALT_HOOK</span></code> by using
<code class="docutils literal notranslate"><span class="pre">TSHttpTxnHookAdd</span></code> - you can only do so by using only
<code class="docutils literal notranslate"><span class="pre">TSHttpHookAdd</span></code>. Since Traffic Server does not actually have an HTTP
transaction or an HTTP session on hand when alternate selection is
performed, it is only valid to hook onto the global list of
<code class="docutils literal notranslate"><span class="pre">TS_HTTP_SELECT_ALT_HOOK</span></code>. Traffic Server calls each of the select
alternate hooks with the <code class="docutils literal notranslate"><span class="pre">TS_EVENT_HTTP_SELECT_ALT</span></code> event. The
<code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*edata</span></code> argument that is passed to the continuation is a pointer
to an <code class="docutils literal notranslate"><span class="pre">TSHttpAltInfo</span></code> structure. It can be used later to call the HTTP
alternate selection functions listed at the end of this section. Unlike
other hooks, this alternate selection callout is non-blocking; the
expectation is that the quality value for the alternate will be changed
by a call to <code class="docutils literal notranslate"><span class="pre">TSHttpAltInfoQualitySet</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">HTTP SM does not have to be reenabled using <code class="docutils literal notranslate"><span class="pre">TSHttpTxnReenable</span></code> or any
other APIs; just return from the function.</p>
</div>
<p>The sample code below shows how to call the alternate APIs.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_select_alt</span><span class="p">(</span><span class="n">TSHttpAltInfo</span> <span class="n">infop</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">TSMBuffer</span> <span class="n">client_req_buf</span><span class="p">,</span> <span class="n">cache_resp_buf</span><span class="p">;</span>
   <span class="n">TSMLoc</span> <span class="n">client_req_hdr</span><span class="p">,</span> <span class="n">cache_resp_hdr</span><span class="p">;</span>

   <span class="n">TSMLoc</span> <span class="n">accept_transform_field</span><span class="p">;</span>
   <span class="n">TSMLoc</span> <span class="n">content_transform_field</span><span class="p">;</span>

   <span class="kt">int</span> <span class="n">accept_transform_len</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">content_transform_len</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">accept_transform_value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">content_transform_value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">content_plugin</span><span class="p">,</span> <span class="n">accept_plugin</span><span class="p">;</span>

   <span class="kt">float</span> <span class="n">quality</span><span class="p">;</span>

   <span class="cm">/* get client request, cached request and cached response */</span>
   <span class="n">TSHttpAltInfoClientReqGet</span> <span class="p">(</span><span class="n">infop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_req_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_req_hdr</span><span class="p">);</span>
   <span class="n">TSHttpAltInfoCachedRespGet</span><span class="p">(</span><span class="n">infop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache_resp_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache_resp_hdr</span><span class="p">);</span>

   <span class="cm">/* get the Accept-Transform field value from the client request */</span>
   <span class="n">accept_transform_field</span> <span class="o">=</span> <span class="n">TSMimeHdrFieldFind</span><span class="p">(</span><span class="n">client_req_buf</span><span class="p">,</span>
      <span class="n">client_req_hdr</span><span class="p">,</span> <span class="s">&quot;Accept-Transform&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">accept_transform_field</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">TSMimeHdrFieldValueStringGet</span><span class="p">(</span><span class="n">client_req_buf</span><span class="p">,</span> <span class="n">client_req_hdr</span><span class="p">,</span>
         <span class="n">accept_transform_field</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accept_transform_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">accept_transform_len</span><span class="p">);</span>
      <span class="n">TSDebug</span><span class="p">(</span><span class="n">DBG_TAG</span><span class="p">,</span> <span class="s">&quot;Accept-Transform = |%s|&quot;</span><span class="p">,</span>
         <span class="n">accept_transform_value</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="cm">/* get the Content-Transform field value from cached server response */</span>
   <span class="n">content_transform_field</span> <span class="o">=</span> <span class="n">TSMimeHdrFieldFind</span><span class="p">(</span><span class="n">cache_resp_buf</span><span class="p">,</span>
      <span class="n">cache_resp_hdr</span><span class="p">,</span> <span class="s">&quot;Content-Transform&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">content_transform_field</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">TSMimeHdrFieldValueStringGet</span><span class="p">(</span><span class="n">cache_resp_buf</span><span class="p">,</span> <span class="n">cache_resp_hdr</span><span class="p">,</span>
         <span class="n">content_transform_field</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">content_transform_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">content_transform_len</span><span class="p">);</span>
      <span class="n">TSDebug</span><span class="p">(</span><span class="n">DBG_TAG</span><span class="p">,</span> <span class="s">&quot;Content-Transform = |%s|&quot;</span><span class="p">,</span>
         <span class="n">content_transform_value</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="cm">/* compute quality */</span>
   <span class="n">accept_plugin</span> <span class="o">=</span> <span class="p">(</span><span class="n">accept_transform_value</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">accept_transform_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">accept_transform_value</span><span class="p">,</span> <span class="s">&quot;plugin&quot;</span><span class="p">,</span>
         <span class="n">accept_transform_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>

   <span class="n">content_plugin</span> <span class="o">=</span> <span class="p">(</span><span class="n">content_transform_value</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">content_transform_len</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">content_transform_value</span><span class="p">,</span> <span class="s">&quot;plugin&quot;</span><span class="p">,</span>
         <span class="n">content_transform_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">accept_plugin</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">quality</span> <span class="o">=</span> <span class="n">content_plugin</span> <span class="o">?</span> <span class="mf">1.0</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">quality</span> <span class="o">=</span> <span class="n">content_plugin</span> <span class="o">?</span> <span class="mf">0.0</span> <span class="o">:</span> <span class="mf">0.5</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">TSDebug</span><span class="p">(</span><span class="n">DBG_TAG</span><span class="p">,</span> <span class="s">&quot;Setting quality to %3.1f&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>

   <span class="cm">/* set quality for this alternate */</span>
   <span class="n">TSHttpAltInfoQualitySet</span><span class="p">(</span><span class="n">infop</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>

   <span class="cm">/* cleanup */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">accept_transform_field</span><span class="p">)</span>
      <span class="n">TSHandleMLocRelease</span><span class="p">(</span><span class="n">client_req_buf</span><span class="p">,</span> <span class="n">client_req_hdr</span><span class="p">,</span>
         <span class="n">accept_transform_field</span><span class="p">);</span>
   <span class="n">TSHandleMLocRelease</span><span class="p">(</span><span class="n">client_req_buf</span><span class="p">,</span> <span class="n">TS_NULL_MLOC</span><span class="p">,</span> <span class="n">client_req_hdr</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">content_transform_field</span><span class="p">)</span>
      <span class="n">TSHandleMLocRelease</span><span class="p">(</span><span class="n">cache_resp_buf</span><span class="p">,</span> <span class="n">cache_resp_hdr</span><span class="p">,</span>
         <span class="n">content_transform_field</span><span class="p">);</span>
   <span class="n">TSHandleMLocRelease</span><span class="p">(</span><span class="n">cache_resp_buf</span><span class="p">,</span> <span class="n">TS_NULL_MLOC</span><span class="p">,</span> <span class="n">cache_resp_hdr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alt_plugin</span><span class="p">(</span><span class="n">TSCont</span> <span class="n">contp</span><span class="p">,</span> <span class="n">TSEvent</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">edata</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">TSHttpAltInfo</span> <span class="n">infop</span><span class="p">;</span>

   <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nl">TS_EVENT_HTTP_SELECT_ALT</span><span class="p">:</span>
         <span class="n">infop</span> <span class="o">=</span> <span class="p">(</span><span class="n">TSHttpAltInfo</span><span class="p">)</span><span class="n">edata</span><span class="p">;</span>
         <span class="n">handle_select_alt</span><span class="p">(</span><span class="n">infop</span><span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
         <span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">TSPluginInit</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
   <span class="n">TSHttpHookAdd</span><span class="p">(</span><span class="n">TS_HTTP_SELECT_ALT_HOOK</span><span class="p">,</span> <span class="n">TSContCreate</span> <span class="p">(</span><span class="n">alt_plugin</span><span class="p">,</span>
      <span class="nb">NULL</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Traffic Server augments the alternate selection through these callouts
using the following algorithm:</p>
<ol class="arabic simple">
<li>Traffic Server computes its own quality value for the alternate,
taking into account the quality of the accept match, the encoding
match, and the language match.</li>
<li>Traffic Server then calls out each of the continuations on the global
<code class="docutils literal notranslate"><span class="pre">TS_HTTP_SELECT_ALT_HOOK</span></code>’s list.</li>
<li>It multiplies its quality value with the value returned by each
callout. Since all of the values are clamped to be between 0 and 1,
the final value will be between 0 and 1 as well.</li>
<li>This algorithm also ensures that a single callout can block the usage
of a given alternate by specifying a quality value of 0.</li>
</ol>
<p>A common usage for the alternate selection mechanism is when a plugin
transforms a document for some clients and not for others, but wants to
store both the transformed and unchanged document. The client’s request
will specify whether it accepted the transformed document. The plugin
will then determine if the alternate matches this specification and then
set the appropriate quality level for the alternate.</p>
<p>The HTTP alternate selection functions are:</p>
<ul class="simple">
<li><a class="reference external" href="http://people.apache.org/~amc/ats/doc/html/ts_8h.html#af4f3a56716e3e97afd582c7fdb14bcb7">TSHttpAltInfoCachedReqGet</a></li>
<li><a class="reference external" href="http://people.apache.org/~amc/ats/doc/html/ts_8h.html#aff5861ae4a4a7a6ce7b2d669c113b3bb">TSHttpAltInfoCachedRespGet</a></li>
<li><a class="reference external" href="http://people.apache.org/~amc/ats/doc/html/ts_8h.html#a74d494c6442b6012d8385e92f0e14dee">TSHttpAltInfoClientReqGet</a></li>
<li><a class="reference external" href="http://people.apache.org/~amc/ats/doc/html/ts_8h.html#a978b7160a048491d5698e0f4c0c79aad">TSHttpAltInfoQualitySet</a></li>
</ul>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.en.html">Administrator’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.en.html">Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../release-process/index.en.html">Release Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contributing/index.en.html">Contributing to Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing-with-vagrant/index.en.html">Using Vagrant to Test Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../debugging/index.en.html">Debugging and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../threads-and-events.en.html">Threads and Event Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cache-architecture/index.en.html">Cache Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logging-architecture/index.en.html">Logging Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internal-libraries/index.en.html">Internal libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.en.html">Plugin Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../config-vars.en.html">Configuration Variable Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.en.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../continuous-integration/index.en.html">Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../documentation/index.en.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../host-resolution-proposal.en.html">Host Resolution Proposal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../client-session-architecture.en.html">An Overview Client Sessions and Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../core-architecture/index.en.html">Core Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../design-documents/index.en.html">Design Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../layout/index.en.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing/index.en.html">Testing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jsonrpc/index.en.html">JSONRPC</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.en.html">Developer’s Guide</a><ul>
  <li><a href="../index.en.html">Plugin Development</a><ul>
  <li><a href="index.en.html">Hooks and Transactions</a><ul>
      <li>Previous: <a href="initiate-http-connection.en.html" title="previous chapter">Initiate HTTP Connection</a></li>
      <li>Next: <a href="ssl-hooks.en.html" title="next chapter">TLS User Agent Hooks</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/developer-guide/plugins/hooks-and-transactions/http-alternate-selection.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>