

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cookie Based Routing Inside TrafficServer Using cookie_remap &#8212; Apache Traffic Server 10.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/override.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="ESI Plugin" href="esi.en.html" />
    <link rel="prev" title="Configuration Remap Plugin" href="conf_remap.en.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="cookie-based-routing-inside-trafficserver-using-cookie-remap">
<span id="admin-plugins-cookie-remap"></span><h1>Cookie Based Routing Inside TrafficServer Using cookie_remap<a class="headerlink" href="#cookie-based-routing-inside-trafficserver-using-cookie-remap" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference external" href="#cookie-based-routing-inside-trafficserver-using-cookie_remap">Cookie Based Routing Inside TrafficServer Using cookie_remap</a><ul>
<li><a class="reference external" href="#features">Features</a></li>
<li><a class="reference external" href="#limitations">Limitations</a></li>
<li><a class="reference external" href="#setup">Setup</a></li>
<li><a class="reference external" href="#operations">Operations</a><ul>
<li><a class="reference external" href="#comments">Comments</a></li>
<li><a class="reference external" href="#cookie-xxy">cookie: X|X.Y</a></li>
<li><a class="reference external" href="#operation-existsnot-existsstringregexbucket">operation: exists|not exists|string|regex|bucket</a></li>
<li><a class="reference external" href="#match-str">match: str</a></li>
<li><a class="reference external" href="#regex-str">regex: str</a></li>
<li><a class="reference external" href="#buckethash-xy">bucket|hash: X/Y</a></li>
<li><a class="reference external" href="#sendtourl-url">sendto|url: url</a></li>
<li><a class="reference external" href="#status-http-status-code">status: HTTP status-code</a></li>
<li><a class="reference external" href="#else-url-optional">else: url [optional]</a></li>
<li><a class="reference external" href="#connector-and">connector: and</a></li>
</ul>
</li>
<li><a class="reference external" href="#reserved-path-expressions">Reserved path expressions</a><ul>
<li><a class="reference external" href="#cr_req_url-v-15">$cr_req_url</a></li>
<li><a class="reference external" href="#cr_urlencode-v-15">$cr_urlencode()</a></li>
<li><a class="reference external" href="#path">$path</a></li>
<li><a class="reference external" href="#unmatched_path">$unmatched_path</a></li>
</ul>
</li>
<li><a class="reference external" href="#an-example-configuration-file">An example configuration file</a></li>
<li><a class="reference external" href="#debugging-things">Debugging things</a><ul>
<li><a class="reference external" href="#initial-output">Initial output</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This remap plugin makes decisions about where to send your request based on properties present (or absent) within the HTTP Cookie header.  It can also make decisions based on your uri (url path + query.)</p>
<div class="section" id="id2">
<h2>Features<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<ul class="simple">
<li>Also supports sub-level cookies<ul>
<li>K indicates top-level cookie “K”</li>
<li>K.l indicates top-level cookie “K”, subfield “l”</li>
</ul>
</li>
<li>Cookie exists / Cookie doesn’t exist</li>
<li>Cookie or uri matches string</li>
<li>Cookie or uri matches regex (with match replacement in the sendto like <a class="reference external" href="http://foo.com/$1/$2">http://foo.com/$1/$2</a>)</li>
<li>Cookie falls into a hash/bucket range</li>
<li>Can url encode dynamic data</li>
</ul>
</div>
<div class="section" id="id3">
<h2>Limitations<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<ul class="simple">
<li>Does not support <a class="reference internal" href="../files/remap.config.en.html#remap-config-plugin-chaining"><span class="std std-ref">Plugin Chaining</span></a></li>
</ul>
</div>
<div class="section" id="id4">
<h2>Setup<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<p>The plugin is specified in remap.config using a syntax similar to:</p>
<pre>
map http://foo.com http://bar.com @plugin=/usr/bin/trafficserver/libexec64/cookie_remap.so @pparam=/home/trafficserver/conf/cookie_remap/cookie_remap.txt
</pre></div>
<div class="section" id="id5">
<h2>Operations<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<p>All operations are specified in a YAML configuration file you pass as &#64;pparam on the plugin configuration line. YAML is very simple syntax. See the example configuration files below.</p>
<p>Each operation results in a sendto action. That means that, if matched, cookie_remap forwards the request to the given <code class="docutils literal notranslate"><span class="pre">sendto</span></code> url. It can be proxied or redirected. An <code class="docutils literal notranslate"><span class="pre">else</span></code> sendto can be specified, in which case a failure to match will forward the request also. Once a sendto is invoked:</p>
<ul class="simple">
<li>cookie_remap will not process any more “operations” from the configuration</li>
<li>the default destination specified in the remap.config file will not be used; it will be replaced by the <code class="docutils literal notranslate"><span class="pre">sendto</span></code></li>
</ul>
<p>Each <code class="docutils literal notranslate"><span class="pre">operation</span></code> can have multiple “sub-operations”, connected with an conjunction operator.  Currently, only the <code class="docutils literal notranslate"><span class="pre">and</span></code> operator is supported. So, you can say, “if cookie exists, <code class="docutils literal notranslate"><span class="pre">and</span></code> uri is <code class="docutils literal notranslate"><span class="pre">x</span></code>, then redirect.”</p>
<div class="section" id="id6">
<h3>Comments<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>Comments are allowed in the configuration file if they begin with ‘#’</p>
</div>
<div class="section" id="id7">
<h3>cookie: X|X.Y<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>This sub-operation is testing against the X cookie or X.Y cookie where X.Y denotes the X cookie, sub cookie Y
e.g</p>
<pre>
A=ACOOKIE;B=data&f=fsub&z=zsub;
A will operate on ACOOKIE
B will operate on data&f=fsub&z=zsub
B.f will operate on fsub
</pre></div>
<div class="section" id="id8">
<h3>operation: exists|not exists|string|regex|bucket<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>This keyword actually denotes a “suboperation” - it can be specified multiple times, connected with <code class="docutils literal notranslate"><span class="pre">and</span></code>, and send the user to a given destination.</p>
<ul class="simple">
<li>exists: Test for the existence of a cookie</li>
<li>not exists: Test for the non-existence of a cookie</li>
<li>string: string match</li>
<li>regex: regex matching with $1 - $9 replaced in <code class="docutils literal notranslate"><span class="pre">sendto</span></code></li>
<li>bucket: Hash the cookie and check if it falls in a bucket</li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">cookie</span></code> operator must be specified in the YAML file just before the suboperation that will apply to the cookie.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">string</span></code>, <code class="docutils literal notranslate"><span class="pre">regex</span></code> and <code class="docutils literal notranslate"><span class="pre">bucket</span></code> operate on the specified cookie, or if no cookie is specified, they will operate on the uri of the request.</p>
</div>
<div class="section" id="id9">
<h3>match: str<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>Match the cookie data to str.  If no cookie is specified, match to the request uri.</p>
</div>
<div class="section" id="id10">
<h3>regex: str<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>Sets the regex to str. Matching is enabled with $1-$9 (replaced in sendto).  Note that only the final regex match in an operation will be used to populate the substitutions $1-$9.  If no cookie is specified, match to the request uri.</p>
</div>
<div class="section" id="id11">
<h3>bucket|hash: X/Y<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>Hashes (bucketizes) the data in Y buckets. If you fall into the first X of them, this suboperation passes. If no cookie is specified, match to the request uri.</p>
<pre>
bucket: 1/100
will effectively bucketize 1% of your users
</pre></div>
<div class="section" id="id12">
<h3>sendto|url: url<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>if the sub-operation(s) all match, send to url</p>
</div>
<div class="section" id="id13">
<h3>status: HTTP status-code<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>if the sub-operation(s) all match, set the status code (e.g. set it to 302). In the case of a redirect, the sendto URL becomes the redirect URL.</p>
</div>
<div class="section" id="id14">
<h3>else: url [optional]<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>If one of the sub-operations fails, send to url. This is optional. If there is no ‘else’, we will continue to process operations until either one succeeds, there is an else in one of the operations or we fall through to the default mapping from remap.config</p>
</div>
<div class="section" id="id15">
<h3>connector: and<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>‘and’ is the only supported connector</p>
</div>
</div>
<div class="section" id="id16">
<h2>Reserved path expressions<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<p>The following expressions can be used in either the sendto <strong>or</strong> <code class="docutils literal notranslate"><span class="pre">else</span></code> URLs, and will be expanded.</p>
<div class="section" id="id17">
<h3>$cr_req_url<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>Replaced with the full original url.</p>
<p>Therefore, a rule like:</p>
<pre>
op:
  cookie: K
  operation: exists
  sendto: http://foo.com/?.done=$cr_req_url
</pre><p>and a request that matches, e.g.</p>
<pre>
http://bar.com/hello?fruit=bananas
</pre><p>will become</p>
<pre>
http://foo.com/?.done=http://bar.com/hello?fruit=bananas
</pre></div>
<div class="section" id="id18">
<h3>$cr_urlencode()<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>Replaced with a urlencoded version of its argument.  The url argument is aggressively encoded such that all non-alphanumeric characters are converted to % hex notation.  The simple algorithm could probably be refined in the future to be less aggressive (encode fewer characters.)</p>
<p>Therefore, a rule like:</p>
<pre>
op:
  cookie: B
  operation: exists
  sendto: http://foo.com/?.done=$cr_urlencode($cr_req_url)
</pre><p>and a request that matches, e.g.</p>
<pre>
http://bar.com/hello?fruit=bananas
</pre><p>will become</p>
<pre>
http://foo.com/?.done=http%3A%2F%2Fbar%2Ecom@2Fhello%3Ffruit%3Dbananas
</pre></div>
<div class="section" id="id19">
<h3>$path<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>$path can be used to replace in either the sendto <strong>or</strong> else URLs the original request path. Therefore a rule like:</p>
<pre>
op:
  cookie: K
  operation: exists
  sendto: http://foo.com/$path/x/y/z
</pre><p>and a request like <a class="reference external" href="http://foo.com/photos/what/ever/">http://finance.yahoo.com/photos/what/ever/</a> that matches the rule</p>
<pre>
map http://finance.yahoo.com/photos/ http://newfinance.yahoo.com/1k.html @plugin=cookie_remap.so @pparam=foo.txt
</pre><p>will become <a class="reference external" href="http://foo.com/photos/what/ever/x/y/z">http://foo.com/photos/what/ever/x/y/z</a></p>
</div>
<div class="section" id="id20">
<h3>$unmatched_path<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>$unmatched_path can be used to gather the URL arguments <strong>beyond</strong> what was matched by the remap rule. Therefore a rule like:</p>
<pre>
op:
  cookie: K
  operation: exists
  sendto: http://foo.com/$unmatched_path/x/y/z
</pre><p>and a request like <a class="reference external" href="http://foo.com/photos/what/ever/">http://finance.yahoo.com/photos/what/ever/</a> that matches the rule</p>
<pre>
map http://finance.yahoo.com/photos/ http://newfinance.yahoo.com/1k.html @plugin=cookie_remap.so @pparam=foo.txt
</pre><p>will become <a class="reference external" href="http://foo.com/what/ever/matches/x/y/z">http://foo.com/what/ever/matches/x/y/z</a></p>
</div>
</div>
<div class="section" id="id22">
<h2>An example configuration file<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<ul class="simple">
<li>first match “wins” (top down)</li>
</ul>
<pre>
#comments
#are allowed
op:
  cookie: K
  operation: exists
  url: http://www.yahoo.com

op:
  cookie: K
  operation: exists
  connector: and
  cookie: K.l
  operation: not exists
  sendto: http://www.yahoo.com

op:
  cookie: Y
  operation: bucket
  bucket: 1/1000
  connector: and
  cookie: Y.l
  operation: regex
  regex: (.*)
  connector: and
  cookie: Y.n
  operation: string
  match: foobar
  sendto: http://cnn.com/$1
  else: http://yahoo.com
</pre></div>
<div class="section" id="id23">
<h2>Debugging things<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h2>
<hr class="docutils" />
<p>The easiest way to debug problems with this plugin is to run in the following manner:</p>
<pre>
bin/traffic_server -T cookie_remap
</pre><p>which will produce output on startup, and for each request. Be aware that this mode of running trafficserver is <strong>extremely</strong> inefficient and should only be used for debugging.</p>
<div class="section" id="id24">
<h3>Initial output<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h3>
<hr class="docutils" />
<p>Initially, you will notice output describing each operation and how trafficserver interpreted the information from your configuration file:</p>
<pre>
[Jul  8 13:08:34.183] Server {3187168} DIAG: (cookie_remap) loading cookie remap configuration file from /homes/ebalsa/dev/yts_mods/cookie_remap/example_config.txt
[Jul  8 13:08:34.199] Server {3187168} DIAG: (cookie_remap) ++++operation++++
[Jul  8 13:08:34.199] Server {3187168} DIAG: (cookie_remap) sending to: http://finance.yahoo.com/2k.html
[Jul  8 13:08:34.199] Server {3187168} DIAG: (cookie_remap) if these operations match:
[Jul  8 13:08:34.200] Server {3187168} DIAG: (cookie_remap)     +++subop+++
[Jul  8 13:08:34.200] Server {3187168} DIAG: (cookie_remap)         cookie: B
[Jul  8 13:08:34.200] Server {3187168} DIAG: (cookie_remap)         operation: bucket
[Jul  8 13:08:34.200] Server {3187168} DIAG: (cookie_remap)         bucket: 1/100
[Jul  8 13:08:34.200] Server {3187168} DIAG: (cookie_remap)         taking: 1
[Jul  8 13:08:34.200] Server {3187168} DIAG: (cookie_remap)         out of: 100
[Jul  8 13:08:34.200] Server {3187168} DIAG: (cookie_remap)     +++subop+++
[Jul  8 13:08:34.201] Server {3187168} DIAG: (cookie_remap)         cookie: Y.l
[Jul  8 13:08:34.201] Server {3187168} DIAG: (cookie_remap)         operation: exists
[Jul  8 13:08:34.201] Server {3187168} DIAG: (cookie_remap) ++++operation++++
[Jul  8 13:08:34.201] Server {3187168} DIAG: (cookie_remap) sending to: http://X.existed.com
[Jul  8 13:08:34.201] Server {3187168} DIAG: (cookie_remap) if these operations match:
[Jul  8 13:08:34.201] Server {3187168} DIAG: (cookie_remap)     +++subop+++
[Jul  8 13:08:34.201] Server {3187168} DIAG: (cookie_remap)         cookie: PH.l
[Jul  8 13:08:34.202] Server {3187168} DIAG: (cookie_remap)         operation: exists
[Jul  8 13:08:34.202] Server {3187168} DIAG: (cookie_remap) # of ops: 2
</pre><p>each operation is enumerated and is more-or-less human readable from the top-down.  From now on, each request has information spit out to the console with debugging information on how the cookie_remap is treating this request.</p>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/trans_logo_tm_380x69.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../../index.html">Apache Traffic Server</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../preface/index.en.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.en.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/index.en.html">Release Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.en.html">Administrator’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../introduction.en.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation/index.en.html">Installing Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuration/index.en.html">Proxy Cache Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interaction/index.en.html">Interacting with Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.en.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/index.en.html">Cache Storage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.en.html">Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.en.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../monitoring/index.en.html">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../configuring-traffic-server.en.html">Configuring Traffic Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../layer-4-routing.en.html">Layer 4 Routing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../performance/index.en.html">Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files/index.en.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jsonrpc/index.en.html">JSONRPC API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.en.html#audience">Audience</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer-guide/index.en.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendices/index.en.html">Appendices</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.en.html">Administrator’s Guide</a><ul>
  <li><a href="index.en.html">Plugins</a><ul>
      <li>Previous: <a href="conf_remap.en.html" title="previous chapter">Configuration Remap Plugin</a></li>
      <li>Next: <a href="esi.en.html" title="next chapter">ESI Plugin</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Apache Traffic Server</span>
    v: 10.0
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl id="lang-list">
      <dt>Languages</dt>
    </dl>
    <dl id="version-list">
      <dt>Versions</dt>
    </dl>
  </div>
</div>
<script>
$(function() {
  function update_langlist (json) {
    for (var lang in json) {
      $('#lang-list').append('<dd><a href="/' + lang + '/latest/">' + json[lang]['name'] + '</a></dd>');
    }
    for (var i in json[curlang]['versions']) {
      var ver = json[curlang]['versions'][i];
      $('#version-list').append('<dd><a href="/' + curlang + '/' + ver + '/">' + ver + '</a></dd>');
    }
  }
  var curlang = "None" == "None" ? "en" : "None";
  $.ajax({
    'url':      "/en/latest/_static/languages.json",
    'dataType': "json",
    'success':  function (json) { update_langlist(json) },
    'error':    function (xhr,errstr,e) {
      $.ajax({
        'url':      "/_static/languages.json",
        'dataType': "json",
        'success':  function (json) { update_langlist(json) }
      })
    }
  });
});
</script>

    <div class="footer">
      &copy;2021, dev@trafficserver.apache.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/admin-guide/plugins/cookie_remap.en.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    

  </body>
</html>